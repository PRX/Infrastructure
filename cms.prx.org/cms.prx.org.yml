AWSTemplateFormatVersion: "2010-09-09"
Description: cms.prx.org web application and worker running in Docker
Mappings:
  ContainerNameMap:
    CmsWebApp:
      name: cms-web
    CmsWorker:
      name: cms-worker
Parameters:
  VPC:
    Type: String
  VPCSubnet1:
    Type: String
  VPCSubnet2:
    Type: String
  VPCCertificateArn:
    Type: String
  RootStackName:
    Type: String
  ECSCluster:
    Type: String
  ECSServiceAutoscaleIAMRoleArn:
    Type: String
  ECSServiceIAMRole:
    Type: String
  EnvironmentTypeAbbreviation:
    Type: String
  CmsECRRegion:
    Type: String
  CmsECRRepositoryName:
    Type: String
  CmsECRImageTag:
    Type: String
  OpsDebugMessagesSNSTopicArn:
    Type: String
  CmsEnvAwsAccessKeyId:
    Type: String
  CmsEnvAwsAccountId:
    Type: String
  CmsEnvAwsBucket:
    Type: String
  CmsEnvAwsRegion:
    Type: String
  CmsEnvAwsSecretAccessKey:
    Type: String
  CmsEnvCmsHost:
    Type: String
  CmsEnvDatabasePoolSize:
    Type: Number
  CmsEnvDbEnvMysqlDatabase:
    Type: String
  CmsEnvDbEnvMysqlPassword:
    Type: String
  CmsEnvDbEnvMysqlUser:
    Type: String
  CmsEnvDbPort3306TcpAddr:
    Type: String
  CmsEnvDbPort3306TcpPort:
    Type: Number
  CmsEnvFeederHost:
    Type: String
  CmsEnvIdHost:
    Type: String
  CmsEnvMemcacheServers:
    Type: String
  CmsEnvMetaHost:
    Type: String
  CmsEnvMysqlAllowEmptyPassword:
    Type: String
  CmsEnvNewRelicKey:
    Type: String
  CmsEnvNewRelicName:
    Type: String
  CmsEnvPrxHost:
    Type: String
  CmsEnvPrxSecret:
    Type: String
  CmsEnvPublicAssetSecret:
    Type: String
  CmsEnvRailsEnv:
    Type: String
  CmsEnvRailsSecretKey:
    Type: String
Resources:
  CmsLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      RetentionInDays: 14
  CmsSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Allow web and SSH traffic to the ALB
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
      Tags:
        - Key: Name
          Value: !Sub ${RootStackName} CMS ALB
  CmsALBTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    DependsOn: CmsALB
    Properties:
      HealthCheckIntervalSeconds: 60
      UnhealthyThresholdCount: 10
      HealthCheckPath: /api/v1
      Name: !Sub cms-${EnvironmentTypeAbbreviation}-${VPC}
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
  CmsALB:
    Type: "AWS::ElasticLoadBalancingV2::LoadBalancer"
    Properties:
      Scheme: internet-facing
      SecurityGroups:
        - !Ref CmsSecurityGroup
      Subnets:
        - !Ref VPCSubnet1
        - !Ref VPCSubnet2
      Tags:
        - Name: Project
          Value: cms.prx.org
  CmsALBHTTPListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      LoadBalancerArn: !Ref CmsALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref CmsALBTargetGroup
  CmsALBHTTPSListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      Certificates:
        - CertificateArn: !Ref VPCCertificateArn
      LoadBalancerArn: !Ref CmsALB
      Port: 443
      Protocol: HTTPS
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref CmsALBTargetGroup
  CmsWebTaskDefinition:
    Type: "AWS::ECS::TaskDefinition"
    Properties:
      ContainerDefinitions:
        - Cpu: 1
          Environment:
            - Name: AWS_ACCESS_KEY_ID
              Value: !Ref CmsEnvAwsAccessKeyId
            - Name: AWS_ACCOUNT_ID
              Value: !Ref CmsEnvAwsAccountId
            - Name: AWS_BUCKET
              Value: !Ref CmsEnvAwsBucket
            - Name: AWS_REGION
              Value: !Ref CmsEnvAwsRegion
            - Name: AWS_SECRET_ACCESS_KEY
              Value: !Ref CmsEnvAwsSecretAccessKey
            - Name: CMS_HOST
              Value: !Ref CmsEnvCmsHost
            - Name: DATABASE_POOL_SIZE
              Value: !Ref CmsEnvDatabasePoolSize
            - Name: DB_ENV_MYSQL_DATABASE
              Value: !Ref CmsEnvDbEnvMysqlDatabase
            - Name: DB_ENV_MYSQL_PASSWORD
              Value: !Ref CmsEnvDbEnvMysqlPassword
            - Name: DB_ENV_MYSQL_USER
              Value: !Ref CmsEnvDbEnvMysqlUser
            - Name: DB_PORT_3306_TCP_ADDR
              Value: !Ref CmsEnvDbPort3306TcpAddr
            - Name: DB_PORT_3306_TCP_PORT
              Value: !Ref CmsEnvDbPort3306TcpPort
            - Name: FEEDER_HOST
              Value: !Ref CmsEnvFeederHost
            - Name: ID_HOST
              Value: !Ref CmsEnvIdHost
            - Name: MEMCACHE_SERVERS
              Value: !Ref CmsEnvMemcacheServers
            - Name: META_HOST
              Value: !Ref CmsEnvMetaHost
            - Name: MYSQL_ALLOW_EMPTY_PASSWORD
              Value: !Ref CmsEnvMysqlAllowEmptyPassword
            - Name: NEW_RELIC_KEY
              Value: !Ref CmsEnvNewRelicKey
            - Name: NEW_RELIC_NAME
              Value: !Ref CmsEnvNewRelicName
            - Name: PRX_HOST
              Value: !Ref CmsEnvPrxHost
            - Name: PUBLIC_ASSET_SECRET
              Value: !Ref CmsEnvPublicAssetSecret
            - Name: RAILS_ENV
              Value: !Ref CmsEnvRailsEnv
            - Name: RAILS_SECRET_KEY
              Value: !Ref CmsEnvRailsSecretKey
          Essential: true
          # TODO
          # Image: !Sub ${AWS::AccountId}.dkr.ecr.${AudiogramECRRegion}.amazonaws.com/${AudiogramECRRepositoryName}:${AudiogramECRImageTag}
          Image: 561178107736.dkr.ecr.us-east-1.amazonaws.com/cms.prx.org:master.87
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref CmsLogGroup
              awslogs-region: !Ref AWS::Region
          Memory: 500
          Name: !FindInMap [ContainerNameMap, CmsWebApp, name]
          PortMappings:
            - HostPort: 0
              ContainerPort: 3000
  CmsWebService:
    Type: "AWS::ECS::Service"
    DependsOn:
      - CmsALBHTTPListener
      - CmsALBHTTPSListener
    Properties:
      Cluster: !Ref ECSCluster
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      DesiredCount: 1
      LoadBalancers:
        - ContainerName: !FindInMap [ContainerNameMap, CmsWebApp, name]
          ContainerPort: 3000
          TargetGroupArn: !Ref CmsALBTargetGroup
      Role: !Ref ECSServiceIAMRole
      TaskDefinition: !Ref CmsWebTaskDefinition
  CmsWebRecordSetGroup:
    Type: "AWS::Route53::RecordSetGroup"
    DependsOn: CmsALB
    Properties:
      Comment: Record sets for dualstack web traffic to a cms web instance
      HostedZoneName: prx.tech.
      RecordSets:
        - Type: A
          Name: !Sub ${EnvironmentTypeAbbreviation}-cms.${VPC}.prx.tech.
          AliasTarget:
            DNSName: !GetAtt CmsALB.DNSName
            HostedZoneId: !GetAtt CmsALB.CanonicalHostedZoneID
Outputs:
  DNSName:
    Description: The DNS name for the applications load balancer
    Value: !GetAtt CmsALB.DNSName
  HostedZoneDNSName:
    Description: Convenience domain name for the ALB in a hosted zone
    Value: !Sub |
      ${EnvironmentTypeAbbreviation}-cms.${VPC}.prx.tech.
