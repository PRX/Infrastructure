# etc/cloudwatch-data-sharing-role.yml
AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  Creates the specially named CloudWatch-CrossAccountSharingRole, which
  CloudWatch uses for cross-account console functionality. This role has
  read-only access to CloudWatch data, and can also be assumed by applications
  in other accounts that belong to the same AWS Organization. This template is
  intended to be launched as part of a StackSet that automatically deploys to
  all accounts in an organization.

Parameters:
  OrganizationId:
    Type: String

Resources:
  CrossAccountSharingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                "aws:PrincipalOrgID": !Ref OrganizationId
            Effect: Allow
            Principal:
              AWS: "*"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchAutomaticDashboardsAccess
        - arn:aws:iam::aws:policy/AWSXrayReadOnlyAccess
      RoleName: CloudWatch-CrossAccountSharingRole
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId

Outputs:
  RoleNamePattern:
    Value: !Ref CrossAccountSharingRole
