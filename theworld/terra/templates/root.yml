Parameters:
  # Optional
  AuthorizedKeys: { Type: AWS::SSM::Parameter::Value<List<String>>, Default: /prx/global/Terra/authorized-keys, NoEcho: true }
  NestedChangeSetScrubbingResourcesState:
    Type: String
    Default: Disabled
    AllowedValues:
      - Enabled
      - Disabled
  # Required
  # AwsOrganizationId: { Type: AWS::SSM::Parameter::Value<String>, Default: /prx/global/Spire/aws-organization-id }
  # Parameter Overrides from the CodePipeline action
  TemplateUrlBase: { Type: String }
  EnvironmentType:
    Type: String
    AllowedValues:
      - Staging
      - Production
  EnvironmentTypeAbbreviation:
    Type: String
    AllowedValues:
      - stag
      - prod

Conditions:
  IsProduction: !Equals [!Ref EnvironmentType, Production]

Mappings:
  # Each app should be given a listener rule priority prefix between 1 and 500.
  # In app stacks, listener rule priorities are created by combining the
  # prefix with exactly two more digits. This allows each app to have up to 99
  # rules per listener.
  #
  # Higher-traffic apps should be given a higher priority (lower number) to
  # reduce the number of rules evaluations needed for more common requests.
  #
  # The final rule priority values must be between 1 and 50000.
  SharedAlbListenerRulePriorityMap:
    WordPress: { prefix: 25 }
  SharedVpcCidrBlockMap:
    # must be a /16 private network
    # https://github.com/PRX/internal/wiki/AWS:-VPC-CIDR-Ranges
    us-east-1:
      Staging: 10.40.0.0/16
      Production: 172.40.0.0/16
    us-west-2:
      Staging: 10.43.0.0/16
      Production: 172.43.0.0/16
  RegionModeMap:
    us-east-1:
      Staging: Primary
      Production: Primary
    us-west-2:
      Staging: Secondary
      Production: Secondary

# Conditions:
#   IsUsEast1: !Equals [!Ref "AWS::Region", us-east-1]
#   HasSharedAuroraMysqlEndpoint: !Not [!Equals [!Ref SharedAuroraMysqlEndpoint, ""]]
#   HasAllSharedAuroraEndpoints: !And [!Condition HasSharedAuroraMysqlEndpoint, !Condition HasSharedAuroraPostgresqlEndpoint]
#   CreateDatabaseDependentResources: !Condition HasAllSharedAuroraEndpoints
#   # Application stacks require external MySQL/PostgreSQL databases
#   CreateApplicationStacks: !Condition CreateDatabaseDependentResources
#   # Dashboard requires that application stacks have been created
#   CreateDashboardsStack: !Condition CreateApplicationStacks

Resources:
  Constants:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackId: !Ref AWS::StackId
        RootStackName: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Infrastructure }
      TemplateURL: !Sub ${TemplateUrlBase}/constants.yml
      TimeoutInMinutes: 5

  CustomResourcesStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackId
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/custom-resources.yml
      TimeoutInMinutes: 5

  Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !If [IsProduction, theworld.org, stag.theworld.org]
      SubjectAlternativeNames:
          Fn::If:
            - IsProduction
            - - admin.theworld.org
              - api.theworld.org
              - feeds.theworld.org
              - projects.theworld.org
              - sitemap.theworld.org
              - wordpress.theworld.org
            - - admin.stag.theworld.org
              - api.stag.theworld.org
              - feeds.stag.theworld.org
              - projects.stag.theworld.org
              - sitemap.stag.theworld.org
              - wordpress.stag.theworld.org
      Tags:
        - { Key: Name, Value: !Sub "${AWS::StackName} ${AWS::Region}" }
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      ValidationMethod: DNS

  SharedGlueDatabaseStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-glue-database.yml
      TimeoutInMinutes: 10

  SharedEcsClusterStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-ecs/ecs-cluster.yml
      TimeoutInMinutes: 20

  SharedVpcStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        AvailabilityZoneSelectorServiceToken: !GetAtt CustomResourcesStack.Outputs.AvailabilityZoneSelectorServiceToken
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackId
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        TemplateUrlPrefix: !Sub ${TemplateUrlBase}/shared-vpc
        SharedVpcCidrBlock: !FindInMap [SharedVpcCidrBlockMap, !Ref "AWS::Region", !Ref EnvironmentType]
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-vpc.yml
      TimeoutInMinutes: 20

  # Requires VPC and shared Glue DB
  SharedAlbStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackName
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        VpcPublicSubnet1Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
        VpcPublicSubnet2Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
        VpcPublicSubnet3Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id
        SharedGlueDatabaseName: !GetAtt SharedGlueDatabaseStack.Outputs.SharedGlueDatabaseName
        LatencyGroupDomain: !Sub spire-shared-alb-latency-group.${EnvironmentTypeAbbreviation}.prx.tech
        CertificateArn: !Ref Certificate
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-alb.yml
      TimeoutInMinutes: 40

  SharedDatabaseSecurityGroupsStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-db-sg.yml
      TimeoutInMinutes: 5
  SharedValkeySecurityGroupsStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-valkey-sg.yml
      TimeoutInMinutes: 5

  # Requires VPC and ALB
  SharedEcsAsgSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        LoadBalancerSecurityGroupId: !GetAtt SharedAlbStack.Outputs.LoadBalancerSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-ecs/asg-sg.yml
      TimeoutInMinutes: 20
  # Requires VPC, ALB, and more
  SharedEcsAsgAarch64Stack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RegionMode: !FindInMap [RegionModeMap, !Ref "AWS::Region", !Ref EnvironmentType]
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        AuthorizedKeys: !Join [",", !Ref AuthorizedKeys]
        VpcPublicSubnet1Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
        VpcPublicSubnet2Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
        VpcPublicSubnet3Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id
        EcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName
        SharedEcsAsgInstanceSecurityGroupId: !GetAtt SharedEcsAsgSecurityGroupStack.Outputs.InstanceSecurityGroupId
        LoadBalancerSecurityGroupId: !GetAtt SharedAlbStack.Outputs.LoadBalancerSecurityGroupId
        SharedMysqlClientSecurityGroupId: !GetAtt SharedDatabaseSecurityGroupsStack.Outputs.SharedMysqlClientSecurityGroupId
        SharedValkeyClientSecurityGroupId: !GetAtt SharedValkeySecurityGroupsStack.Outputs.SharedValkeyClientSecurityGroupId
        EcsLaunchEndpointsAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.EcsLaunchEndpointsAccessSecurityGroupId
        KmsEndpointAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.KmsEndpointAccessSecurityGroupId
        StsEndpointAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.StsEndpointAccessSecurityGroupId
        # SharedRedisReplicationGroupEndpointAddress: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointAddress
        # SharedRedisReplicationGroupEndpointPort: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointPort
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-ecs/asg-aarch64.yml
      TimeoutInMinutes: 1440

  SharedEcsCapacityProviderAssociationStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        EcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName
        Aarch64AsgCapacityProviderName: !GetAtt SharedEcsAsgAarch64Stack.Outputs.CapacityProviderName
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-ecs/ecs-capacity-provider-association.yml
      TimeoutInMinutes: 20

  SharedAuroraMysqlStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackId
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        VpcPublicSubnet1Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
        VpcPublicSubnet2Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
        VpcPublicSubnet3Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id
        SharedMysqlClientSecurityGroupId: !GetAtt SharedDatabaseSecurityGroupsStack.Outputs.SharedMysqlClientSecurityGroupId
        SharedMysqlMasterUsername: !Sub /prx/${EnvironmentTypeAbbreviation}/Terra/shared-mysql/master-username
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-aurora-mysql.yml
      TimeoutInMinutes: 20
  SharedValkeyStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackId: !Ref AWS::StackId
        RootStackName: !Ref AWS::StackName
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        SharedValkeyClientSecurityGroupId: !GetAtt SharedValkeySecurityGroupsStack.Outputs.SharedValkeyClientSecurityGroupId
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        VpcPrivateSubnet1Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
        VpcPrivateSubnet2Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
        VpcPrivateSubnet3Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-valkey.yml
      TimeoutInMinutes: 40

  WordPressStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        AlbFullName: !GetAtt SharedAlbStack.Outputs.AlbFullName
        AlbHttpsListenerArn: !GetAtt SharedAlbStack.Outputs.HttpsListenerArn
        EcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName
        EcsClusterArn: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterArn
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        EcrImageTag: !Sub /prx/${EnvironmentTypeAbbreviation}/Terra/The_World-WordPress/pkg/docker-image-tag
        AlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, WordPress, prefix]
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        EnvironmentTypeLowercase: !GetAtt Constants.Outputs.EnvironmentTypeLowercase
        RegionMode: !FindInMap [RegionModeMap, !Ref "AWS::Region", !Ref EnvironmentType]
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackId
        Aarch64AsgCapacityProviderName: !GetAtt SharedEcsAsgAarch64Stack.Outputs.CapacityProviderName
        MysqlHostname: !GetAtt SharedAuroraMysqlStack.Outputs.DbHostname
        ValkeyHostname: !GetAtt SharedValkeyStack.Outputs.CacheEndpointAddress
        ValkeyPort: !GetAtt SharedValkeyStack.Outputs.CacheEndpointPort
        AlbAccessToken: !Sub /prx/${EnvironmentTypeAbbreviation}/Terra/The_World-WordPress/alb-access-token
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/apps/wordpress.yml
      TimeoutInMinutes: 20

  SharedCdnStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackId
        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState
        SharedAlbDualstackDnsName: !GetAtt SharedAlbStack.Outputs.AlbDualstackDnsName
        CertificateArn: !Ref Certificate
        AlbAccessToken: !GetAtt WordPressStack.Outputs.AlbAccessToken
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: The World }
        - { Key: prx:dev:application, Value: Website }
      TemplateURL: !Sub ${TemplateUrlBase}/shared-cdn.yml
      TimeoutInMinutes: 20

  # Assumed to require all possible requirements
  DashboardsStack:
    Type: AWS::CloudFormation::Stack
    # Condition: CreateDashboardsStack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Parameters:
        EnvironmentType: !Ref EnvironmentType

        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackName

        NestedChangeSetScrubbingResourcesState: !Ref NestedChangeSetScrubbingResourcesState

        SharedEcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName

        SharedCdnCloudFrontDistributionId: !GetAtt SharedCdnStack.Outputs.CloudFrontDistributionId

        WordPressWebServiceName: !GetAtt WordPressStack.Outputs.WebServiceName
        WordPressWebTargetGroupFullName: !GetAtt WordPressStack.Outputs.WebTargetGroupFullName

  #       InfrastructureGitCommit: !Ref InfrastructureGitCommit

  #       SharedEcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName

  #       SharedVpcId: !GetAtt SharedVpcStack.Outputs.VpcId
  #       SharedVpcCidrBlock: !GetAtt SharedVpcStack.Outputs.VpcCidrBlock

        SharedEcsAsgAarch64Name: !GetAtt SharedEcsAsgAarch64Stack.Outputs.AsgName

        SharedAlbArn: !GetAtt SharedAlbStack.Outputs.AlbArn
        SharedAlbName: !GetAtt SharedAlbStack.Outputs.AlbName
        SharedAlbFullName: !GetAtt SharedAlbStack.Outputs.AlbFullName

        SharedValkeyCacheName: !GetAtt SharedValkeyStack.Outputs.CacheName

  #       SharedMemcachedCacheName: !GetAtt SharedMemcachedStack.Outputs.CacheName
  #       SharedAppRedisCacheName: !GetAtt SharedAppRedisStack.Outputs.CacheName

  #       SharedVpcFlowLogsLogGroupName: !GetAtt SharedVpcStack.Outputs.FlowLogsLogGroupName

      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${TemplateUrlBase}/dashboards.yml
      TimeoutInMinutes: 10
