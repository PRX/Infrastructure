# Dovetail CDN

## Deploy

Run `./deploy.sh` or `./deploy.sh --production`. This deploys a number of different CloudFormation stacks to several regions. All the stacks that are deployed for any given run are deployed to the same account, using an AWS CLI profile called `"prx-dovetail-cdn-$env_lower"` (where `env_lower` is either `staging` or `production`). Be sure that your profiles are set up correctly and reference the correct account IDs before doing any deploys.

Currently there are some circular dependencies between deploying these stacks and Spire stacks. Spire expects the CloudFront Origin Access Identity that is generated by the Dovetail CDN stack to exist. The Kinesis proxy function expects the `DovetailCdnLogsKinesisStreamOrgWriterRoleArn` from Spire to exist. The easiest thing to do is: deploy the Dovetail CDN stacks first **without the Kinesis Relay stack** (comment it out in `deploy.sh`). Create the necessary OAI parameters in Parameter Store and deploy Spire. Then run `deploy.sh` again with the Kinesis Relay stacks included.

## Permissions

The **Dovetail CDN Origin Request** Lambda function is deployed to all Dovetail-hosting regions. It needs to be able to `lambda:InvokeFunction` all deployed **Dovetail Arranger** Lambda functions, even those not in the same region. The Origin Request functions and Arranger functions are **not** in the same account. The Origin Request function roles are given permission for wildcard resources like `lambda:*:*:function:*ArrangerFunction*`, and the Arranger functions include a resource policy permitting invocations from all principals within the AWS Organization. The combination of the identity (role) policy and resource policy allow the Origin Request functions to call all necessary Arranger functions.

Each **Dovetail CDN Origin Request** Lambda function also needs `s3:GetObject` access to all the **Arranger Workspace** buckets. There is one bucket for each Arranger function. Similar to above, the function roles have wildcard permissions like `s3:::*dtcdnarrangerworkspace*`. The buckets' resource policy (i.e., bucket policy) permit `GetObject` from all principals within the AWS Organization.

Each **Kinesis Relay** function needs to be able to `kinesis:PutRecords` to a destination Kinesis stream in `prx-legacy`. It's mostly impossible to permit a role in one account to send records to a stream in another account, so the Lambda function role assumes a role that exists in `prx-legacy` that has the necessary permissions. This writer role is created alongside each Kinesis stream in `prx-legacy` (see `shared-dovetail-kinesis.yml`). No explicit permissions are needed for the Relay function to process events from the source Kinesis stream.
