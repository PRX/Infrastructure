# stacksets/cloudwatch-alarm-reader-role.yml
AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  Creates a StackSet that adds an IAM role to each account in an AWS
  Organization to provide access to CloudWatch Alarm history in those accounts
  from any other account within the Organization.
Parameters:
  StackSetName:
    Type: String
  OrganizationId:
    Description: e.g. o-a1s2d3f4f5g
    Type: String
    AllowedPattern: ^(o-[a-z0-9]{4,32})$
  OrganizationRootId:
    Description: e.g. r-az19
    Type: String
    AllowedPattern: ^(r-[a-z0-9]{4,32})$
  Region:
    Type: String
    AllowedValues:
      - us-east-1
    Default: us-east-1
  RoleNamePrefix:
    Type: String
    Default: PRX
  RoleNameBase:
    Type: String
    Default: CloudWatchAlarmsOrgReader
Resources:
  StackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: true
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: >-
        Launches a root account activity monitor in one region in each account
        in an AWS Organization. An activity monitor can monitor activity in all
        regions in the account it belongs to.
      OperationPreferences:
        FailureToleranceCount: 1
        MaxConcurrentCount: 1
      Parameters:
        - ParameterKey: OrganizationId
          ParameterValue: !Ref OrganizationId
        - ParameterKey: RoleNamePrefix
          ParameterValue: !Ref RoleNamePrefix
        - ParameterKey: RoleNameBase
          ParameterValue: !Ref RoleNameBase
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref OrganizationRootId
          Regions:
            - !Ref Region
      StackSetName: !Ref StackSetName
      # Tags:
      #   - Key: "prx:cloudformation:stack-name"
      #     Value: !Ref AWS::StackName
      #   - Key: "prx:cloudformation:stack-id"
      #     Value: !Ref AWS::StackId
      TemplateURL: https://s3-external-1.amazonaws.com/cf-templates-1m3ojrwerxj2t-us-east-1/2020317r5q-cloudwatch-alarm-reader-role.yml
