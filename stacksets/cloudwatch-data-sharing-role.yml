# stacksets/cloudwatch-data-sharing-role.yml
AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  Creates a StackSet that adds an IAM role to each account in an AWS
  Organization with the special name CloudWatch-CrossAccountSharingRole and has
  read-only access to CloudWatch.

Parameters:
  StackSetName:
    Type: String
  OrganizationId:
    Description: e.g. o-a1s2d3f4f5g
    Type: String
    AllowedPattern: ^(o-[a-z0-9]{4,32})$
  OrganizationRootId:
    Description: e.g. r-az19
    Type: String
    AllowedPattern: ^(r-[a-z0-9]{4,32})$
  Region:
    Type: String
    AllowedValues:
      - us-east-1
      - us-east-2
    Default: us-east-2

Resources:
  StackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: true
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: >-
        Launches a stack in one region in each account in an AWS Organization
        to add the CloudWatch-CrossAccountSharingRole IAM role to each account,
        which provides read-only access to that account's CloudWatch data.
      OperationPreferences:
        FailureToleranceCount: 1
        MaxConcurrentCount: 1
      Parameters:
        - ParameterKey: OrganizationId
          ParameterValue: !Ref OrganizationId
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref OrganizationRootId
          Regions:
            - !Ref Region
      StackSetName: !Ref StackSetName
      # Tags:
      #   - Key: "prx:cloudformation:stack-name"
      #     Value: !Ref AWS::StackName
      #   - Key: "prx:cloudformation:stack-id"
      #     Value: !Ref AWS::StackId
      TemplateURL: https://s3.us-east-2.amazonaws.com/cf-templates-1m3ojrwerxj2t-us-east-2/2020338FN4-cloudwatch-data-sharing-role.yml
