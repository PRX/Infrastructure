# TODO path
AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  Creates a StackSet to launch a root account activity monitor stack in one
  region in each account in an AWS Organization. An activity monitor can
  monitor activity in all regions in the account it belongs to.
Parameters:
  StackSetName:
    Type: String
  OrganizationRootId:
    Type: String
    AllowedPattern: ^(ou-[a-z0-9]{4,32}-[a-z0-9]{8,32}|r-[a-z0-9]{4,32})$
  Region:
    Type: String
    AllowedValues:
      - us-east-1
    Default: us-east-1
  SlackMessageRelayTopicArn:
    Type: String
  PermissionModel:
    AllowedValues:
      - SELF_MANAGED
      - SERVICE_MANGED
    Default: SERVICE_MANGED
    Type: String
Resources:
  StackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: true
      Capabilities:
        - CAPABILITY_IAM
      Description: >-
        Launches a root account activity monitor in one region in each account
        in an AWS Organization. An activity monitor can monitor activity in all
        regions in the account it belongs to.
      OperationPreferences:
        FailureToleranceCount: 0
        MaxConcurrentCount: 1
      Parameters:
        - ParameterKey: SlackMessageRelayTopicArn
          ParameterValue: !Ref SlackMessageRelayTopicArn
      PermissionModel: !Ref PermissionModel
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref OrganizationRootId
          Regions:
            - !Ref Region
      StackSetName: !Ref StackSetName
      Tags:
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
