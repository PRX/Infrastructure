AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >-
  Creates an custom EventBridge event bus to handle CloudWatch Alarms from all
  accounts and all regions and send notification to Slack.

Parameters:
  OrganizationId:
    Type: String
    Description: >-
      optional. An AWS Organization ID in the format: o-a1s2d3f4f5g. If
      included, the CloudTrail that is created will be a organization trail,
      and log activity from all accounts in the given organization.
    AllowedPattern: ^$|^(o-[a-z0-9]{4,32})$
  SlackMessageRelaySnsTopicArn:
    Type: String
  CrossAccountCloudWatchAlarmIamRoleName:
    Type: String

Resources:
  CloudWatchAlarmsEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Ref AWS::StackName
  CloudWatchAlarmsEventBusPolicy:
    Type: AWS::Events::EventBusPolicy
    Properties:
      EventBusName: !Ref CloudWatchAlarmsEventBus
      StatementId: AllowOrganizationPutEvents
      Statement:
        Action: events:PutEvents
        Condition:
          StringEquals:
            aws:PrincipalOrgID: !Ref OrganizationId
        Effect: Allow
        Principal: "*"
        Resource: !GetAtt CloudWatchAlarmsEventBus.Arn
  CloudWatchAlarmsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Description: >-
        Sends messages to Slack in response to CloudWatch Alarms state changes
        from across the organization. All accounts and all regions forward
        CloudWatch Alarms state change events to the custom event bus that
        has rules to trigger this function.
      Environment:
        Variables:
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
          SLACK_MESSAGE_RELAY_SNS_TOPIC_ARN: !Ref SlackMessageRelaySnsTopicArn
          CROSS_ACCOUNT_CLOUDWATCH_ALARM_IAM_ROLE_NAME: !Ref CrossAccountCloudWatchAlarmIamRoleName
      Events:
        Alarms:
          Properties:
            EventBusName: !Ref CloudWatchAlarmsEventBus
            Pattern:
              detail-type:
                - CloudWatch Alarm State Change
              source:
                - aws.cloudwatch
          Type: EventBridgeRule
      Handler: index.handler
      MemorySize: 128
      Policies:
        - Statement:
            - Action: sns:Publish
              Effect: Allow
              Resource: !Ref SlackMessageRelaySnsTopicArn
          Version: "2012-10-17"
        - Statement:
            - Action: sts:AssumeRole
              Effect: Allow
              Resource: !Sub arn:aws:iam::*:role/${CrossAccountCloudWatchAlarmIamRoleName}
          Version: "2012-10-17"
      Runtime: nodejs14.x
      Tags:
        prx:meta:tagging-version: "2021-04-07"
        prx:cloudformation:stack-name: !Ref AWS::StackName
        prx:cloudformation:stack-id: !Ref AWS::StackId
        prx:ops:environment: Production
        prx:dev:application: DevOps
      Timeout: 8
  CloudWatchAlarmsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${CloudWatchAlarmsFunction}
      RetentionInDays: 14
