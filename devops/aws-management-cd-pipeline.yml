# devops/aws-management-cd-pipeline.yml
# This template is deployed continuously via GitHub Actions.
#
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >-
  Creates a CodePipeline for use in the management account of an AWS
  Organization to create and maintain a set of resources used for security,
  compliance, permissions, etc.

Parameters:
  kAllRegions:
    Type: CommaDelimitedList
    # Excludes: af-south-1, eu-south-1, me-south-1, ap-east-1
    Default: us-east-1,us-east-2,us-west-1,us-west-2,ap-south-1,ap-northeast-3,ap-northeast-2,ap-southeast-1,ap-southeast-2,ap-northeast-1,ca-central-1,eu-central-1,eu-west-1,eu-west-2,eu-west-3,eu-north-1,sa-east-1
  ######
  CodeStarConnectionArn:
    Type: String
  OrganizationId:
    Type: String
    Description: e.g. o-a1s2d3f4f5g
    AllowedPattern: ^(o-[a-z0-9]{4,32})$
  OrganizationRootId:
    Type: String
    AllowedPattern: ^(ou-[a-z0-9]{4,32}-[a-z0-9]{8,32}|r-[a-z0-9]{4,32})$
  SingleRegion:
    Type: String
    Description: >-
      For stack sets that deploy to a single region in all accounts, this
      is that region
    AllowedValues:
      - us-east-1
      - us-east-2
    Default: us-east-2
  SlackMessageRelayTopicArn:
    Type: String
  CloudWatchMonitoringAccountIds:
    Description: >-
      Allows one or more monitoring accounts to view AWS Organization account
      list. Enter AWS account ids, 12 numeric digits in comma-separated list
    Type: String
  DevOpsCloudWatchAlarmsBusArn:
    Type: String
  DevOpsCloudFormationNotificationsBusArn:
    Type: String
  DevOpsSlackRelayBusArn:
    Type: String
  CloudTrailProjectionRegions:
    Description: >-
      A list of regions that will be included in Glue table partitions for
      a table created for the organization trail logs
    Type: CommaDelimitedList
  CloudTrailProjectionAccounts:
    Description: >-
      A list of accounts that will be included in Glue table partitions for
      a table created for the organization trail logs
    Type: CommaDelimitedList

Resources:
  # Allows read-only access to all CloudFormation resources (not the resources
  # in CloudFormation stacks).
  CloudFormationReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows read only access for all CloudFormation resources
      PolicyDocument:
        Statement:
          - Action:
              - cloudformation:Describe*
              - cloudformation:Get*
              - cloudformation:List*
            Effect: Allow
            Resource: "*"
            Sid: AllowGlobalReadOnly
        Version: "2012-10-17"

  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref CloudFormationReadOnlyPolicy
      Policies:
        # Let CodePipeline describe CloudFormation stacks
        - PolicyName: CloudFormationAccess
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action: cloudformation:*
                Resource:
                  - "*" # TODO
                  # - arn:aws:cloudformation:*::type/resource/AWS-IAM-ManagedPolicy
                  # # Add each StackSetName from the pipeline's actions. There
                  # # will be both a root and wildcard resource for each.
                  # - !Sub arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stackset/org-devops-cross-account-access-role
                  # - !Sub arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stackset/org-devops-cross-account-access-role:*
            Version: "2012-10-17"
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  # CodePipeline need PUT access to AWS-managed service buckets
  CodePipelineServiceS3Policy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: s3:PutObject
            Effect: Allow
            Resource: arn:aws:s3:::codepipeline*
            Sid: AllowCodePipelineS3Put
        Version: "2012-10-17"
      PolicyName: CodePipelineService
      Roles: [!Ref PipelineRole]
  # Allow CodePipeline to read and write artifacts
  PipelineArtifactStoreAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:Get*
              - s3:Put*
              - s3:List*
            Effect: Allow
            Resource:
              - !GetAtt PipelineArtifactStore.Arn
              - !Sub ${PipelineArtifactStore.Arn}/*
            Sid: AllowArtifactFullReadWrite
        Version: "2012-10-17"
      PolicyName: PipelineArtifactStore
      Roles: [!Ref PipelineRole]
  # To allow the pipeline to use a CodeStar Connection
  CodeStarConnectionPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: codestar-connections:*
            Condition:
              ForAllValues:StringEquals:
                codestar-connections:PassedToService: codepipeline.amazonaws.com
            Effect: Allow
            Resource: !Ref CodeStarConnectionArn
            Sid: AllowConnectionFullAccess
        Version: "2012-10-17"
      PolicyName: CodeStarConnection
      Roles: [!Ref PipelineRole]
  # Allow the pipeline role to pass roles to CloudFormation. These are the
  # roles used by individual CloudFormation deploy actions within the pipeline.
  PassRollToCloudFormationPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: iam:PassRole
            Condition:
              StringEquals:
                iam:PassedToService: cloudformation.amazonaws.com
            Effect: Allow
            Resource:
              - !GetAtt DevopsCrossAccountAccessRoleStackRole.Arn
              - !GetAtt CloudWatchDataSharingRoleStackRole.Arn
              - !GetAtt CloudWatchSharingListAccountsRoleStackRole.Arn
              - !GetAtt OrganizationDataSharingRoleStackRole.Arn
              - !GetAtt OrganizationCloudTrailStackRole.Arn
              - !GetAtt IamKeyMonitorStackRole.Arn
              - !GetAtt GitHubOidcRoleStackRole.Arn
              - !GetAtt OamSinkStackRole.Arn
            Sid: AllowPassingRoleToCloudFormation
        Version: "2012-10-17"
      PolicyName: PassRole
      Roles: [!Ref PipelineRole]

  # Provides read-only access to certain stack resources
  StackResourceReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows read only access for select stack resources
      PolicyDocument:
        Statement:
          - Action:
              - iam:Get*
              - iam:List*

              - organizations:DescribeOrganization
              - organizations:ListAccounts
              - organizations:ListAWSServiceAccessForOrganization

              - s3:Get*
              - s3:List*
            Effect: Allow
            Resource: "*"
            Sid: AllowStackResourceReadOnly
        Version: "2012-10-17"
  # Provides access to serverless tranform
  ServerlessTransformPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows read only access for select stack resources
      PolicyDocument:
        Statement:
          - Action: cloudformation:*
            Effect: Allow
            Resource: !Sub arn:aws:cloudformation:${AWS::Region}:aws:transform/Serverless-2016-10-31
            Sid: AllowServerlessTransformFullAccess
        Version: "2012-10-17"

  # These roles are passed to CloudFormation by the pipeline role in various
  # pipeline deploy actions. They each must have permissions to manage the
  # resources in the associated stack.
  #
  # These roles are used only for deploying single stacks within the management
  # account; they do not apply to any aspect of StackSet deploys.
  DevopsCrossAccountAccessRoleStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - iam:AttachRolePolicy
                  - iam:CreatePolicy
                  - iam:CreatePolicyVersion
                  - iam:CreateRole
                  - iam:DeletePolicy
                  - iam:DeletePolicyVersion
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:Get*
                  - iam:List*
                  - iam:PutRolePolicy
                  - iam:SetDefaultPolicyVersion
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Effect: Allow
                Resource: "*"
            Version: "2012-10-17"
          PolicyName: ResourceManipulationPolicy
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  GitHubOidcRoleStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref StackResourceReadOnlyPolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - iam:AddClientIDToOpenIDConnectProvider
                  - iam:AttachRolePolicy
                  - iam:CreateOpenIDConnectProvider
                  - iam:CreatePolicy
                  - iam:CreatePolicyVersion
                  - iam:CreateRole
                  - iam:DeleteOpenIDConnectProvider
                  - iam:DeletePolicy
                  - iam:DeletePolicyVersion
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:RemoveClientIDFromOpenIDConnectProvider
                  - iam:SetDefaultPolicyVersion
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateOpenIDConnectProviderThumbprint
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Effect: Allow
                Resource: "*"
                Sid: AllowRoleManipulation
            Version: "2012-10-17"
          PolicyName: StackResourceManipulation
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  CloudWatchDataSharingRoleStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref StackResourceReadOnlyPolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - iam:AttachRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Effect: Allow
                Resource: "*"
                Sid: AllowRoleManipulation
            Version: "2012-10-17"
          PolicyName: StackResourceManipulation
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  CloudWatchSharingListAccountsRoleStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref StackResourceReadOnlyPolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - iam:AttachRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Effect: Allow
                Resource: "*"
                Sid: AllowRoleManipulation
            Version: "2012-10-17"
          PolicyName: StackResourceManipulation
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  OrganizationDataSharingRoleStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref StackResourceReadOnlyPolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - iam:AttachRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:PutRolePolicy
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Resource: "*"
                Sid: AllowRoleManipulation
            Version: "2012-10-17"
          PolicyName: StackResourceManipulation
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  OrganizationCloudTrailStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref StackResourceReadOnlyPolicy
        - !Ref ServerlessTransformPolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - athena:*

                  - cloudtrail:*

                  - glue:*

                  - iam:CreateServiceLinkedRole

                  - lambda:*

                  - logs:*

                  - organizations:DisableAWSServiceAccess
                  - organizations:EnableAWSServiceAccess

                  - s3:CreateBucket
                  - s3:PutBucketOwnershipControls
                  - s3:PutBucketPolicy
                  - s3:PutBucketTagging
                  - s3:PutLifecycleConfiguration
                  - s3:PutObjectTagging
                Effect: Allow
                Resource: "*"
                Sid: AllowCloudTrailManipulation
            Version: "2012-10-17"
          PolicyName: StackResourceManipulation
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  IamKeyMonitorStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref StackResourceReadOnlyPolicy
        - !Ref ServerlessTransformPolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - events:*
                  - iam:*
                  - lambda:*
                  - logs:*
                Condition:
                  StringEquals:
                    # This ensures that the role only makes changes via
                    # CloudFormation, which ensures that only resources managed
                    # by the stacks listed above can be altered.
                    aws:CalledViaFirst: cloudformation.amazonaws.com
                Effect: Allow
                Resource: "*"
                Sid: AllowKeyMonitorManipulation
              - Action:
                  # Seems like sometimes this gets called in a way that
                  # CalledViaFirst does not satisfy
                  - events:Describe*
                Effect: Allow
                Resource: "*"
                Sid: AllowMoreKeyMonitorManipulation
            Version: "2012-10-17"
          PolicyName: StackResourceManipulation
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  OamSinkStackRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Ref StackResourceReadOnlyPolicy
        - !Ref ServerlessTransformPolicy
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - oam:CreateSink
                  - oam:DeleteSink
                  - oam:PutSinkPolicy
                  - oam:TagResource
                Effect: Allow
                Resource: "*"
                Sid: AllowSinkManipulation
              - Action:
                  - oam:Get*
                  - oam:List*
                Effect: Allow
                Resource: "*"
                Sid: AllowOamRead
            Version: "2012-10-17"
          PolicyName: StackResourceManipulation
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }

  PipelineArtifactStore:
    # The bucket used to store artifacts generated by CodePipeline actions.
    # This bucket is to be used exclusively by AWS; don't use it to store any
    # app, infrastructure, or user data.
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 14
            Status: Enabled
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      ArtifactStore:
        Location: !Ref PipelineArtifactStore
        Type: S3
      RoleArn: !GetAtt PipelineRole.Arn
      Stages:
        - Name: Source
          Actions:
            - Name: InfrastructureRepo
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: "1"
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: PRX/Infrastructure
                BranchName: main
                OutputArtifactFormat: CODE_ZIP
                DetectChanges: false
              Namespace: infrastructure_repo
              OutputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1

        - Name: Management_Account-One_Region
          # These actions all deploy a single CloudFormation stack to the same
          # region and account as this pipeline
          Actions:
            # DevOps-CrossAccountAccessRole IAM role
            - Name: DevopsCrossAcctRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}DevopsCrossAcctRole
                ParameterOverrides: !Sub |
                  {
                    "OrganizationId": "${OrganizationId}"
                  }
                RoleArn: !GetAtt DevopsCrossAccountAccessRoleStackRole.Arn
                StackName: !Sub ${AWS::StackName}-devops-cross-account-access-role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-cross-account-access-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudWatch-CrossAccountSharingRole IAM role
            - Name: CloudWatchCrossAcctRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}CloudWatchCrossAcctRole
                ParameterOverrides: !Sub |
                  {
                    "OrganizationId": "${OrganizationId}"
                  }
                RoleArn: !GetAtt CloudWatchDataSharingRoleStackRole.Arn
                StackName: !Sub ${AWS::StackName}-cloudwatch-data-sharing-role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/cloudwatch-data-sharing-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudWatch-CrossAccountSharing-ListAccountsRole IAM role
            # This is a magagement account-only stack
            - Name: CloudWatchListAcctRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}CloudWatchListAcctRole
                ParameterOverrides: !Sub |
                  {
                    "MonitoringAccountIds": "${CloudWatchMonitoringAccountIds}"
                  }
                RoleArn: !GetAtt CloudWatchSharingListAccountsRoleStackRole.Arn
                StackName: cloudwatch-sharing-list-accounts-role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/cloudwatch-data-sharing-org-list-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # PRX-Oganization-CrossAccountSharingRole IAM role
            # This is a magagement account-only stack
            - Name: OrgDataSharingRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}OrgDataSharingRole
                ParameterOverrides: !Sub |
                  {
                    "OrganizationId": "${OrganizationId}"
                  }
                RoleArn: !GetAtt OrganizationDataSharingRoleStackRole.Arn
                StackName: organization-data-sharing-role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-cross-account-sharing-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudTrail Organization trail
            - Name: OrgTrail
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}OrgTrail
                ParameterOverrides: !Sub
                  - >-
                    {
                      "OrganizationId": "${OrganizationId}",
                      "ProjectionRegions": "${regions}",
                      "ProjectionAccounts": "${accounts}"
                    }
                  - regions: !Join [",", !Ref CloudTrailProjectionRegions]
                    accounts: !Join [",", !Ref CloudTrailProjectionAccounts]
                RoleArn: !GetAtt OrganizationCloudTrailStackRole.Arn
                StackName: organization-trail
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-trail.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # DevOps-GitHubOidcFederatedRole IAM role
            - Name: GitHubOidcRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}GitHubOidcRole
                RoleArn: !GetAtt GitHubOidcRoleStackRole.Arn
                StackName: !Sub ${AWS::StackName}-github-oidc-role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/github-oidc-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # IAM key monitor
            - Name: IamKeyMonitor
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}IamKeyMonitor
                ParameterOverrides: !Sub |
                  {
                    "SlackMessageRelayTopicArn": "${SlackMessageRelayTopicArn}"
                  }
                RoleArn: !GetAtt IamKeyMonitorStackRole.Arn
                StackName: !Sub ${AWS::StackName}-iam-key-monitor
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-iam-key-monitor.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # Observability Access Manager monitoring account sink
            - Name: OamSink
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                ChangeSetName: !Sub ${AWS::StackName}OamSink
                ParameterOverrides: !Sub |
                  {
                    "OrganizationId": "${OrganizationId}"
                  }
                RoleArn: !GetAtt OamSinkStackRole.Arn
                StackName: !Sub ${AWS::StackName}-oam-sink
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/oam-monitoring-account-sink.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              Namespace: oam_sink
              RunOrder: 1

        - Name: Organization_Accounts-One_Region
          # These actions all deploy a stackset to the same region as this
          # pipeline, which creates stacks in one region in every account in
          # the organization, except the management account
          Actions:
            # DevOps-CrossAccountAccessRole IAM role
            - Name: DevopsCrossAcctRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-devops-cross-account-access-role
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to add the DevOps-CrossAccountAccessRole IAM role to each account,
                  which provides access to various resources for DevOps purposes.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-cross-account-access-role.yml
                Parameters: !Sub ParameterKey=OrganizationId,ParameterValue=${OrganizationId}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref SingleRegion
                FailureTolerancePercentage: 8
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudWatch-CrossAccountSharingRole IAM role
            - Name: CloudWatchCrossAcctRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cloudwatch-data-sharing-role
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to add the CloudWatch-CrossAccountSharingRole IAM role to each account,
                  which provides read-only access to that account's CloudWatch data.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/cloudwatch-data-sharing-role.yml
                Parameters: !Sub ParameterKey=OrganizationId,ParameterValue=${OrganizationId}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref SingleRegion
                FailureTolerancePercentage: 8
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudFormation Macros
            - Name: CfnMacros
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cfn-macros
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to create all standard CloudFormation macros
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-cfn-macros.yml
                # Parameters: !Sub ParameterKey=OrganizationId,ParameterValue=${OrganizationId}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref SingleRegion
                FailureTolerancePercentage: 8
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # DevOps-GitHubOidcFederatedRole IAM role
            - Name: GitHubOidcRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-github-oidc-role
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to create the GitHub OIDC role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/github-oidc-role.yml
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref SingleRegion
                FailureTolerancePercentage: 8
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # DevOps-CrossAccountCfnCustomResourceRole IAM role
            - Name: CfnCustomResourceRole
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cfn-custom-resource-role
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to create the cross-account CloudFormation custom resource role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-cross-account-cfn-custom-resource-role.yml
                Parameters: !Sub ParameterKey=OrganizationId,ParameterValue=${OrganizationId}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref SingleRegion
                FailureTolerancePercentage: 8
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # Observability Access Manager source account link
            - Name: OamLink
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-oam-source-account-link
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to create an OAM link to the sink (monitoring account)
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/oam-source-account-link.yml
                Parameters: !Sub ParameterKey=SinkArn,ParameterValue=#{oam_sink.SinkArn}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref SingleRegion
                FailureTolerancePercentage: 8
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1

        - Name: Management_Account-All_Regions
          # These actions all deploy a stackset to the same account as this
          # pipeline, which creates stacks in all regions of that account
          Actions:
            # CloudWatch Alarms event bus
            - Name: CloudWatchAlarmsBus
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cloudwatch-alarms-event-bus-mgmt
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                Description: >-
                  Launches a stack in each region in the management account
                  to create a rule on the default event bus that forwards
                  CloudWatch Alarm state changes to the DevOps event bus.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-alarms-bus.yml
                Parameters: !Sub |-
                  ParameterKey=DevOpsCloudWatchAlarmsBusArn,ParameterValue=${DevOpsCloudWatchAlarmsBusArn}
                PermissionModel: SELF_MANAGED
                DeploymentTargets: !Ref AWS::AccountId
                Regions: !Join [",", !Ref kAllRegions]
                FailureTolerancePercentage: 0
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudTrail monitor
            - Name: CloudTrailMonitor
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cloudtrail-monitor-mgmt
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                Description: >-
                  Launches a stack in each region in the management account
                  to create a Lambda function that can monitor CloudTrails for
                  various types of activity.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-cloudtrail-monitor.yml
                Parameters: !Sub ParameterKey=SlackMessageRelayTopicArn,ParameterValue=${SlackMessageRelayTopicArn}
                PermissionModel: SELF_MANAGED
                DeploymentTargets: !Ref AWS::AccountId
                Regions: !Join [",", !Ref kAllRegions]
                FailureTolerancePercentage: 0
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1

        - Name: Organization_Accounts-All_Regions
          # These actions all deploy a stackset to the same region as this
          # pipeline, which creates stacks in all regions in every account in
          # the organization except the management account
          Actions:
            # CloudWatch Alarms event bus rule
            - Name: CloudWatchAlarmsBus
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cloudwatch-alarms-event-bus
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                Description: >-
                  Launches a stack in each region in each account in an AWS Organization
                  to create a rule on the default event bus that forwards CloudWatch
                  Alarm state changes to the DevOps event bus.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-alarms-bus.yml
                Parameters: !Sub |-
                  ParameterKey=DevOpsCloudWatchAlarmsBusArn,ParameterValue=${DevOpsCloudWatchAlarmsBusArn}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Join [",", !Ref kAllRegions]
                FailureTolerancePercentage: 10
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudFormation Notifications event bus rule
            - Name: CloudFormationNotificationsBus
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cloudformation-notifications-event-bus
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                Description: >-
                  Launches a stack in each region in each account in an AWS Organization
                  to create a rule on the default event bus that forwards CloudFormation
                  status changes to the DevOps event bus.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-cfn-bus.yml
                Parameters: !Sub |-
                  ParameterKey=DevOpsCloudFormationNotificationsBusArn,ParameterValue=${DevOpsCloudFormationNotificationsBusArn}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Join [",", !Ref kAllRegions]
                FailureTolerancePercentage: 10
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # Slack Message Relay event bus rule
            - Name: SlackMessageRelayBusRule
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-slack-relay-event-bus-rule
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                Description: >-
                  Launches a stack in each region in each account in an AWS Organization
                  to create a rule on the default event bus that forwards Slack messages
                  to the custom event bus in the DevOps accounts.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-slack-relay-bus-rule.yml
                Parameters: !Sub |-
                  ParameterKey=SlackMessageRelayEventBusArn,ParameterValue=${DevOpsSlackRelayBusArn}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Join [",", !Ref kAllRegions]
                FailureTolerancePercentage: 10
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudTrail monitor
            - Name: CloudTrailMonitor
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cloudtrail-monitor
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                Description: >-
                  Launches a stack in each region in each account in an AWS Organization
                  to create a Lambda function that can monitor CloudTrails for various
                  types of activity.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-cloudtrail-monitor.yml
                Parameters: !Sub ParameterKey=SlackMessageRelayTopicArn,ParameterValue=${SlackMessageRelayTopicArn}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Join [",", !Ref kAllRegions]
                FailureTolerancePercentage: 10
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1

      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }

  PipelineStateChangeFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Sends a message when DevOps pipeline completes
      Environment:
        Variables:
          SLACK_MESSAGE_RELAY_TOPIC_ARN: !Ref SlackMessageRelayTopicArn
      Events:
        PipelineState:
          Properties:
            Pattern:
              detail-type:
                - CodePipeline Pipeline Execution State Change
              resources:
                - !Sub arn:${AWS::Partition}:codepipeline:${AWS::Region}:${AWS::AccountId}:${Pipeline}
              source:
                - aws.codepipeline
          Type: EventBridgeRule
        StageState:
          Properties:
            Pattern:
              detail:
                stage:
                  - Organization_Accounts-One_Region
                state:
                  - SUCCEEDED
              detail-type:
                - CodePipeline Stage Execution State Change
              resources:
                - !Sub arn:${AWS::Partition}:codepipeline:${AWS::Region}:${AWS::AccountId}:${Pipeline}
              source:
                - aws.codepipeline
          Type: EventBridgeRule
      Handler: index.handler
      InlineCode: |
        const { SNS } = require('@aws-sdk/client-sns');

        const sns = new SNS({
          apiVersion: '2010-03-31',
          region: process.env.SLACK_MESSAGE_RELAY_TOPIC_ARN.split(':')[3]
        });

        exports.handler = async (event) => {
          console.log(JSON.stringify(event));

          let msg;

          // https://docs.aws.amazon.com/codepipeline/latest/userguide/detect-state-changes-cloudwatch-events.html#detect-state-events-types
          if (event['detail-type'] === 'CodePipeline Pipeline Execution State Change') {
            if (event.detail.state === 'SUCCEEDED') {
                msg = ':white_check_mark: `prx-main`:`us-east-2` – AWS Management pipeline completed.';
            } else if (event.detail.state === 'FAILED') {
                msg = ':x: `prx-main`:`us-east-2` – AWS Management pipeline failed.';
            } else if (event.detail.state === 'STARTED') {
                msg = ':hourglass_flowing_sand: `prx-main`:`us-east-2` – AWS Management pipeline started.';
            }
          } else if (event['detail-type'] === 'CodePipeline Stage Execution State Change') {
            if (event.detail.state === 'SUCCEEDED' && event.detail.stage === 'Organization_Accounts-One_Region') {
              msg = ':hourglass_flowing_sand: `prx-main`:`us-east-2` – AWS Management pipeline *one region* stages completed.';
            }
          }

          if (msg) {
            await sns
              .publish({
                TopicArn: process.env.SLACK_MESSAGE_RELAY_TOPIC_ARN,
                Message: JSON.stringify({
                  channel: '#ops-deploys',
                  username: 'AWS CodePipeline',
                  icon_emoji: ':ops-codepipeline:',
                  text: msg,
                }),
              });
          }
        };
      MemorySize: 128
      Policies:
        - Statement:
            - Action: sns:Publish
              Effect: Allow
              Resource: !Ref SlackMessageRelayTopicArn
              Sid: AllowSlackSnsPublish
          Version: "2012-10-17"
      Runtime: nodejs18.x
      Tags:
        prx:meta:tagging-version: "2021-04-07"
        prx:cloudformation:stack-name: !Ref AWS::StackName
        prx:cloudformation:stack-id: !Ref AWS::StackId
        prx:ops:environment: Production
        prx:dev:application: DevOps
      Timeout: 3
  PipelineStateChangeFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      LogGroupName: !Sub /aws/lambda/${PipelineStateChangeFunction}
      RetentionInDays: 14
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: Production }
        - { Key: prx:dev:application, Value: DevOps }
