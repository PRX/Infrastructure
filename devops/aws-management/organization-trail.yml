# devops/aws-management/organization-trail.yml

AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Creates a CloudTrail Organization trail

Parameters:
  OrganizationId:
    Type: String
    Description: >-
      optional. An AWS Organization ID in the format: o-a1s2d3f4f5g. If
      included, the CloudTrail that is created will be a organization trail,
      and log activity from all accounts in the given organization.
    AllowedPattern: ^$|^(o-[a-z0-9]{4,32})$

Resources:
  CloudTrailS3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 14
            Status: Enabled
      OwnershipControls:
        Rules:
          # The IAM Access Analyzer requires that CloudTrail objects that it
          # analyzes to generate policies be owned by the bucket owner
          # https://docs.aws.amazon.com/IAM/latest/UserGuide/access-analyzer-policy-generation.html#access-analyzer-policy-generation-cross-account
          - ObjectOwnership: BucketOwnerPreferred
      Tags:
        - Key: Project
          Value: Admin
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
  CloudTrailS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudTrailS3Bucket
      PolicyDocument:
        Statement:
          - Sid: AWSCloudTrailAclCheck
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !GetAtt CloudTrailS3Bucket.Arn
          - Sid: AWSCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub ${CloudTrailS3Bucket.Arn}/AWSLogs/${AWS::AccountId}/*
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control
          - Sid: AWSOrgCloudTrailWrite
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub ${CloudTrailS3Bucket.Arn}/AWSLogs/${OrganizationId}/*
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control
          - Sid: IamAccessAnalyzerRead
            Effect: Allow
            Principal:
              AWS: "*"
            Action:
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !GetAtt CloudTrailS3Bucket.Arn
              - !Sub ${CloudTrailS3Bucket.Arn}/AWSLogs/${OrganizationId}/${!aws:PrincipalAccount}/*
            Condition:
              StringEquals:
                aws:PrincipalOrgID: !Ref OrganizationId
              StringLike:
                aws:PrincipalArn: arn:aws:iam::${!aws:PrincipalAccount}:role/service-role/AccessAnalyzerMonitorServiceRole*
        Version: "2012-10-17"

  CloudTrail:
    Type: AWS::CloudTrail::Trail
    DependsOn:
      - CloudTrailS3BucketPolicy
    Properties:
      IncludeGlobalServiceEvents: true
      IsLogging: true
      IsMultiRegionTrail: true
      IsOrganizationTrail: true
      S3BucketName: !Ref CloudTrailS3Bucket
      Tags:
        - Key: Project
          Value: Admin
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
