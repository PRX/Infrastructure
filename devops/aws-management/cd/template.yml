# devops/aws-management/cd/template.yml
AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >-
  Creates a CodePipeline for use in the management account of an AWS
  Organization to create and maintain a set of resources used for security,
  compliance, permissions, etc.

Parameters:
  CodeStarConnectionArn:
    Type: String
  OrganizationId:
    Type: String
    Description: e.g. o-a1s2d3f4f5g
    AllowedPattern: ^(o-[a-z0-9]{4,32})$
  OrganizationRootId:
    Type: String
    AllowedPattern: ^(ou-[a-z0-9]{4,32}-[a-z0-9]{8,32}|r-[a-z0-9]{4,32})$
  Region:
    Type: String
    AllowedValues:
      - us-east-1
      - us-east-2
    Default: us-east-2
  SlackMessageRelayTopicArn:
    Type: String
  CloudWatchMonitoringAccountIds:
    Description: >-
      Allows one or more monitoring accounts to view AWS Organization account
      list. Enter AWS account ids, 12 numeric digits in comma-separated list
    Type: String

Resources:
  PipelineArtifactStore:
    # The bucket used to store artifacts generated by CodePipeline actions.
    # This bucket is to be used exclusively by AWS; don't use it to store any
    # app, infrastructure, or user data.
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 14
            Status: Enabled
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
  PipelineIamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
        Version: "2012-10-17"
      Policies:
        # CodePipeline seems to need access to special buckets
        - PolicyDocument:
            Statement:
              - Action:
                  - s3:PutObject
                Effect: Allow
                Resource:
                  - arn:aws:s3:::codepipeline*
            Version: "2012-10-17"
          PolicyName: GenericCodePipelineS3PutPolicy
        # Let CodePipeline read and write artifacts
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:Get*
                  - s3:Put*
                  - s3:List*
                Resource:
                  - !GetAtt PipelineArtifactStore.Arn
                  - !Sub ${PipelineArtifactStore.Arn}/*
          PolicyName: ArtifactStoreFullAccess
        # To allow the pipeline to use a CodeStar Connection
        - PolicyDocument:
            Statement:
              - Action:
                  - codestar-connections:*
                Condition:
                  "ForAllValues:StringEquals":
                    "codestar-connections:PassedToService": codepipeline.amazonaws.com
                Effect: Allow
                Resource:
                  - !Ref CodeStarConnectionArn
            Version: "2012-10-17"
          PolicyName: CodeStarConnectionPolicy
        # Let CodePipeline describe CloudFormation stacks
        - PolicyName: CloudFormationAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:*
                Resource:
                  - "*" # TODO
                  # - arn:aws:cloudformation:*::type/resource/AWS-IAM-ManagedPolicy
                  # # Add each StackSetName from the pipeline's actions. There
                  # # will be both a root and wildcard resource for each.
                  # - !Sub arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stackset/org-devops-cross-account-access-role
                  # - !Sub arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stackset/org-devops-cross-account-access-role:*
        # Allow PassRole to the CloudFormation role
        - PolicyDocument:
            Statement:
              - Action:
                  - iam:PassRole
                Effect: Allow
                Resource:
                  - !GetAtt DevopsCrossAccountAccessRoleStackCloudFormationRole.Arn
                  - !GetAtt CloudWatchDataSharingRoleStackCloudFormationRole.Arn
                  - !GetAtt CloudWatchSharingListAccountsRoleStackCloudFormationRole.Arn
                  - !GetAtt OrganizationDataSharingRoleStackCloudFormationRole.Arn
            Version: "2012-10-17"
          PolicyName: IamPassRole
        # Allows the pipeline to invoke custom actions
        - PolicyName: LambdaPipelineActionPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - lambda:ListFunctions
                Effect: Allow
                Resource: "*"
              - Action:
                  - lambda:InvokeFunction
                Effect: Allow
                Resource:
                  - !GetAtt DeploymentNotificationFunction.Arn
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      ArtifactStore:
        Location: !Ref PipelineArtifactStore
        Type: S3
      RoleArn: !GetAtt PipelineIamRole.Arn
      Stages:
        - Name: Source
          Actions:
            - Name: InfrastructureRepo
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: "1"
              Configuration:
                ConnectionArn: !Ref CodeStarConnectionArn
                FullRepositoryId: PRX/Infrastructure
                BranchName: master
                OutputArtifactFormat: CODE_ZIP
              Namespace: infrastructure_repo
              OutputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
        - Name: Deploy
          Actions:
            # DevOps cross-account access role stack set
            - Name: DevopsCrossAccountAccessRoleStackSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-devops-cross-account-access-role
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to add the CloudWatch-CrossAccountSharingRole IAM role to each account,
                  which provides read-only access to that account's CloudWatch data.
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-cross-account-access-role.yml
                Parameters: !Sub ParameterKey=OrganizationId,ParameterValue=${OrganizationId}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref Region
                FailureTolerancePercentage: 0
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # DevOps cross-account access role stack (for management account)
            - Name: DevopsCrossAccountAccessRoleStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}DevopsCrossAccountAccessRoleStack
                ParameterOverrides: !Sub |
                  {
                    "OrganizationId": "${OrganizationId}"
                  }
                RoleArn: !GetAtt DevopsCrossAccountAccessRoleStackCloudFormationRole.Arn
                StackName: !Sub ${AWS::StackName}-devops-cross-account-access-role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/devops-cross-account-access-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudWatch cross-account data sharing role stack set
            - Name: CloudWatchDataSharingRoleStackSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormationStackSet
                Version: "1"
              Configuration:
                StackSetName: org-cloudwatch-data-sharing-role
                Capabilities: CAPABILITY_NAMED_IAM
                Description: >-
                  Launches a stack in one region in each account in an AWS Organization
                  to add the CloudWatch-CrossAccountSharingRole IAM role to each account,
                  which provides read-only access to that account's CloudWatch data.
                TemplatePath: InfrastructureRepoSourceArtifact::etc/cloudwatch-data-sharing-role.yml
                Parameters: !Sub ParameterKey=OrganizationId,ParameterValue=${OrganizationId}
                PermissionModel: SERVICE_MANAGED
                OrganizationsAutoDeployment: EnabledWithStackRetention
                DeploymentTargets: !Ref OrganizationRootId
                Regions: !Ref Region
                FailureTolerancePercentage: 0
                MaxConcurrentPercentage: 100
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudWatch cross-account data sharing role stack for management account
            - Name: CloudWatchDataSharingRoleStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}CloudWatchDataSharingRoleStack
                ParameterOverrides: !Sub |
                  {
                    "OrganizationId": "${OrganizationId}"
                  }
                RoleArn: !GetAtt CloudWatchDataSharingRoleStackCloudFormationRole.Arn
                StackName: !Sub ${AWS::StackName}-cloudwatch-data-sharing-role
                TemplatePath: InfrastructureRepoSourceArtifact::etc/cloudwatch-data-sharing-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # CloudWatch cross-account sharing list accounts role stack for management account
            - Name: CloudWatchSharingListAccountsRoleStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}CloudWatchSharingListAccountsRoleStack
                ParameterOverrides: !Sub |
                  {
                    "MonitoringAccountIds": "${CloudWatchMonitoringAccountIds}"
                  }
                RoleArn: !GetAtt CloudWatchSharingListAccountsRoleStackCloudFormationRole.Arn
                StackName: cloudwatch-sharing-list-accounts-role
                TemplatePath: InfrastructureRepoSourceArtifact::etc/cloudwatch-data-sharing-org-list-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # Organization data sharing role for management account
            - Name: OrganizationDataSharingRoleStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: "1"
              Configuration:
                ActionMode: CREATE_UPDATE
                Capabilities: CAPABILITY_NAMED_IAM,CAPABILITY_AUTO_EXPAND
                ChangeSetName: !Sub ${AWS::StackName}OrganizationDataSharingRoleStack
                ParameterOverrides: !Sub |
                  {
                    "OrganizationId": "${OrganizationId}"
                  }
                RoleArn: !GetAtt OrganizationDataSharingRoleStackCloudFormationRole.Arn
                StackName: organization-data-sharing-role
                TemplatePath: InfrastructureRepoSourceArtifact::devops/aws-management/organization-cross-account-sharing-role.yml
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            # Root account activity monitor
            # - Name: RootAccountActivityMonitorStackSet
            #   ActionTypeId:
            #     Category: Deploy
            #     Owner: AWS
            #     Provider: CloudFormationStackSet
            #     Version: "1"
            #   Configuration:
            #     StackSetName: org-root-account-activity-monitor
            #     Capabilities: CAPABILITY_IAM
            #     Description: >-
            #       Launches a root account activity monitor in one region in each account
            #       in an AWS Organization. An activity monitor can monitor activity in all
            #       regions in the account it belongs to.
            #     TemplatePath: InfrastructureRepoSourceArtifact::etc/root-account-activity-monitor.yml
            #     Parameters: !Sub ParameterKey=SlackMessageRelayTopicArn,ParameterValue=${SlackMessageRelayTopicArn}
            #     PermissionModel: SERVICE_MANAGED
            #     OrganizationsAutoDeployment: EnabledWithStackRetention
            #     # DeploymentTargets:
            #     Regions: !Ref Region
            #     FailureTolerancePercentage: 0
            #     MaxConcurrentPercentage: 100
            #   InputArtifacts:
            #     - Name: InfrastructureRepoSourceArtifact
            #   RunOrder: 1
        - Name: Notify
          Actions:
            - Name: DeploymentNotification
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Provider: Lambda
                Version: "1"
              Configuration:
                FunctionName: !Ref DeploymentNotificationFunction
              RunOrder: 1
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
  DevopsCrossAccountAccessRoleStackCloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: ResourceManipulationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:AttachRolePolicy
                  - iam:CreatePolicy
                  - iam:CreatePolicyVersion
                  - iam:CreateRole
                  - iam:DeletePolicy
                  - iam:DeletePolicyVersion
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:Get*
                  - iam:List*
                  - iam:PutRolePolicy
                  - iam:SetDefaultPolicyVersion
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Resource: "*"
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
  CloudWatchDataSharingRoleStackCloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: ResourceManipulationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:AttachRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:Get*
                  - iam:List*
                  - iam:PutRolePolicy
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Resource: "*"
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
  CloudWatchSharingListAccountsRoleStackCloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: ResourceManipulationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:AttachRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:Get*
                  - iam:List*
                  - iam:PutRolePolicy
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Resource: "*"
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
  OrganizationDataSharingRoleStackCloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: ResourceManipulationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:AttachRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:DetachRolePolicy
                  - iam:Get*
                  - iam:List*
                  - iam:PutRolePolicy
                  - iam:Tag*
                  - iam:Untag*
                  - iam:UpdateAssumeRolePolicy
                  - iam:UpdateRole
                  - iam:UpdateRoleDescription
                Resource: "*"
      Tags:
        - Key: Project
          Value: Infrastructure
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
  SlackRelaySnsPublishOnlyAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sns:Publish
            Effect: Allow
            Resource:
              - !Ref SlackMessageRelayTopicArn
  DeploymentNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Sends a message when DevOps pipeline completes
      Environment:
        Variables:
          SLACK_MESSAGE_RELAY_TOPIC_ARN: !Ref SlackMessageRelayTopicArn
      Handler: index.handler
      InlineCode: |
        const AWS = require('aws-sdk');

        const sns = new AWS.SNS({ apiVersion: '2010-03-31' });

        exports.handler = async (event) => {
          console.log(JSON.stringify(event));
          await sns
            .publish({
              TopicArn: process.env.SLACK_MESSAGE_RELAY_TOPIC_ARN,
              Message: JSON.stringify({
                channel: '#ops-deploys',
                username: 'AWS CodePipeline',
                icon_emoji: ':ops-codepipeline:',
                text: 'DevOps pipeline deploy complete'
              }),
            })
            .promise();
        };
      MemorySize: 128
      Policies:
        - !Ref SlackRelaySnsPublishOnlyAccessPolicy
      Runtime: nodejs12.x
      Tags:
        Project: Infrastructure
        "prx:cloudformation:stack-name": !Ref AWS::StackName
        "prx:cloudformation:stack-id": !Ref AWS::StackId
      Timeout: 3
  DeploymentNotificationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${DeploymentNotificationFunction}
      RetentionInDays: 14
