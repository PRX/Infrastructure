# devops/aws-management/github-oidc-role.yml
AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  FullRepoName:
    Type: String
    Default: PRX/Infrastructure

Resources:
  GitHubOidc:
    Type: AWS::IAM::OIDCProvider
    Properties:
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1
      Url: https://token.actions.githubusercontent.com

  # Allows read-only access to all services that GitHub actions interact with,
  # either directly, or through something like CloudFormation
  OidcReadOnlyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows read only access services needed for GitHub actions
      PolicyDocument:
        Statement:
          - Action:
              - codebuild:Get*
              - codebuild:List*
              - codepipeline:Get*
              - codepipeline:List*
              - ecr:Describe*
              - ecr:Get*
              - ecr:List*
              - events:Describe*
              - events:List*
              - iam:Get*
              - iam:List*
              - lambda:Get*
              - lambda:List*
              - logs:Describe*
              - logs:Get*
              - logs:List*
              - route53:Get*
              - route53:List*
              - s3:Describe*
              - s3:Get*
              - s3:List*
            Effect: Allow
            Resource: "*"
            Sid: AllowGlobalReadOnly
        Version: "2012-10-17"

  # Allows global (all resources) access for specific actions that are
  # generally considered safe
  OidcSafeActionGlobalAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows access to specific actions needed by GitHub OIDC
      PolicyDocument:
        Statement:
          - Action:
              # Allows GitHub actions to start execution of any CodePipeline
              - codepipeline:StartPipelineExecution
            Effect: Allow
            Resource: "*"
            Sid: AllowGlobalAccess
        Version: "2012-10-17"

  # Allows GitHub actions to interact directly with certain CloudFormation
  # stacks, in order to deploy updates to those stacks
  OidcCloudFormationPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows access to specific actions needed by GitHub OIDC
      PolicyDocument:
        Statement:
          - Action: cloudformation:*
            Effect: Allow
            Resource: arn:aws:cloudformation:*:aws:transform/Serverless-2016-10-31
            Sid: AllowServerlessTransformFullAccess
          - Action:
              - cloudformation:CreateChangeSet
              - cloudformation:DeleteChangeSet
              - cloudformation:ExecuteChangeSet
              - cloudformation:UpdateStack
            Effect: Allow
            Resource:
              # List the ARN of each CloudFormation stack being deployed via
              # GitHub actions
              - arn:aws:cloudformation:*:*:stack/porter-cd-pipeline/*
              - arn:aws:cloudformation:us-east-2:048723829744:stack/management-cd/*
              - arn:aws:cloudformation:us-east-1:561178107736:stack/hostedzone-radiotopia-com/*
              - arn:aws:cloudformation:us-east-1:561178107736:stack/hostedzone-earhustlesq-com/*
              - arn:aws:cloudformation:us-east-1:561178107736:stack/hostedzone-trax-fm/*
              - arn:aws:cloudformation:us-east-1:838846856186:stack/hostedzone-publicfeeds-net/*
            Sid: AllowStackUpdates
        Version: "2012-10-17"

  Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringLike:
                # Allows only actions in this repository to assume the role
                token.actions.githubusercontent.com:sub: !Sub repo:${FullRepoName}:*
            Effect: Allow
            Principal:
              Federated: !Ref GitHubOidc
      ManagedPolicyArns:
        - !Ref OidcReadOnlyPolicy
        - !Ref OidcSafeActionGlobalAccessPolicy
        - !Ref OidcCloudFormationPolicy
      RoleName: DevOps-GitHubOidcFederatedRole

  # Allows CloudFormation deploys initiated via GitHub actions to manage the
  # subset of resources contained within those CloudFormation stacks.
  #
  # In order to prevent this policy from becoming too powerful, given that it
  # will ultimately be used by an external service, it purposefuly excludes
  # some permissions that may be required to provide complete coverage of the
  # CloudFormation deploys. For example, it does not include
  # `route53:DeleteHostedZone`, even though there are stacks within GitHub
  # actions that could theoretically delete a hosted zone. This is forces those
  # more dangerous/destructive updates to happen somewhere other than GitHub
  # actions.
  #
  # In general, this role still has a significant number of privileges for a
  # wildcard set of resources and should be treated with care.
  #
  # It is an inline policy, rather than a managed policy, becuase of the larger
  # character limit on inline policies.
  CloudFormationResourceManipulationPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ecr:DeleteLifecyclePolicy
              - ecr:DeleteRepositoryPolicy
              - ecr:PutLifecyclePolicy
              - ecr:PutReplicationConfiguration
              - ecr:SetRepositoryPolicy
              - ecr:TagResource
              - ecr:UntagResource

              - route53:ChangeResourceRecordSets
              - route53:ChangeTagsForResource
              - route53:CreateHealthCheck
              - route53:CreateTrafficPolicy
              - route53:CreateTrafficPolicyInstance
              - route53:DeleteHealthCheck
              - route53:DeleteTrafficPolicy
              - route53:DeleteTrafficPolicyInstance
              - route53:UpdateHealthCheck
              - route53:UpdateHostedZoneComment
              - route53:UpdateTrafficPolicyComment
              - route53:UpdateTrafficPolicyInstance
            Condition:
              StringEquals:
                # This ensures that the role only makes Route 53 changes via
                # CloudFormation, which ensures that only hosted zones managed
                # by the stacks listed above can be altered.
                aws:CalledViaFirst: cloudformation.amazonaws.com
            Effect: Allow
            Resource: "*"
            Sid: AllowGlobalResourceUpdates
        Version: "2012-10-17"
      PolicyName: CfnResourceManipulation
      Roles: [!Ref Role]

Outputs:
  RoleArn:
    Value: !GetAtt Role.Arn
