AWSTemplateFormatVersion: "2010-09-09"
Description: Audiogram application running in Docker
Mappings:
  Shared:
    Project:
      name: audiogram
    Container:
      name: server-worker-combined
Conditions:
  CreateStagingResources: !Equals [!Ref EnvironmentType, Staging]
  CreateProductionResources: !Equals [!Ref EnvironmentType, Production]
Parameters:
  VPC:
    Type: "AWS::EC2::VPC::Id"
  # Load Balancer ##############################################################
  PlatformALBDNSName:
    Type: String
  PlatformALBCanonicalHostedZoneID:
    Type: String
  PlatformALBHTTPListenerArn:
    Type: String
  PlatformALBHTTPSListenerArn:
    Type: String
  PlatformALBListenerPriorityPrefix:
    Type: String
  ##############################################################################
  ECSCluster:
    Type: String
  ECSServiceAutoscaleIAMRoleArn:
    Type: String
  ECSServiceIAMRole:
    Type: String
  ##############################################################################
  EnvironmentType:
    Type: String
  EnvironmentTypeAbbreviation:
    Type: String
  OpsDebugMessagesSnsTopicArn:
    Type: String
  EcrRegion:
    Type: String
  SecretsBase:
    Type: String
  ##############################################################################
  AudiogramEcrImageTag:
    Type: String
  AudiogramSecretsVersion:
    Type: String
Resources:
  AudiogramLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      RetentionInDays: 14
  AudiogramALBTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    Properties:
      HealthCheckIntervalSeconds: 60
      UnhealthyThresholdCount: 10
      HealthCheckPath: /
      Name: !Sub audiogram-${EnvironmentTypeAbbreviation}-${VPC}
      Port: 80
      Protocol: HTTP
      Tags:
        - Key: Project
          Value: !FindInMap [Shared, Project, name]
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: Name
          Value: !Sub Audiogram-${EnvironmentType}
      VpcId: !Ref VPC
  # ALB Listener Rules
  AudiogramALBHTTPSHostWildcardListenerRule:
    Type: "AWS::ElasticLoadBalancingV2::ListenerRule"
    Properties:
      Actions:
        - TargetGroupArn: !Ref AudiogramALBTargetGroup
          Type: forward
      Conditions:
        - Field: host-header
          Values:
            - audiogram.*
      ListenerArn: !Ref PlatformALBHTTPSListenerArn
      Priority: !Join ["", [!Ref PlatformALBListenerPriorityPrefix, "00"]]
  AudiogramALBHTTPHostWildcardListenerRule:
    Type: "AWS::ElasticLoadBalancingV2::ListenerRule"
    Properties:
      Actions:
        - TargetGroupArn: !Ref AudiogramALBTargetGroup
          Type: forward
      Conditions:
        - Field: host-header
          Values:
            - audiogram.*
      ListenerArn: !Ref PlatformALBHTTPListenerArn
      Priority: !Join ["", [!Ref PlatformALBListenerPriorityPrefix, "00"]]
  # ECS Service
  AudiogramTaskDefinition:
    Type: "AWS::ECS::TaskDefinition"
    Properties:
      ContainerDefinitions:
        - Command:
            - npm
            - start
          Cpu: 512
          Essential: true
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/audiogram:${AudiogramEcrImageTag}
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref AudiogramLogGroup
              awslogs-region: !Ref AWS::Region
          Memory: 384
          Name: !FindInMap [Shared, Container, name]
          PortMappings:
            - HostPort: 0
              ContainerPort: 8888
  AudiogramService:
    Type: "AWS::ECS::Service"
    Properties:
      Cluster: !Ref ECSCluster
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      DesiredCount: 1
      LoadBalancers:
        - ContainerName: !FindInMap [Shared, Container, name]
          ContainerPort: 8888
          TargetGroupArn: !Ref AudiogramALBTargetGroup
      Role: !Ref ECSServiceIAMRole
      TaskDefinition: !Ref AudiogramTaskDefinition
  AudiogramWebRecordSetGroup:
    Type: "AWS::Route53::RecordSetGroup"
    Properties:
      Comment: Record sets for dualstack web traffic to an audiogram instance
      HostedZoneName: prx.tech.
      RecordSets:
        - Type: AAAA
          Name: !Sub |
            audiogram.${EnvironmentTypeAbbreviation}-${VPC}.prx.tech.
          AliasTarget:
            DNSName: !Ref PlatformALBDNSName
            HostedZoneId: !Ref PlatformALBCanonicalHostedZoneID
        - Type: A
          Name: !Sub |
            audiogram.${EnvironmentTypeAbbreviation}-${VPC}.prx.tech.
          AliasTarget:
            DNSName: !Ref PlatformALBDNSName
            HostedZoneId: !Ref PlatformALBCanonicalHostedZoneID
  # AudiogramScalableTarget:
  #   Type: "AWS::ApplicationAutoScaling::ScalableTarget"
  #   Properties:
  #     MaxCapacity: 5
  #     MinCapacity: 1
  #     ResourceId: !Join ["/", ["service", !Ref ECSCluster, !GetAtt AudiogramService.Name]]
  #     RoleARN: !Ref ECSServiceAutoscaleIAMRoleArn
  #     ScalableDimension: "ecs:service:DesiredCount"
  #     ServiceNamespace: ecs
  # AudiogramScaleOutPolicy:
  #   Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
  #   Properties:
  #     PolicyName: AudiogramScaleOutPolicy
  #     PolicyType: StepScaling
  #     ScalingTargetId: !Ref AudiogramScalableTarget
  #     StepScalingPolicyConfiguration:
  #       AdjustmentType: ChangeInCapacity
  #       Cooldown: 60
  #       MetricAggregationType: Average
  #       StepAdjustments:
  #         - MetricIntervalLowerBound: 0
  #           MetricIntervalUpperBound: 25
  #           ScalingAdjustment: 1
  #         - MetricIntervalLowerBound: 25
  #           ScalingAdjustment: 2
  # AudiogramScaleInPolicy:
  #   Type: "AWS::ApplicationAutoScaling::ScalingPolicy"
  #   Properties:
  #     PolicyName: AudiogramScaleInPolicy
  #     PolicyType: StepScaling
  #     ScalingTargetId: !Ref AudiogramScalableTarget
  #     StepScalingPolicyConfiguration:
  #       AdjustmentType: ChangeInCapacity
  #       Cooldown: 60
  #       MetricAggregationType: Average
  #       StepAdjustments:
  #         - MetricIntervalUpperBound: 0
  #           ScalingAdjustment: -1
  # AudiogramScaleOutAlarm:
  #   Type: "AWS::CloudWatch::Alarm"
  #   Properties:
  #     ActionsEnabled: true
  #     AlarmActions:
  #       - !Ref AudiogramScaleOutPolicy
  #       - !Ref OpsDebugMessagesSnsTopicArn
  #     AlarmDescription: >
  #       The CPU utilization of the service has exceeded 50% for more than
  #       one minute. Breaching this alarm should trigger a service scale out.
  #     ComparisonOperator: GreaterThanOrEqualToThreshold
  #     Dimensions:
  #       - Name: ClusterName
  #         Value: !Ref ECSCluster
  #       - Name: ServiceName
  #         Value: !GetAtt AudiogramService.Name
  #     EvaluationPeriods: "1"
  #     MetricName: CPUUtilization
  #     Namespace: AWS/ECS
  #     Period: "60"
  #     Statistic: Average
  #     Threshold: "50"
  #     Unit: Percent
  # AudiogramScaleInAlarm:
  #   Type: "AWS::CloudWatch::Alarm"
  #   Properties:
  #     ActionsEnabled: true
  #     AlarmActions:
  #       - !Ref AudiogramScaleInPolicy
  #       - !Ref OpsDebugMessagesSnsTopicArn
  #     AlarmDescription: >
  #       The CPU utilization of the service has dropped below 10% for more than
  #       five minutes. Breaching this alarm should trigger a service scale in.
  #     ComparisonOperator: LessThanOrEqualToThreshold
  #     Dimensions:
  #       - Name: ClusterName
  #         Value: !Ref ECSCluster
  #       - Name: ServiceName
  #         Value: !GetAtt AudiogramService.Name
  #     EvaluationPeriods: "5"
  #     MetricName: CPUUtilization
  #     Namespace: AWS/ECS
  #     Period: "60"
  #     Statistic: Average
  #     Threshold: "10"
  #     Unit: Percent
  # AudiogramHTTP500Alarm:
    # Type: "AWS::CloudWatch::Alarm"
    # Properties:
      # Statistic: Sum
Outputs:
  HostedZoneDNSName:
    Description: Convenience domain name for the ALB in a hosted zone
    Value: !Sub |
      audiogram.${EnvironmentTypeAbbreviation}-${VPC}.prx.tech.
