AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Creates a CloudFront distribution for radio.radiotopia.fm, which is backed by
  GitHub Pages
Parameters:
  RadiotopiaCertificateArn:
    Type: String
Resources:
  # CloudFront
  CloudFrontDistribution:
    Type: "AWS::CloudFront::Distribution"
    Properties:
      DistributionConfig:
        Aliases:
          - "radio2.radiotopia.fm"
        DefaultCacheBehavior:
          AllowedMethods:
            - HEAD
            - GET
          CachedMethods:
            - HEAD
            - GET
          Compress: true
          ForwardedValues:
            QueryString: false
          TargetOriginId: GitHub-Pages
          ViewerProtocolPolicy : redirect-to-https
        DefaultRootObject: "index.html"
        Enabled: true
        HttpVersion: http2
        Origins:
          - CustomOriginConfig:
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
              OriginSSLProtocols:
                - TLSv1.2
                - TLSv1.1
                - TLSv1
            OriginProtocolPolicy:
            DomainName: prx.github.io
            Id: GitHub-Pages
            OriginPath: "/radio.radiotopia.fm"
        PriceClass: PriceClass_All
        ViewerCertificate:
          AcmCertificateArn: !Ref RadiotopiaCertificateArn
          SslSupportMethod: sni-only
  # Route 53
  RecordSetGroup:
    Type: "AWS::Route53::RecordSetGroup"
    Properties:
      Comment: Record set for radio.radiotopia.fm
      HostedZoneName: radiotopia.fm.
      RecordSets:
        - Type: A
          Name: radio2.radiotopia.fm
          AliasTarget:
            DNSName: !GetAtt CloudFrontDistribution.DomainName
            HostedZoneId: Z2FDTNDATAQYW2
        - Type: AAAA
          Name: radio2.radiotopia.fm
          AliasTarget:
            DNSName: !GetAtt CloudFrontDistribution.DomainName
            HostedZoneId: Z2FDTNDATAQYW2
