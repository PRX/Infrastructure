AWSTemplateFormatVersion: "2010-09-09"
Description: dovetail.prx.org application running in Docker
Conditions:
  CreateStagingResources: !Equals [!Ref EnvironmentType, Staging]
  CreateProductionResources: !Equals [!Ref EnvironmentType, Production]
Parameters:
  # VPC ########################################################################
  VPC:
    Type: "AWS::EC2::VPC::Id"
  VPCSubnet1:
    Type: "AWS::EC2::Subnet::Id"
  VPCSubnet2:
    Type: "AWS::EC2::Subnet::Id"
  VPCSubnet3:
    Type: "AWS::EC2::Subnet::Id"
  VPCCertificateArn:
    Type: String
  # ECS Cluster ################################################################
  ECSCluster:
    Type: String
  ECSServiceAutoscaleIAMRoleArn:
    Type: String
  ECSServiceIAMRole:
    Type: String
  # Misc #######################################################################
  OpsDebugMessagesSnsTopicArn:
    Type: String
  OpsErrorMessagesSnsTopicArn:
    Type: String
  EnvironmentType:
    Type: String
  EnvironmentTypeAbbreviation:
    Type: String
  EcrRegion:
    Type: String
  SecretsBase:
    Type: String
  PipelineExecutionNonce:
    Type: String
  # Dovetail ###################################################################
  DovetailEcrImageTag:
    Type: String
  DovetailSecretsVersion:
    Type: String
Mappings:
  EnvironmentTypeMap:
    Testing:
      DovetailCount: 1
      ProxyCount: 1
    Staging:
      DovetailCount: 2
      ProxyCount: 2
    Production:
      DovetailCount: 10
      ProxyCount: 4
Resources:
  DovetailSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Allow web and SSH traffic to the ALB
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
        - CidrIp: 0.0.0.0/0
          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
      Tags:
        - Key: Project
          Value: Dovetail
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: Name
          Value: !Sub Dovetail-${EnvironmentType}-LB-web_ssh
  DovetailALB:
    Type: "AWS::ElasticLoadBalancingV2::LoadBalancer"
    Properties:
      # IpAddressType: dualstack
      Scheme: internet-facing
      SecurityGroups:
        - !Ref DovetailSecurityGroup
      Subnets:
        - !Ref VPCSubnet1
        - !Ref VPCSubnet2
        - !Ref VPCSubnet3
      Tags:
        - Key: Project
          Value: Dovetail
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: Name
          Value: !Sub Dovetail-${EnvironmentType}
  DovetailALBHTTPListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      LoadBalancerArn: !Ref DovetailALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref DovetailDeuxALBTargetGroup
  DovetailProxyALBHTTPListenerRule:
    Type: "AWS::ElasticLoadBalancingV2::ListenerRule"
    Properties:
      Actions:
        - TargetGroupArn: !Ref DovetailProxyALBTargetGroup
          Type: forward
      Conditions:
        - Field: path-pattern
          Values:
            - /+/*
      ListenerArn: !Ref DovetailALBHTTPListener
      Priority: 10
  DovetailALBHTTPSListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      Certificates:
        - CertificateArn: !Ref VPCCertificateArn
      LoadBalancerArn: !Ref DovetailALB
      Port: 443
      Protocol: HTTPS
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref DovetailDeuxALBTargetGroup
  DovetailProxyALBHTTPSListenerRule:
    Type: "AWS::ElasticLoadBalancingV2::ListenerRule"
    Properties:
      Actions:
        - TargetGroupArn: !Ref DovetailProxyALBTargetGroup
          Type: forward
      Conditions:
        - Field: path-pattern
          Values:
            - /+/*
      ListenerArn: !Ref DovetailALBHTTPSListener
      Priority: 10
  DovetailDeuxALBTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    DependsOn: DovetailALB
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      HealthCheckPath: /ping
      Name: !Sub dovetail-deux-${EnvironmentTypeAbbreviation}-${VPC}
      Port: 80
      Protocol: HTTP
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 20
      Tags:
        - Key: Project
          Value: Dovetail
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: Name
          Value: !Sub DovetailDeux-${EnvironmentType}
      VpcId: !Ref VPC
  DovetailProxyALBTargetGroup:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    DependsOn: DovetailALB
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 10
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 5
      HealthCheckPath: /ping
      Name: !Sub dovetail-proxy-${EnvironmentTypeAbbreviation}-${VPC}
      Port: 80
      Protocol: HTTP
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 30
      Tags:
        - Key: Project
          Value: Dovetail
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: Name
          Value: !Sub Dovetail-Proxy-${EnvironmentType}
      VpcId: !Ref VPC
  DovetailLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      RetentionInDays: 14
  DovetailProxyLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      RetentionInDays: 14
  DovetailTaskDefinition:
    Type: "AWS::ECS::TaskDefinition"
    Properties:
      ContainerDefinitions:
        - Cpu: 700
          Environment:
            - Name: APP_NAME
              Value: "dovetail"
            - Name: APP_ENV
              Value: !Ref EnvironmentTypeAbbreviation
            - Name: AWS_SECRETS_BASE
              Value: !Ref SecretsBase
            - Name: AWS_SECRETS_VERSION
              Value: !Ref DovetailSecretsVersion
            - Name: AWS_DEFAULT_REGION
              Value: !Ref AWS::Region
          Essential: true
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/dovetail.prx.org:${DovetailEcrImageTag}
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref DovetailLogGroup
              awslogs-region: !Ref AWS::Region
          Memory: 600
          Name: "dovetail-express"
          PortMappings:
            - HostPort: 0
              ContainerPort: 8080
  DovetailProxyTaskDefinition:
    Type: "AWS::ECS::TaskDefinition"
    Properties:
      ContainerDefinitions:
        - Cpu: 256
          Environment:
            - Name: CACHE_INACTIVE
              Value: "48h"
            - Name: CACHE_MAX_SIZE
              Value: "20g"
            - Name: DOVETAIL_HOST
              Value: !Sub dovetail.${EnvironmentTypeAbbreviation}-${VPC}.prx.tech
            - Name: RESOLVER
              Value: "8.8.8.8" # TODO does 172.16.0.23 work in this VPC?
            - Name: STITCH_VALID
              Value: "48h"
          Essential: true
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/dovetail.proxy:latest
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref DovetailProxyLogGroup
              awslogs-region: !Ref AWS::Region
          Memory: 1000
          Name: "dovetail-nginx"
          PortMappings:
            - HostPort: 0
              ContainerPort: 80
  DovetailDeuxService:
    Type: "AWS::ECS::Service"
    DependsOn:
      - DovetailALBHTTPListener
      - DovetailALBHTTPSListener
    Properties:
      Cluster: !Ref ECSCluster
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      DesiredCount: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, DovetailCount]
      LoadBalancers:
        - ContainerName: "dovetail-express"
          ContainerPort: 8080
          TargetGroupArn: !Ref DovetailDeuxALBTargetGroup
      Role: !Ref ECSServiceIAMRole
      TaskDefinition: !Ref DovetailTaskDefinition
  DovetailProxyService:
    Type: "AWS::ECS::Service"
    DependsOn:
      - DovetailALBHTTPListener
      - DovetailALBHTTPSListener
    Properties:
      Cluster: !Ref ECSCluster
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      PlacementConstraints:
        - Type: "distinctInstance"
      DesiredCount: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, ProxyCount]
      LoadBalancers:
        - ContainerName: "dovetail-nginx"
          ContainerPort: 80
          TargetGroupArn: !Ref DovetailProxyALBTargetGroup
      Role: !Ref ECSServiceIAMRole
      TaskDefinition: !Ref DovetailProxyTaskDefinition
  DovetailWebRecordSetGroup:
    Type: "AWS::Route53::RecordSetGroup"
    DependsOn: DovetailALB
    Properties:
      Comment: Record sets for dualstack web traffic to a dovetail instance
      HostedZoneName: prx.tech.
      RecordSets:
        - Type: A
          Name: !Sub dovetail.${EnvironmentTypeAbbreviation}-${VPC}.prx.tech.
          AliasTarget:
            DNSName: !Sub dualstack.${DovetailALB.DNSName}
            HostedZoneId: !GetAtt DovetailALB.CanonicalHostedZoneID
  DovetailALBTarget500Alarm:
    Type: "AWS::CloudWatch::Alarm"
    Condition: CreateProductionResources
    Properties:
      ActionsEnabled: true
      AlarmName: Dovetail Server 5XXs
      AlarmActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      InsufficientDataActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      OKActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      AlarmDescription: >
        5XX server errors originating from the dovetail application
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: "1"
      MetricName: HTTPCode_Target_5XX_Count
      Namespace: AWS/ApplicationELB
      Period: "60"
      Statistic: Sum
      Threshold: "0"
      TreatMissingData: notBreaching
      Dimensions:
        - Name: LoadBalancer
          Value: !GetAtt DovetailALB.LoadBalancerFullName
  DovetailALB500Alarm:
    Type: "AWS::CloudWatch::Alarm"
    Condition: CreateProductionResources
    Properties:
      ActionsEnabled: true
      AlarmName: Dovetail Load Balancer 5XXs
      AlarmActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      InsufficientDataActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      OKActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      AlarmDescription: >
        5XX load balancer errors originating from the dovetail load balancer
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: "2"
      MetricName: HTTPCode_ELB_5XX_Count
      Namespace: AWS/ApplicationELB
      Period: "60"
      Statistic: Sum
      Threshold: "5"
      TreatMissingData: notBreaching
      Dimensions:
        - Name: LoadBalancer
          Value: !GetAtt DovetailALB.LoadBalancerFullName
  # Config Persistence
  DovetailServiceDesiredCountRolloverIamRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        - PolicyName: EcsServicesPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "ecs:DescribeServices"
                Resource:
                  - "*"
                  # - !Sub ${AWS::StackName}-DovetailService TODO
  DovetailServiceDesiredCountRolloverLambdaFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      Code:
        S3Bucket:
          Fn::ImportValue:
            !Sub ${InfrastructureStorageStackName}-InfrastructureSupportBucket
        S3Key: utility/ecs-service-size-rollover.zip
      Description: Allows for DesiredCount persistence on ECS services
      Handler: index.handler
      MemorySize: 128
      Role: !GetAtt LambdaExecutionIAMRole.Arn
      Runtime: nodejs6.10
      Tags:
        - Key: Project
          Value: Infrastructure
      Timeout: 8
Outputs:
  HostedZoneDNSName:
    Description: Convenience domain name for the ALB in a hosted zone
    Value: !Sub |
      dovetail.${EnvironmentTypeAbbreviation}-${VPC}.prx.tech.
