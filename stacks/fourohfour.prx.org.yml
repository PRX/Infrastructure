AWSTemplateFormatVersion: "2010-09-09"
Description: fourohfour.prx.org application running in Docker
Mappings:
  Shared:
    Project:
      name: fourohfour.prx.org
    Container:
      name: fourohfour-express
Conditions:
  CreateStagingResources: !Equals [!Ref EnvironmentType, Staging]
  CreateProductionResources: !Equals [!Ref EnvironmentType, Production]
Parameters:
  # VPC ########################################################################
  VPC:
    Type: "AWS::EC2::VPC::Id"
  # Load Balancer ##############################################################
  PlatformALBDNSName:
    Type: String
  PlatformALBFullName:
    Type: String
  PlatformALBCanonicalHostedZoneID:
    Type: String
  PlatformALBDefaultTargetGroupArn:
    Type: String
  PlatformALBHTTPListenerArn:
    Type: String
  PlatformALBHTTPSListenerArn:
    Type: String
  PlatformALBListenerPriorityPrefix:
    Type: String
  # ECS Cluster ################################################################
  ECSCluster:
    Type: String
  ECSServiceAutoscaleIAMRoleArn:
    Type: String
  ECSServiceIAMRole:
    Type: String
  # Misc #######################################################################
  OpsDebugMessagesSnsTopicArn:
    Type: String
  OpsErrorMessagesSnsTopicArn:
    Type: String
  EnvironmentType:
    Type: String
  EnvironmentTypeAbbreviation:
    Type: String
  EcrRegion:
    Type: String
  SecretsBase:
    Type: String
  # Shared ENV #################################################################
  # Play ECS ################################################################
  FourohfourEcrImageTag:
    Type: String
  # Play ENV ################################################################
  FourohfourSecretsVersion:
    Type: String
Resources:
  FourohfourLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      RetentionInDays: 14
  # ECS Service
  FourohfourTaskDefinition:
    Type: "AWS::ECS::TaskDefinition"
    Properties:
      ContainerDefinitions:
        - Cpu: 16
          Environment:
            - Name: APP_NAME
              Value: "fourohfour"
            - Name: APP_ENV
              Value: !Ref EnvironmentTypeAbbreviation
            - Name: AWS_DEFAULT_REGION
              Value: !Ref AWS::Region
          Essential: true
          # TODO
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${EcrRegion}.amazonaws.com/fourohfour.prx.org:${PlayEcrImageTag}
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref FourohfourLogGroup
              awslogs-region: !Ref AWS::Region
          Memory: 128
          Name: !FindInMap [Shared, Container, name]
          PortMappings:
            - HostPort: 0
              ContainerPort: 4040
  FourohfourService:
    Type: "AWS::ECS::Service"
    Properties:
      Cluster: !Ref ECSCluster
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 50
      DesiredCount: 1
      LoadBalancers:
        - ContainerName: !FindInMap [Shared, Container, name]
          ContainerPort: 4040
          TargetGroupArn: !Ref PlatformALBDefaultTargetGroupArn
      Role: !Ref ECSServiceIAMRole
      TaskDefinition: !Ref FourohfourTaskDefinition
