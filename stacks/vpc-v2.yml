AWSTemplateFormatVersion: "2010-09-09"

Description: >-
  Creates a VPC with private and public subnets in three
  availability zones.

Parameters:
  EnvironmentType:
    Type: String
  TemplateUrlPrefix:
    Type: String
  CloudFormationNotificationArn:
    Type: String

Conditions:
  IsProduction: !Equals [!Ref EnvironmentType, Production]

Resources:
  Vpc:
    Type: AWS::EC2::VPC
    # TODO Deletion and UpdateReplace policies
    Properties:
      # TODO Needs to be more dynamic or a parameter
      CidrBlock: !If
        - IsProduction
        - 172.30.0.0/16
        - 10.30.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      InstanceTenancy: default
      Tags:
        - Key: Project
          Value: platform.prx.org
        - Key: Name
          Value: !Sub ${AWS::StackName}-VPC # TODO Needs a better name
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
  IPv6VpcCidrBlock:
    Type: AWS::EC2::VPCCidrBlock
    Properties:
      AmazonProvidedIpv6CidrBlock: true
      VpcId: !Ref Vpc

  # DHCP
  DhcpOptions:
    Type: AWS::EC2::DHCPOptions
    Properties:
      DomainName: ec2.internal
      DomainNameServers:
        - AmazonProvidedDNS
      Tags:
        - Key: Project
          Value: platform.prx.org
        - Key: Name
          Value: !Sub ${AWS::StackName}-DhcpOptions #TODO Better name
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
  DhcpOptionsAssociation:
    Type: AWS::EC2::VPCDHCPOptionsAssociation
    Properties:
      DhcpOptionsId: !Ref DhcpOptions
      VpcId: !Ref Vpc

  PublicSubnetsStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: IPv6VpcCidrBlock
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        VpcId: !Ref Vpc
        VpcCidrBlock: !GetAtt Vpc.CidrBlock
        VpcIpv6CidrBlocks: !Join [",", !GetAtt Vpc.Ipv6CidrBlocks]
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/public-subnets.yml
      TimeoutInMinutes: 5

Outputs:
  VpcId:
    Description: Resource ID for the VPC
    Value: !Ref Vpc
  VpcCidrBlock:
    Description: Resource ID for the VPC
    Value: !GetAtt Vpc.CidrBlock
