# stacks/shared-alb.yml
AWSTemplateFormatVersion: "2010-09-09"

Description: >-
  tktktk

Parameters:
  RootStackName: { Type: String }
  RootStackId: { Type: String }
  SharedEcsClusterName: { Type: String }
  SharedVpcId: { Type: "AWS::EC2::VPC::Id" }
  SharedEcsAsgName: { Type: String }
  SharedAlbName: { Type: String }
  FeederAlbName: { Type: String }
  DovetailAlbName: { Type: String }
  SharedVpcFlowLogsLogGroupName: { Type: String }
  SharedMemcachedCacheName: { Type: String }
  CastleRedisCacheName: { Type: String }
  ProvisionedStackName: { Type: String }

# Conditions:
#   IsProduction: !Equals [!Ref EnvironmentType, Production]

Resources:
  Foo:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody: !Sub |-
        {
            "widgets": [
                {
                    "height": 9,
                    "width": 6,
                    "y": 0,
                    "x": 0,
                    "type": "text",
                    "properties": {
                        "markdown": "\n# AWS Console\n\n- [CloudFormation root stack](https://console.aws.amazon.com/cloudformation/home?region=${AWS::Region}#/stacks/stackinfo?stackId=${RootStackId})\n- [ECS Cluster](https://console.aws.amazon.com/ecs/home?region=${AWS::Region}#/clusters/${SharedEcsClusterName}/services)\n- [Shared VPC](https://console.aws.amazon.com/vpc/home?region=${AWS::Region}#VpcDetails:VpcId=${SharedVpcId}) | [Subnets](https://console.aws.amazon.com/vpc/home?region=${AWS::Region}#subnets:search=${SharedVpcId}) | [NACLs](https://console.aws.amazon.com/vpc/home?region=${AWS::Region}#acls:search=${SharedVpcId}) | [Peering](https://console.aws.amazon.com/vpc/home?region=${AWS::Region}#PeeringConnections:search=${SharedVpcId})\n- [Shared VPC Flow Logs Insights](https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#logsV2:logs-insights$3FqueryDetail$3D$257E$2528end$257E0$257Estart$257E-1800$257EtimeType$257E$2527RELATIVE$257Eunit$257E$2527seconds$257EeditorString$257E$2527fields*20*40timestamp*2c*20action*2c*20interfaceId*2c*20srcAddr*2c*20srcPort*2c*20dstAddr*2c*20dstPort*0a*7c*20sort*20*40timestamp*20desc*0a*7c*20limit*20500$257EisLiveTail$257Efalse$257EqueryId$257E$252738782a19-012d-4a8b-bda2-202bec5ce7e1$257Esource$257E$2528$257E$2527${SharedVpcFlowLogsLogGroupName}$2529$2529)\n- [EC2 Instances](https://console.aws.amazon.com/ec2/v2/home?region=${AWS::Region}#Instances:instanceState=running;search=${SharedVpcId}) | [Shared ASG](https://console.aws.amazon.com/ec2autoscaling/home?region=${AWS::Region}#/details/${SharedEcsAsgName}?view=details) | [Shared ALB](https://console.aws.amazon.com/ec2/v2/home?region=${AWS::Region}#LoadBalancers:search=${SharedAlbName};sort=loadBalancerName)\n- [Dovetail ALB](https://console.aws.amazon.com/ec2/v2/home?region=${AWS::Region}#LoadBalancers:search=${DovetailAlbName};sort=loadBalancerName) | [Feeder ALB](https://console.aws.amazon.com/ec2/v2/home?region=${AWS::Region}#LoadBalancers:search=${FeederAlbName};sort=loadBalancerName)\n- [Shared Memcached](https://console.aws.amazon.com/elasticache/home?region=${AWS::Region}#memcached-detail:id=${SharedMemcachedCacheName}) | [Castle Redis](https://console.aws.amazon.com/elasticache/home?region=${AWS::Region}#redis-group-detail:id=${CastleRedisCacheName})\n- [Provisioned app log groups](https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#logsV2:log-groups$3FlogGroupNameFilter$3D%{ProvisionedStackName})\n"
                    }
                }
            ]
        }
      DashboardName: !Sub ${RootStackName}-${AWS::Region}-Overview
