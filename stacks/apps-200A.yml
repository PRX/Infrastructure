# stacks/provisioned.yml
AWSTemplateFormatVersion: "2010-09-09"

Description: Provisioned apps # TODO

Parameters:
  TemplateUrlPrefix: { Type: String }
  CloudFormationNotificationArn: { Type: String }
  AlbFullName: { Type: String }
  AlbHttpsListenerArn: { Type: String }
  EcsClusterArn: { Type: String }
  EcsClusterName: { Type: String }
  EnvironmentType: { Type: String }
  EnvironmentTypeAbbreviation: { Type: String }
  RootStackName: { Type: String }
  RootStackId: { Type: String }
  VpcId: { Type: "AWS::EC2::VPC::Id" }
  VpcCidrBlock: { Type: String }
  VpcIpv6CidrBlocks: { Type: String }
  SecretsBase: { Type: String }
  EcrRegion: { Type: String }
  SecretsStackName: { Type: String }
  NotificationsStackName: { Type: String }
  VpcPublicSubnet1Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPublicSubnet2Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPublicSubnet3Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet1Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet2Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet3Id: { Type: "AWS::EC2::Subnet::Id" }
  SharedMemcachedEndpointAddress: { Type: String }
  SharedMemcachedEndpointPort: { Type: String }
  AmazonSesSmtpCredentialsGeneratorServiceToken: { Type: String }
  EchoServiceToken: { Type: String }
  EcsLaunchEndpointsAccessSecurityGroupId: { Type: "AWS::EC2::SecurityGroup::Id" }
  KmsEndpointAccessSecurityGroupId: { Type: "AWS::EC2::SecurityGroup::Id" }
  SharedEcsAsgInstanceSecurityGroupId: { Type: "AWS::EC2::SecurityGroup::Id" }
  S3SigningUserName: { Type: String }
  S3SigningEndpointUrl: { Type: String }
  S3SigningAccessKeyId: { Type: String }

  ExchangeEcrImageTag: { Type: String }
  ExchangeSecretsVersion: { Type: String }
  ExchangeSharedAlbListenerRulePriorityPrefix: { Type: String }

  NetworksEcrImageTag: { Type: String }
  NetworksSecretsVersion: { Type: String }
  NetworksSharedAlbListenerRulePriorityPrefix: { Type: String }

  PublishEcrImageTag: { Type: String }
  PublishSecretsVersion: { Type: String }
  PublishSharedAlbListenerRulePriorityPrefix: { Type: String }

Conditions:
  IsStaging: !Equals [!Ref EnvironmentType, Staging]

Resources:
  ExchangeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        EcsClusterName: !Ref EcsClusterName
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref ExchangeEcrImageTag
        SecretsVersion: !Ref ExchangeSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref ExchangeSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        AmazonSesSmtpCredentialsGeneratorServiceToken: !Ref AmazonSesSmtpCredentialsGeneratorServiceToken
        S3SigningEndpointUrl: !Ref S3SigningEndpointUrl
        S3SigningAccessKeyId: !Ref S3SigningAccessKeyId
        SharedMemcachedEndpointAddress: !Ref SharedMemcachedEndpointAddress
        SharedMemcachedEndpointPort: !Ref SharedMemcachedEndpointPort
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Exchange }
      TemplateURL: !Sub ${TemplateUrlPrefix}/exchange.yml
      TimeoutInMinutes: 20

  NetworksStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        VpcCidrBlock: !Ref VpcCidrBlock
        VpcIpv6CidrBlocks: !Ref VpcIpv6CidrBlocks
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref NetworksEcrImageTag
        SecretsVersion: !Ref NetworksSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref NetworksSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        VpcPrivateSubnet1Id: !Ref VpcPrivateSubnet1Id
        VpcPrivateSubnet2Id: !Ref VpcPrivateSubnet2Id
        VpcPrivateSubnet3Id: !Ref VpcPrivateSubnet3Id
        S3SigningEndpointUrl: !Ref S3SigningEndpointUrl
        S3SigningAccessKeyId: !Ref S3SigningAccessKeyId
        SharedMemcachedEndpointAddress: !Ref SharedMemcachedEndpointAddress
        SharedMemcachedEndpointPort: !Ref SharedMemcachedEndpointPort
        EchoServiceToken: !Ref EchoServiceToken
        EcsLaunchEndpointsAccessSecurityGroupId: !Ref EcsLaunchEndpointsAccessSecurityGroupId
        KmsEndpointAccessSecurityGroupId: !Ref KmsEndpointAccessSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Networks }
      TemplateURL: !Sub ${TemplateUrlPrefix}/networks.yml
      TimeoutInMinutes: 20

  PublishStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref PublishEcrImageTag
        SecretsVersion: !Ref PublishSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref PublishSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        S3SigningUserName: !Ref S3SigningUserName
        S3SigningEndpointUrl: !Ref S3SigningEndpointUrl
        S3SigningAccessKeyId: !Ref S3SigningAccessKeyId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Publish }
      TemplateURL: !Sub ${TemplateUrlPrefix}/publish.yml
      TimeoutInMinutes: 20

Outputs:
  StackName:
    Value: !Ref AWS::StackName
