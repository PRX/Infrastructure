# stacks/apps-500A-tmp.yml
AWSTemplateFormatVersion: "2010-09-09"

Description: Temporary stack to test out multi-region dovetail things.

Parameters:
  TemplateUrlPrefix: { Type: String }
  CloudFormationNotificationArn: { Type: String }
  EcsClusterArn: { Type: String }
  EcsClusterName: { Type: String }
  EnvironmentType: { Type: String }
  EnvironmentTypeAbbreviation: { Type: String }
  RootStackName: { Type: String }
  RootStackId: { Type: String }
  VpcId: { Type: AWS::EC2::VPC::Id }
  NewRelicApiKeyPrxLite: { Type: String }
  SecretsBase: { Type: String }
  SecretsStackName: { Type: String }
  VpcPublicSubnet1Id: { Type: AWS::EC2::Subnet::Id }
  VpcPublicSubnet2Id: { Type: AWS::EC2::Subnet::Id }
  VpcPublicSubnet3Id: { Type: AWS::EC2::Subnet::Id }
  VpcPrivateSubnet1Id: { Type: AWS::EC2::Subnet::Id }
  VpcPrivateSubnet2Id: { Type: AWS::EC2::Subnet::Id }
  VpcPrivateSubnet3Id: { Type: AWS::EC2::Subnet::Id }
  KinesisStreamsEndpointAccessSecurityGroupId: { Type: AWS::EC2::SecurityGroup::Id }
  StsEndpointAccessSecurityGroupId: { Type: AWS::EC2::SecurityGroup::Id }
  CloudWatchAlarmTaggerServiceToken: { Type: String }
  CloudWatchLogGroupTaggerServiceToken: { Type: String }
  SharedEcsAsgInstanceSecurityGroupId: { Type: AWS::EC2::SecurityGroup::Id }
  SupportBucketName: { Type: String }
  DeploymentPackageBucketName: { Type: String }
  EchoServiceToken: { Type: String }
  SharedGlueDatabaseName: { Type: String }

  SharedRedisClientSecurityGroupId: { Type: AWS::EC2::SecurityGroup::Id }
  SharedRedisReplicationGroupEndpointAddress: { Type: String }
  SharedRedisReplicationGroupEndpointPort: { Type: String }

  DovetailCdnLogsKinesisStreamArn: { Type: String }
  DovetailCountedKinesisStreamArn: { Type: String }
  DovetailCountedKinesisStreamName: { Type: String }
  DovetailVerifiedMetricsKinesisStreamArn: { Type: String }
  DovetailVerifiedMetricsKinesisStreamName: { Type: String }

  AuguryHostname: { Type: String }
  DovetailCdnHostname: { Type: String }
  FeederHostname: { Type: String }
  FeedsS3BucketArn: { Type: String }

  DovetailAnalyticsLambdaCodeS3ObjectKey: { Type: String }
  DovetailCdnArrangerLambdaCodeS3ObjectKey: { Type: String }
  DovetailCdnArrangerCloudFrontOai: { Type: String }
  DovetailCountsLambdaCodeS3ObjectKey: { Type: String }
  DovetailRouterEcrImageTag: { Type: String }
  DovetailRouterSecretsVersion: { Type: String }

Resources:
  DovetailAnalyticsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        CloudWatchAlarmTaggerServiceToken: !Ref CloudWatchAlarmTaggerServiceToken
        CloudWatchLogGroupTaggerServiceToken: !Ref CloudWatchLogGroupTaggerServiceToken
        CodeS3Bucket: !Ref DeploymentPackageBucketName
        CodeS3ObjectKey: !Ref DovetailAnalyticsLambdaCodeS3ObjectKey
        VpcId: !Ref VpcId
        VpcPrivateSubnet1Id: !Ref VpcPrivateSubnet1Id
        VpcPrivateSubnet2Id: !Ref VpcPrivateSubnet2Id
        VpcPrivateSubnet3Id: !Ref VpcPrivateSubnet3Id
        DovetailVerifiedMetricsKinesisStreamArn: !Ref DovetailVerifiedMetricsKinesisStreamArn
        DovetailVerifiedMetricsKinesisStreamName: !Ref DovetailVerifiedMetricsKinesisStreamName
        SharedRedisClientSecurityGroupId: !Ref SharedRedisClientSecurityGroupId
        SharedRedisReplicationGroupEndpointAddress: !Ref SharedRedisReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !Ref SharedRedisReplicationGroupEndpointPort
        DovetailCountedKinesisStreamArn: !Ref DovetailCountedKinesisStreamArn
        DovetailCountedKinesisStreamName: !Ref DovetailCountedKinesisStreamName
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Analytics }
      TemplateURL: !Sub ${TemplateUrlPrefix}/dovetail-analytics.yml
      TimeoutInMinutes: 10

  DovetailCdnArrangerStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        CloudWatchAlarmTaggerServiceToken: !Ref CloudWatchAlarmTaggerServiceToken
        CloudWatchLogGroupTaggerServiceToken: !Ref CloudWatchLogGroupTaggerServiceToken
        CodeS3Bucket: !Ref DeploymentPackageBucketName
        CodeS3ObjectKey: !Ref DovetailCdnArrangerLambdaCodeS3ObjectKey
        LambdaLayerS3Bucket: !Ref SupportBucketName
        CloudFrontOai: !Ref DovetailCdnArrangerCloudFrontOai
        DovetailRouterHostname: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/DOVETAIL_HOST
        DovetailRouterToken: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/DOVETAIL_TOKEN
        ArrangementsDynamodbRegion: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/ARRANGEMENTS_DDB_REGION
        ArrangementsDynamodbTableName: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/ARRANGEMENTS_DDB_TABLE
        ArrangementsDynamodbTtl: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/ARRANGEMENTS_DDB_TTL
        ArrangementsDynamodbAccessRoleArn: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/ARRANGEMENTS_DDB_ACCESS_ROLE
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: CDN Arranger }
      TemplateURL: !Sub ${TemplateUrlPrefix}/dovetail-cdn-arranger.yml
      TimeoutInMinutes: 10

  DovetailCountsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        CloudWatchAlarmTaggerServiceToken: !Ref CloudWatchAlarmTaggerServiceToken
        CloudWatchLogGroupTaggerServiceToken: !Ref CloudWatchLogGroupTaggerServiceToken
        CodeS3Bucket: !Ref DeploymentPackageBucketName
        CodeS3ObjectKey: !Ref DovetailCountsLambdaCodeS3ObjectKey
        VpcId: !Ref VpcId
        VpcPrivateSubnet1Id: !Ref VpcPrivateSubnet1Id
        VpcPrivateSubnet2Id: !Ref VpcPrivateSubnet2Id
        VpcPrivateSubnet3Id: !Ref VpcPrivateSubnet3Id
        KinesisStreamsEndpointAccessSecurityGroupId: !Ref KinesisStreamsEndpointAccessSecurityGroupId
        StsEndpointAccessSecurityGroupId: !Ref StsEndpointAccessSecurityGroupId
        ArrangementsDynamodbRegion: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/ARRANGEMENTS_DDB_REGION
        ArrangementsDynamodbTableName: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/ARRANGEMENTS_DDB_TABLE
        ArrangementsDynamodbAccessRoleArn: !Sub /prx/${EnvironmentTypeAbbreviation}/dovetail-cdn-arranger/ARRANGEMENTS_DDB_ACCESS_ROLE
        DovetailCdnLogsKinesisStreamArn: !Ref DovetailCdnLogsKinesisStreamArn
        DovetailCountedKinesisStreamArn: !Ref DovetailCountedKinesisStreamArn
        SharedRedisReplicationGroupEndpointAddress: !Ref SharedRedisReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !Ref SharedRedisReplicationGroupEndpointPort
        SharedRedisClientSecurityGroupId: !Ref SharedRedisClientSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Counts }
      TemplateURL: !Sub ${TemplateUrlPrefix}/dovetail-counts.yml
      TimeoutInMinutes: 10

  DovetailRouterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        EcsClusterArn: !Ref EcsClusterArn
        EcsClusterName: !Ref EcsClusterName
        VpcId: !Ref VpcId
        NewRelicApiKeyPrxLite: !Ref NewRelicApiKeyPrxLite
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref DovetailRouterEcrImageTag
        SecretsVersion: !Ref DovetailRouterSecretsVersion
        SecretsStackName: !Ref SecretsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        EchoServiceToken: !Ref EchoServiceToken
        CloudWatchAlarmTaggerServiceToken: !Ref CloudWatchAlarmTaggerServiceToken
        CloudWatchLogGroupTaggerServiceToken: !Ref CloudWatchLogGroupTaggerServiceToken
        VpcPublicSubnet1Id: !Ref VpcPublicSubnet1Id
        VpcPublicSubnet2Id: !Ref VpcPublicSubnet2Id
        VpcPublicSubnet3Id: !Ref VpcPublicSubnet3Id
        SharedEcsAsgInstanceSecurityGroupId: !Ref SharedEcsAsgInstanceSecurityGroupId
        DovetailCountedKinesisStreamArn: !Ref DovetailCountedKinesisStreamArn
        SharedRedisReplicationGroupEndpointAddress: !Ref SharedRedisReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !Ref SharedRedisReplicationGroupEndpointPort
        SharedGlueDatabaseName: !Ref SharedGlueDatabaseName
        FeedsS3BucketArn: !Ref FeedsS3BucketArn
        AuguryHostname: !Ref AuguryHostname
        FeederHostname: !Ref FeederHostname
        DovetailCdnHostname: !Ref DovetailCdnHostname
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Router }
      TemplateURL: !Sub ${TemplateUrlPrefix}/dovetail-router.yml
      TimeoutInMinutes: 20
