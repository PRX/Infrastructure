AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Legacy Support (resources to support older apps moved to AWS)
Conditions:
  IsUsEast1: !Equals [!Ref "AWS::Region", us-east-1]
  IsStaging: !Equals [!Ref EnvironmentType, Staging]
  IsProduction: !Equals [!Ref EnvironmentType, Production]
Parameters:
  InfrastructureStorageStackName:
    Type: String
  InfrastructureNotificationsStackName:
    Type: String
  TemplateUrlPrefix:
    Type: String
  EnvironmentType:
    Type: String
  EnvironmentTypeAbbreviation:
    Type: String
  VPC:
    Type: "AWS::EC2::VPC::Id"
  VPCSubnet1:
    Type: "AWS::EC2::Subnet::Id"
  VPCSubnet2:
    Type: "AWS::EC2::Subnet::Id"
  VPCSubnet3:
    Type: "AWS::EC2::Subnet::Id"
  VPCCertificateArn:
    Type: String
  ECSCluster:
    Type: String
  ECSServiceAutoscaleIAMRoleArn:
    Type: String
  ECSServiceIAMRole:
    Type: String
  EcrRegion:
    Type: String
Resources:
  StripeProxyStack:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      NotificationARNs:
        - Fn::ImportValue:
            !Sub "${InfrastructureNotificationsStackName}-CloudFormationNotificationSnsTopic"
      Parameters:
        VPC: !Ref VPC
        VPCSubnet1: !Ref VPCSubnet1
        VPCSubnet2: !Ref VPCSubnet2
        VPCSubnet3: !Ref VPCSubnet3
        VPCCertificateArn: !Ref VPCCertificateArn
        ECSCluster: !Ref ECSCluster
        ECSServiceAutoscaleIAMRoleArn: !Ref ECSServiceAutoscaleIAMRoleArn
        ECSServiceIAMRole: !Ref ECSServiceIAMRole
        OpsDebugMessagesSnsTopicArn:
          Fn::ImportValue:
            !Sub "${InfrastructureNotificationsStackName}-OpsDebugMessagesSnsTopicArn"
        OpsWarnMessagesSnsTopicArn:
          Fn::ImportValue:
            !Sub "${InfrastructureNotificationsStackName}-OpsWarnMessagesSnsTopicArn"
        OpsErrorMessagesSnsTopicArn:
          Fn::ImportValue:
            !Sub "${InfrastructureNotificationsStackName}-OpsErrorMessagesSnsTopicArn"
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        EcrRegion: !Ref EcrRegion
      Tags:
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", [!Ref TemplateUrlPrefix, "stripe-proxy.yml"]]
      TimeoutInMinutes: "10"
