# stacks/provisioned.yml
AWSTemplateFormatVersion: "2010-09-09"

Description: Provisioned apps # TODO

Parameters:
  TemplateUrlPrefix: { Type: String }
  CloudFormationNotificationArn: { Type: String }
  AlbFullName: { Type: String }
  AlbHttpsListenerArn: { Type: String }
  EcsClusterArn: { Type: String }
  EcsClusterName: { Type: String }
  EnvironmentType: { Type: String }
  EnvironmentTypeAbbreviation: { Type: String }
  RootStackName: { Type: String }
  RootStackId: { Type: String }
  VpcId: { Type: "AWS::EC2::VPC::Id" }
  VpcCidrBlock: { Type: String }
  VpcIpv6CidrBlocks: { Type: String }
  SecretsBase: { Type: String }
  EcrRegion: { Type: String }
  SecretsStackName: { Type: String }
  NotificationsStackName: { Type: String }
  VpcPublicSubnet1Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPublicSubnet2Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPublicSubnet3Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet1Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet2Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet3Id: { Type: "AWS::EC2::Subnet::Id" }
  SharedMemcachedEndpointAddress: { Type: String }
  SharedMemcachedEndpointPort: { Type: String }
  AmazonSesSmtpCredentialsGeneratorServiceToken: { Type: String }
  EchoServiceToken: { Type: String }
  EcsLaunchEndpointsAccessSecurityGroupId: { Type: "AWS::EC2::SecurityGroup::Id" }
  KmsEndpointAccessSecurityGroupId: { Type: "AWS::EC2::SecurityGroup::Id" }
  SharedEcsAsgInstanceSecurityGroupId: { Type: "AWS::EC2::SecurityGroup::Id" }

  MetricsEcrImageTag: { Type: String }
  MetricsSecretsVersion: { Type: String }
  MetricsSharedAlbListenerRulePriorityPrefix: { Type: String }
  GroveEcrImageTag: { Type: String }
  GroveSecretsVersion: { Type: String }
  GroveSharedAlbListenerRulePriorityPrefix: { Type: String }
  DovetailRouterEcrImageTag: { Type: String }
  DovetailRouterSecretsVersion: { Type: String }
  DovetailLegacyEcrImageTag: { Type: String }
  DovetailLegacySecretsVersion: { Type: String }
  IdEcrImageTag: { Type: String }
  IdSecretsVersion: { Type: String }
  IdSharedAlbListenerRulePriorityPrefix: { Type: String }
  RemixEcrImageTag: { Type: String }
  RemixSecretsVersion: { Type: String }
  RemixSharedAlbListenerRulePriorityPrefix: { Type: String }
  CastleEcrImageTag: { Type: String }
  CastleSecretsVersion: { Type: String }
  CastleSharedAlbListenerRulePriorityPrefix: { Type: String }
  AuguryEcrImageTag: { Type: String }
  AugurySecretsVersion: { Type: String }
  AugurySharedAlbListenerRulePriorityPrefix: { Type: String }
  FeederEcrImageTag: { Type: String }
  FeederSecretsVersion: { Type: String }

Conditions:
  IsStaging: !Equals [!Ref EnvironmentType, Staging]

Resources:
  AuguryStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref AuguryEcrImageTag
        SecretsVersion: !Ref AugurySecretsVersion
        AlbListenerRulePriorityPrefix: !Ref AugurySharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        EchoServiceToken: !Ref EchoServiceToken
        VpcPublicSubnet1Id: !Ref VpcPublicSubnet1Id
        VpcPublicSubnet2Id: !Ref VpcPublicSubnet2Id
        VpcPublicSubnet3Id: !Ref VpcPublicSubnet3Id
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Augury }
      TemplateURL: !Sub ${TemplateUrlPrefix}/augury.yml
      TimeoutInMinutes: 20

  CastleStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        VpcPrivateSubnet1Id: !Ref VpcPrivateSubnet1Id
        VpcPrivateSubnet2Id: !Ref VpcPrivateSubnet2Id
        VpcPrivateSubnet3Id: !Ref VpcPrivateSubnet3Id
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref CastleEcrImageTag
        SecretsVersion: !Ref CastleSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref CastleSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        SharedEcsAsgInstanceSecurityGroupId: !Ref SharedEcsAsgInstanceSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Castle }
      TemplateURL: !Sub ${TemplateUrlPrefix}/castle.yml
      TimeoutInMinutes: 40

  DovetailRouterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref DovetailRouterEcrImageTag
        SecretsVersion: !Ref DovetailRouterSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        EchoServiceToken: !Ref EchoServiceToken
        VpcPublicSubnet1Id: !Ref VpcPublicSubnet1Id
        VpcPublicSubnet2Id: !Ref VpcPublicSubnet2Id
        VpcPublicSubnet3Id: !Ref VpcPublicSubnet3Id
        SharedEcsAsgInstanceSecurityGroupId: !Ref SharedEcsAsgInstanceSecurityGroupId
        # For legacy stack
        DovetailLegacyEcrImageTag: !Ref DovetailLegacyEcrImageTag
        DovetailLegacySecretsVersion: !Ref DovetailLegacySecretsVersion
        TemplateUrlPrefix: !Ref TemplateUrlPrefix
        CloudFormationNotificationArn: !Ref CloudFormationNotificationArn
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Router } # TODO
      TemplateURL: !Sub ${TemplateUrlPrefix}/dovetail-router.yml
      TimeoutInMinutes: 20

  FeederStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref FeederEcrImageTag
        SecretsVersion: !Ref FeederSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        EchoServiceToken: !Ref EchoServiceToken
        VpcPublicSubnet1Id: !Ref VpcPublicSubnet1Id
        VpcPublicSubnet2Id: !Ref VpcPublicSubnet2Id
        VpcPublicSubnet3Id: !Ref VpcPublicSubnet3Id
        SharedEcsAsgInstanceSecurityGroupId: !Ref SharedEcsAsgInstanceSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Feeder }
      TemplateURL: !Sub ${TemplateUrlPrefix}/feeder.yml
      TimeoutInMinutes: 20

  GroveStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref GroveEcrImageTag
        SecretsVersion: !Ref GroveSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref GroveSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Grove }
      TemplateURL: !Sub ${TemplateUrlPrefix}/grove.yml
      TimeoutInMinutes: 20

  IdStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref IdEcrImageTag
        SecretsVersion: !Ref IdSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref IdSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
        AmazonSesSmtpCredentialsGeneratorServiceToken: !Ref AmazonSesSmtpCredentialsGeneratorServiceToken
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: PRX }
        - { Key: prx:dev:application, Value: ID }
      TemplateURL: !Sub ${TemplateUrlPrefix}/id.yml
      TimeoutInMinutes: 20

  MetricsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref MetricsEcrImageTag
        SecretsVersion: !Ref MetricsSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref MetricsSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:family, Value: Dovetail }
        - { Key: prx:dev:application, Value: Metrics }
      TemplateURL: !Sub ${TemplateUrlPrefix}/metrics.yml
      TimeoutInMinutes: 20

  RemixStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref RemixEcrImageTag
        SecretsVersion: !Ref RemixSecretsVersion
        AlbListenerRulePriorityPrefix: !Ref RemixSharedAlbListenerRulePriorityPrefix
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        RootStackName: !Ref RootStackName
        RootStackId: !Ref RootStackId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Remix }
      TemplateURL: !Sub ${TemplateUrlPrefix}/remix.yml
      TimeoutInMinutes: 20

Outputs:
  StackName:
    Value: !Ref AWS::StackName

  FeederVanityAlbDomain:
    Value: !GetAtt FeederStack.Outputs.VanityAlbDomain
  FeederAlbName:
    Value: !GetAtt FeederStack.Outputs.AlbName
  DovetailVanityAlbDomain:
    Value: !GetAtt DovetailRouterStack.Outputs.VanityAlbDomain
  DovetailAlbName:
    Value: !GetAtt DovetailRouterStack.Outputs.AlbName
  CastleRedisCacheName:
    Value: !GetAtt CastleStack.Outputs.RedisCacheName
