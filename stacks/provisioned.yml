# stacks/provisioned.yml
AWSTemplateFormatVersion: "2010-09-09"

Description: Provisioned apps # TODO

Parameters:
  TemplateUrlPrefix: { Type: String }
  CloudFormationNotificationArn: { Type: String }
  AlbFullName: { Type: String }
  AlbHttpsListenerArn: { Type: String }
  EcsClusterArn: { Type: String }
  EnvironmentType: { Type: String }
  EnvironmentTypeAbbreviation: { Type: String }
  VpcId: { Type: "AWS::EC2::VPC::Id" }
  SecretsBase: { Type: String }
  EcrRegion: { Type: String }
  SecretsStackName: { Type: String }
  NotificationsStackName: { Type: String }
  UploadSigningUserName: { Type: String }
  UploadSigningEndpointUrl: { Type: String }
  UploadSigningAccessKeyId: { Type: String }
  VpcPrivateSubnet1Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet2Id: { Type: "AWS::EC2::Subnet::Id" }
  VpcPrivateSubnet3Id: { Type: "AWS::EC2::Subnet::Id" }
  SharedMemcachedEndpointAddress: { Type: String }
  SharedMemcachedEndpointPort: { Type: String }
  AmazonSesSmtpCredentialsGeneratorServiceToken: { Type: String }
  EcsAsgOutboundTrafficSecurityGroupId: { Type: "AWS::EC2::SecurityGroup::Id" }

  PublishEcrImageTag: { Type: String } #####
  PublishSecretsVersion: { Type: String } #####
  MetricsEcrImageTag: { Type: String }
  MetricsSecretsVersion: { Type: String }
  IframelyEcrImageTag: { Type: String } #####
  IframelySecretsVersion: { Type: String } #####
  GroveEcrImageTag: { Type: String }
  GroveSecretsVersion: { Type: String }
  PlayEcrImageTag: { Type: String } #####
  PlaySecretsVersion: { Type: String } #####
  StyleguideEcrImageTag: { Type: String }
  StyleguideSecretsVersion: { Type: String }
  NetworksEcrImageTag: { Type: String } #####
  NetworksSecretsVersion: { Type: String } #####
  DovetailRouterEcrImageTag: { Type: String }
  DovetailRouterSecretsVersion: { Type: String }
  IdEcrImageTag: { Type: String } #####
  IdSecretsVersion: { Type: String } #####
  RemixEcrImageTag: { Type: String }
  RemixSecretsVersion: { Type: String }
  ExchangeEcrImageTag: { Type: String } #####
  ExchangeSecretsVersion: { Type: String } #####
  CastleEcrImageTag: { Type: String }
  CastleSecretsVersion: { Type: String }

Resources:
  CastleStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        VpcPrivateSubnet1Id: !Ref VpcPrivateSubnet1Id
        VpcPrivateSubnet2Id: !Ref VpcPrivateSubnet2Id
        VpcPrivateSubnet3Id: !Ref VpcPrivateSubnet3Id
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref CastleEcrImageTag
        SecretsVersion: !Ref CastleSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        EcsAsgOutboundTrafficSecurityGroupId: !Ref EcsAsgOutboundTrafficSecurityGroupId
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/castle.yml
      TimeoutInMinutes: 15

  DovetailRouterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref DovetailRouterEcrImageTag
        SecretsVersion: !Ref DovetailRouterSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/dovetail-router.yml
      TimeoutInMinutes: 5

  ExchangeStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref ExchangeEcrImageTag
        SecretsVersion: !Ref ExchangeSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        AmazonSesSmtpCredentialsGeneratorServiceToken: !Ref AmazonSesSmtpCredentialsGeneratorServiceToken
        UploadSigningEndpointUrl: !Ref UploadSigningEndpointUrl
        UploadSigningAccessKeyId: !Ref UploadSigningAccessKeyId
        SharedMemcachedEndpointAddress: !Ref SharedMemcachedEndpointAddress
        SharedMemcachedEndpointPort: !Ref SharedMemcachedEndpointPort
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/exchange.yml
      TimeoutInMinutes: 5

  GroveStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref GroveEcrImageTag
        SecretsVersion: !Ref GroveSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/grove.yml
      TimeoutInMinutes: 5

  IdStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref IdEcrImageTag
        SecretsVersion: !Ref IdSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        AmazonSesSmtpCredentialsGeneratorServiceToken: !Ref AmazonSesSmtpCredentialsGeneratorServiceToken
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/id.yml
      TimeoutInMinutes: 5

  IframelyStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref IframelyEcrImageTag
        SecretsVersion: !Ref IframelySecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/iframely.yml
      TimeoutInMinutes: 5

  MetricsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref MetricsEcrImageTag
        SecretsVersion: !Ref MetricsSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/metrics.yml
      TimeoutInMinutes: 5

  NetworksStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref NetworksEcrImageTag
        SecretsVersion: !Ref NetworksSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        VpcPrivateSubnet1Id: !Ref VpcPrivateSubnet1Id
        VpcPrivateSubnet2Id: !Ref VpcPrivateSubnet2Id
        VpcPrivateSubnet3Id: !Ref VpcPrivateSubnet3Id
        UploadSigningEndpointUrl: !Ref UploadSigningEndpointUrl
        UploadSigningAccessKeyId: !Ref UploadSigningAccessKeyId
        SharedMemcachedEndpointAddress: !Ref SharedMemcachedEndpointAddress
        SharedMemcachedEndpointPort: !Ref SharedMemcachedEndpointPort
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/networks.yml
      TimeoutInMinutes: 5

  PlayStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref PlayEcrImageTag
        SecretsVersion: !Ref PlaySecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/play.yml
      TimeoutInMinutes: 5

  PublishStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref PublishEcrImageTag
        SecretsVersion: !Ref PublishSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
        UploadSigningUserName: !Ref UploadSigningUserName
        UploadSigningEndpointUrl: !Ref UploadSigningEndpointUrl
        UploadSigningAccessKeyId: !Ref UploadSigningAccessKeyId
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/publish.yml
      TimeoutInMinutes: 20

  RemixStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref RemixEcrImageTag
        SecretsVersion: !Ref RemixSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/remix.yml
      TimeoutInMinutes: 5

  StyleguideStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !Ref CloudFormationNotificationArn
      Parameters:
        AlbFullName: !Ref AlbFullName
        AlbHttpsListenerArn: !Ref AlbHttpsListenerArn
        EcsClusterArn: !Ref EcsClusterArn
        VpcId: !Ref VpcId
        SecretsBase: !Ref SecretsBase
        EcrImageTag: !Ref StyleguideEcrImageTag
        SecretsVersion: !Ref StyleguideSecretsVersion
        EcrRegion: !Ref EcrRegion
        SecretsStackName: !Ref SecretsStackName
        NotificationsStackName: !Ref NotificationsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !Ref EnvironmentTypeAbbreviation
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentType
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Sub ${TemplateUrlPrefix}/styleguide.yml
      TimeoutInMinutes: 5
