# stacks/root.yml
# Generally this template is used to launch stacks from the bootstrapping
# CodePipeline. Primarily is is simply a wrapper around individial app- and
# service-specific templates, which get nested into this template and are
# launched when this one is. The CodePiple also passes in a template
# configuration file, which includes parameter values for this and all nested
# templates. This root template MUST define all parameters that are included in
# the config file. It can then pass along select values to nested stacks that
# require them.
AWSTemplateFormatVersion: "2010-09-09"

Description: >-
  Launches stacks for a number of applications and services that are maintained
  in separate templates. This stack is only intended to be launched once in a
  given region, and launching more than one will likely fail. The stack can
  operate in either Primary or Secondary mode, depending on its current role in
  a multi-region setup.

Parameters:
  # Optional
  SharedAuroraMysqlEndpoint: { Type: String, Default: "" }
  SharedAuroraMysqlPort: { Type: String, Default: "3306" }
  SharedAuroraPostgresqlEndpoint: { Type: String, Default: "" }
  SharedAuroraPostgresqlPort: { Type: String, Default: "3306" }
  CastleRdsPostgresqlEndpoint: { Type: String, Default: "" }
  NewRelicApiKeyPrxLite: { Type: String, Default: "" }
  CastlePostgresUsername: { Type: String, Default: "" }
  CastlePostgresUserPassword: { Type: String, Default: "", NoEcho: true }
  # Required
  AwsOrganizationId: { Type: String }
  AsgKeyPairName:
    Description: >
      The EC2 key pair used for instances in the Auto Scaling
      group (region-specific)
    Type: AWS::EC2::KeyPair::KeyName
  EcrRegion: { Type: String }
  EnvironmentType:
    Type: String
    AllowedValues:
      - Staging
      - Production
  RegionMode:
    Type: String
    AllowedValues:
      - Primary
      - Secondary
  SharedVpcCidrBlock:
    Type: String
    AllowedPattern: ^(10|172|192).[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}\/16$
    ConstraintDescription: >-
      must be a /16 private network
  DovetailRedisHostname: { Type: String } # TODO Still need this?
  PorterJobExecutionSnsTopicArn: { Type: String }
  # Application Specific
  AuguryEcrImageTag: { Type: String }
  AugurySecretsVersion: { Type: String }
  RemixEcrImageTag: { Type: String }
  RemixSecretsVersion: { Type: String }
  NetworksEcrImageTag: { Type: String }
  NetworksSecretsVersion: { Type: String }
  MetricsEcrImageTag: { Type: String }
  MetricsSecretsVersion: { Type: String }
  StyleguideEcrImageTag: { Type: String }
  StyleguideSecretsVersion: { Type: String }
  CastleEcrImageTag: { Type: String }
  CastleSecretsVersion: { Type: String }
  CmsEcrImageTag: { Type: String }
  CmsSecretsVersion: { Type: String }
  DovetailEcrImageTag: { Type: String }
  DovetailSecretsVersion: { Type: String }
  DovetailRouterEcrImageTag: { Type: String }
  DovetailrouterSecretsVersion: { Type: String }
  ExchangeEcrImageTag: { Type: String }
  ExchangeSecretsVersion: { Type: String }
  FeederEcrImageTag: { Type: String }
  FeederSecretsVersion: { Type: String }
  IdEcrImageTag: { Type: String }
  IdSecretsVersion: { Type: String }
  PlayEcrImageTag: { Type: String }
  PlaySecretsVersion: { Type: String }
  PlayProxyEcrImageTag: { Type: String }
  PublishEcrImageTag: { Type: String }
  PublishSecretsVersion: { Type: String }
  IframelyEcrImageTag: { Type: String }
  IframelySecretsVersion: { Type: String }
  RadiotopiaTowerLambdaCodeS3ObjectKey: { Type: String }
  UploadLambdaCodeS3ObjectKey: { Type: String }
  AnalyticsIngestLambdaCodeS3ObjectKey: { Type: String }
  DovetailStitchLambdaCodeS3ObjectKey: { Type: String }
  DovetailBytesLambdaCodeS3ObjectKey: { Type: String }
  DovetailCountsLambdaCodeS3ObjectKey: { Type: String }
  DovetailTrafficLambdaCodeS3ObjectKey: { Type: String }
  DovetailCdnArrangerCodeS3ObjectKey: { Type: String }
  DovetailCdnArrangerCloudFrontOai: { Type: String }
  DovetailCdnOriginRequestCodeS3ObjectKey: { Type: String }
  ProxyPrxOrgCodeS3ObjectKey: { Type: String }
  BetaPrxOrgArchiveS3ObjectKey: { Type: String }
  BetaPrxOrgCloudFrontOai: { Type: String }
  BacksawArchiveS3ObjectKey: { Type: String }
  BacksawCloudFrontOai: { Type: String }
  SharedResourceSharePrincipals: { Type: CommaDelimitedList }
  TheWorldSearchCodeS3ObjectKey: { Type: String }
  TheWorldSearchGoogleCustomSearchEngineId: { Type: String }
  TheWorldSearchGoogleCustomSearchApiKey: { Type: String }
  # Parameter Overrides from the CodePipeline action
  InfrastructureStorageStackName: { Type: String }
  NotificationsStackName: { Type: String }
  SecretsStackName: { Type: String }
  InfrastructureGitCommit: { Type: String }
  PipelineExecutionNonce: { Type: String }

Conditions:
  IsProduction: !Equals [!Ref EnvironmentType, Production]

Mappings:
  EnvironmentTypeMap:
    Testing:
      abbreviation: test
    Beta:
      abbreviation: beta
    Staging:
      abbreviation: stag
    Production:
      abbreviation: prod
  ECSReservationMap: # TODO These are only used by legacy app stacks
    Staging:
      BackendCpu: 128
      BackendMemory: 1000
      BackendMemoryReservation: 500
      FrontendCpu: 64
      FrontendMemory: 200
      DovetailCpu: 128
      DovetailMemory: 800
      DovetailMemoryReservation: 400
    Production:
      BackendCpu: 200
      BackendMemory: 2000
      BackendMemoryReservation: 1000
      FrontendCpu: 100
      FrontendMemory: 400
      DovetailCpu: 700
      DovetailMemory: 2000
      DovetailMemoryReservation: 1000
  # Each app should be given a listener rule priority prefix between 1 and 500.
  # In app stacks, listener rule priorities are created by combining the
  # prefix with exactly two more digits. This allows each app to have up to 99
  # rules per listener.
  #
  # Higher-traffic apps should be given a higher priority (lower number) to
  # reduce the number of rules evaluations needed for more common requests.
  #
  # The final rule priority values must be between 1 and 50000.
  SharedAlbListenerRulePriorityMap:
    Play: { prefix: 11 }
    Exchange: { prefix: 13 }
    Augury: { prefix: 17 }
    Cms: { prefix: 20 }
    Id: { prefix: 24 }
    Castle: { prefix: 26 }
    Remix: { prefix: 29 }
    Publish: { prefix: 31 }
    Metrics: { prefix: 36 }
    Styleguide: { prefix: 65 }
    Networks: { prefix: 70 }
    Iframely: { prefix: 73 }

Resources:
  CustomResourcesStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        StorageStackName: !Ref InfrastructureStorageStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        RootStackName: !Ref AWS::StackName
        RootStackId: !Ref AWS::StackId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Infrastructure }
      TemplateURL:
        Fn::Sub:
          - https://${SourceBucketName}.s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}/stacks/custom-resources.yml
          - SourceBucketName:
              Fn::ImportValue: !Sub ${InfrastructureStorageStackName}-InfrastructureSourceBucket
      TimeoutInMinutes: 5

  Constants:
    Type: Custom::Echo
    Properties:
      ServiceToken: !GetAtt CustomResourcesStack.Outputs.EchoServiceToken
      RootStackName: !Ref AWS::StackName
      RootStackId: !Ref AWS::StackId
      SourceBucketName:
        Fn::ImportValue: !Sub ${InfrastructureStorageStackName}-InfrastructureSourceBucket
      DeploymentPackageBucketName:
        Fn::ImportValue: !Sub ${InfrastructureStorageStackName}-InfrastructureApplicationCodeBucket
      SecretsBaseRegion:
        Fn::ImportValue: !Sub ${SecretsStackName}-SecretsBaseRegion
      CloudFormationNotificationArn:
        Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      TemplateUrlBase:
        # This is a URL including the hostname of the source bucket, and the
        # path starting with a Git commit hash for the Infrastructure
        # repository. Some or all of the contents of the repo live under that
        # path.
        # It does not include a trailing slash.
        # e.g., https://prx-infrastructure-us-east-1-source.s3.us-east-1.amazonaws.com/000e4f9a6b3836efbfc722fe7d2fd598b03edfd4
        Fn::Sub:
          - https://${SourceBucketName}.s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}
          - SourceBucketName:
              Fn::ImportValue: !Sub ${InfrastructureStorageStackName}-InfrastructureSourceBucket
      AuguryHostname: !If [IsProduction, augury.prx.org, augury.staging.prx.tech]
      BetaHostname: !If [IsProduction, beta.prx.org, beta.staging.prx.tech]
      CastleHostname: !If [IsProduction, castle.prx.tech, castle.staging.prx.tech]
      CmsHostname: !If [IsProduction, cms.prx.org, cms.staging.prx.tech]
      CorporateHostname: corporate.prx.tech
      DovetailCdnHostname: !If [IsProduction, dovetail3-cdn.prxu.org, dovetail3-cdn-staging.prxu.org]
      DovetailRouterHostname: !If [IsProduction, dovetail-router.prxu.org, dovetail-router.staging.prxu.org]
      ExchangeHostname: !If [IsProduction, exchange.prx.org, exchange.staging.prx.tech]
      FeederHostname: !If [IsProduction, feeder.prx.org, feeder.staging.prx.tech]
      IdHostname: !If [IsProduction, id.prx.org, id.staging.prx.tech]
      MetricsHostname: !If [IsProduction, metrics.prx.org, metrics.staging.prx.tech]
      PlayHostname: !If [IsProduction, play.prx.org, play.staging.prx.tech]
      AdFilesHostname: a.prxu.org

  # Root stacks
  ServerlessRootStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        InfrastructureStorageStackName: !Ref InfrastructureStorageStackName
        InfrastructureNotificationsStackName: !Ref NotificationsStackName
        VPCSecurityGroup: !GetAtt VPCStack.Outputs.SecurityGroup
        VPCSubnet1: !GetAtt VPCStack.Outputs.Subnet1
        VPCSubnet2: !GetAtt VPCStack.Outputs.Subnet2
        VPCSubnet3: !GetAtt VPCStack.Outputs.Subnet3
        TemplateUrlPrefix: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/serverless/"]]
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        SharedRedisReplicationGroupEndpointAddress: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointPort
        UploadLambdaCodeS3ObjectKey: !Ref UploadLambdaCodeS3ObjectKey
        DovetailBytesLambdaCodeS3ObjectKey: !Ref DovetailBytesLambdaCodeS3ObjectKey
        DovetailCountsLambdaCodeS3ObjectKey: !Ref DovetailCountsLambdaCodeS3ObjectKey
        DovetailTrafficLambdaCodeS3ObjectKey: !Ref DovetailTrafficLambdaCodeS3ObjectKey
        DovetailCdnArrangerCodeS3ObjectKey: !Ref DovetailCdnArrangerCodeS3ObjectKey
        DovetailCdnArrangerCloudFrontOai: !Ref DovetailCdnArrangerCloudFrontOai
        DovetailCdnOriginRequestCodeS3ObjectKey: !Ref DovetailCdnOriginRequestCodeS3ObjectKey
        AnalyticsIngestLambdaCodeS3ObjectKey: !Ref AnalyticsIngestLambdaCodeS3ObjectKey
        RadiotopiaTowerLambdaCodeS3ObjectKey: !Ref RadiotopiaTowerLambdaCodeS3ObjectKey
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/serverless/root.yml"]]
      TimeoutInMinutes: 5
  ContainerAppsRootStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        InfrastructureNotificationsStackName: !Ref NotificationsStackName
        TemplateUrlPrefix: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/container-apps/"]]
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        VPC: !GetAtt VPCStack.Outputs.VPC
        VPCSubnet1: !GetAtt VPCStack.Outputs.Subnet1
        VPCSubnet2: !GetAtt VPCStack.Outputs.Subnet2
        VPCSubnet3: !GetAtt VPCStack.Outputs.Subnet3
        VPCCertificateArn: !GetAtt CertificateStack.Outputs.WildcardCertificateArn
        PlatformALBDNSName: !GetAtt LoadBalancersStack.Outputs.PlatformALBDualstackDNSName
        PlatformALBFullName: !GetAtt LoadBalancersStack.Outputs.PlatformALBFullName
        PlatformALBCanonicalHostedZoneID: !GetAtt LoadBalancersStack.Outputs.PlatformALBCanonicalHostedZoneID
        PlatformALBHTTPListenerArn: !GetAtt LoadBalancersStack.Outputs.PlatformALBHTTPListenerArn
        PlatformALBHTTPSListenerArn: !GetAtt LoadBalancersStack.Outputs.PlatformALBHTTPSListenerArn
        ECSCluster: !GetAtt ECSClusterStack.Outputs.ECSCluster
        ECSClusterArn: !GetAtt ECSClusterStack.Outputs.ECSClusterArn
        ECSInstanceIAMRoleArn: !GetAtt ECSClusterStack.Outputs.ECSInstanceIAMRoleArn
        ECSServiceAutoscaleIAMRoleArn: !GetAtt ECSClusterStack.Outputs.ECSServiceAutoscaleIAMRoleArn
        ECSServiceIAMRole: !GetAtt ECSClusterStack.Outputs.ECSServiceIAMRole
        EcrRegion: !Ref EcrRegion
        SharedMemcachedEndpointAddress: !GetAtt SharedMemcachedStack.Outputs.CacheEndpointAddress
        SharedMemcachedEndpointPort: !GetAtt SharedMemcachedStack.Outputs.CacheEndpointPort
        AmazonSesSmtpCredentialsGeneratorServiceToken: !GetAtt CustomResourcesStack.Outputs.AmazonSesSmtpCredentialsGeneratorServiceToken
        UploadSigningEndpointUrl: !GetAtt ServerlessRootStack.Outputs.UploadSigningEndpointUrl
        UploadSigningAccessKeyId: !GetAtt ServerlessRootStack.Outputs.UploadSigningAccessKeyId
        SharedAuroraPostgresqlEndpoint: !Ref SharedAuroraPostgresqlEndpoint
        SharedAuroraMysqlEndpoint: !Ref SharedAuroraMysqlEndpoint
        SecretsBase:
          Fn::ImportValue: !Sub ${SecretsStackName}-SecretsBaseRegion
        SecretsInstanceDecryptPolicyArn:
          Fn::ImportValue: !Sub ${SecretsStackName}-SecretsInstanceDecryptPolicyArn
        SecretsInstanceAccessPolicyArn:
          Fn::ImportValue: !Sub ${SecretsStackName}-SecretsInstanceAccessPolicyArn
        ContainerMemory: !FindInMap [ECSReservationMap, !Ref EnvironmentType, BackendMemory]
        ContainerMemoryReservation: !FindInMap [ECSReservationMap, !Ref EnvironmentType, BackendMemoryReservation]
        ContainerCpu: !FindInMap [ECSReservationMap, !Ref EnvironmentType, BackendCpu]
        # Exchange
        ExchangePlatformALBListenerPriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Exchange, prefix]
        ExchangeEcrImageTag: !Ref ExchangeEcrImageTag
        ExchangeSecretsVersion: !Ref ExchangeSecretsVersion
        # Cms
        CmsPlatformALBListenerPriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Cms, prefix]
        CmsEcrImageTag: !Ref CmsEcrImageTag
        CmsSecretsVersion: !Ref CmsSecretsVersion
        # Augury
        AuguryPlatformALBListenerPriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Augury, prefix]
        AuguryEcrImageTag: !Ref AuguryEcrImageTag
        AugurySecretsVersion: !Ref AugurySecretsVersion
        # Styleguide
        StyleguidePlatformALBListenerPriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Styleguide, prefix]
        StyleguideEcrImageTag: !Ref StyleguideEcrImageTag
        StyleguideSecretsVersion: !Ref StyleguideSecretsVersion
        # Remix
        RemixPlatformALBListenerPriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Remix, prefix]
        RemixEcrImageTag: !Ref RemixEcrImageTag
        RemixSecretsVersion: !Ref RemixSecretsVersion
        # Networks
        NetworksPlatformALBListenerPriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Networks, prefix]
        NetworksEcrImageTag: !Ref NetworksEcrImageTag
        NetworksSecretsVersion: !Ref NetworksSecretsVersion
        # Iframely
        IframelyPlatformALBListenerPriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Iframely, prefix]
        IframelyEcrImageTag: !Ref IframelyEcrImageTag
        IframelySecretsVersion: !Ref IframelySecretsVersion
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/container-apps/root.yml"]]
      TimeoutInMinutes: 5
  # App and shared resource stacks
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        AwsOrganizationId: !Ref AwsOrganizationId
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/vpc.yml"]]
      TimeoutInMinutes: 5
  CertificateStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        VPC: !GetAtt VPCStack.Outputs.VPC
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/certificate.yml"]]
      TimeoutInMinutes: 5
  ECSClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub "${NotificationsStackName}-CloudFormationNotificationSnsTopic"
      Parameters:
        InfrastructureStorageStackName: !Ref InfrastructureStorageStackName
        NotificationsStackName: !Ref NotificationsStackName
        KeyPairName: !Ref AsgKeyPairName
        EnvironmentType: !Ref EnvironmentType
        VPC: !GetAtt VPCStack.Outputs.VPC
        VPCSubnet1: !GetAtt VPCStack.Outputs.Subnet1
        VPCSubnet2: !GetAtt VPCStack.Outputs.Subnet2
        VPCSubnet3: !GetAtt VPCStack.Outputs.Subnet3
        VPCSubnet1AZ: !GetAtt VPCStack.Outputs.Subnet1AvailabilityZone
        VPCSubnet2AZ: !GetAtt VPCStack.Outputs.Subnet2AvailabilityZone
        VPCSubnet3AZ: !GetAtt VPCStack.Outputs.Subnet3AvailabilityZone
        OpsWarnMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsWarnMessagesSnsTopicArn
        OpsErrorMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsErrorMessagesSnsTopicArn
        SlackMessageRelaySnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-SlackMessageRelaySnsTopicArn
        SecretsInstanceDecryptPolicyArn:
          Fn::ImportValue: !Sub ${SecretsStackName}-SecretsInstanceDecryptPolicyArn
        SecretsInstanceAccessPolicyArn:
          Fn::ImportValue: !Sub ${SecretsStackName}-SecretsInstanceAccessPolicyArn
        DovetailRedisHostname: !Ref DovetailRedisHostname
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/ecs.yml"]]
      TimeoutInMinutes: 5
  LoadBalancersStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        VPC: !GetAtt VPCStack.Outputs.VPC
        VPCSubnet1: !GetAtt VPCStack.Outputs.Subnet1
        VPCSubnet2: !GetAtt VPCStack.Outputs.Subnet2
        VPCSubnet3: !GetAtt VPCStack.Outputs.Subnet3
        VPCCertificateArn: !GetAtt CertificateStack.Outputs.WildcardCertificateArn
        OpsWarnMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsWarnMessagesSnsTopicArn
        OpsErrorMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsErrorMessagesSnsTopicArn
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/load-balancers.yml"]]
      TimeoutInMinutes: 5
  DovetailStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        VPC: !GetAtt VPCStack.Outputs.VPC
        VPCSubnet1: !GetAtt VPCStack.Outputs.Subnet1
        VPCSubnet2: !GetAtt VPCStack.Outputs.Subnet2
        VPCSubnet3: !GetAtt VPCStack.Outputs.Subnet3
        VPCCertificateArn: !GetAtt CertificateStack.Outputs.WildcardCertificateArn # TODO Give it a separate cert
        ECSCluster: !GetAtt ECSClusterStack.Outputs.ECSCluster
        ECSServiceIAMRole: !GetAtt ECSClusterStack.Outputs.ECSServiceIAMRole
        MetricsKinesisStream: !Join ["", ["/prx/", !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation], "/analytics-ingest-lambda/METRICS_KINESIS_STREAM"]]
        DynamodbKinesisStream: !Join ["", ["/prx/", !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation], "/analytics-ingest-lambda/DYNAMODB_KINESIS_STREAM"]]
        OpsWarnMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsWarnMessagesSnsTopicArn
        OpsErrorMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsErrorMessagesSnsTopicArn
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        EcrRegion: !Ref EcrRegion
        SecretsBase:
          Fn::ImportValue: !Sub ${SecretsStackName}-SecretsBaseRegion
        DovetailEcrImageTag: !Ref DovetailEcrImageTag
        DovetailSecretsVersion: !Ref DovetailSecretsVersion
        DovetailRouterEcrImageTag: !Ref DovetailRouterEcrImageTag
        DovetailRouterSecretsVersion: !Ref DovetailrouterSecretsVersion
        ContainerMemory: !FindInMap [ECSReservationMap, !Ref EnvironmentType, DovetailMemory]
        ContainerMemoryReservation: !FindInMap [ECSReservationMap, !Ref EnvironmentType, DovetailMemoryReservation]
        ContainerCpu: !FindInMap [ECSReservationMap, !Ref EnvironmentType, DovetailCpu]
        SharedRedisReplicationGroupEndpointAddress: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointPort
        NewRelicApiKeyPrxLite: !Ref NewRelicApiKeyPrxLite
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/container-apps/dovetail.prx.org.yml"]]
      TimeoutInMinutes: 5
  DovetailStitchLambdaStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        CodeS3Bucket:
          Fn::ImportValue: !Sub ${InfrastructureStorageStackName}-InfrastructureApplicationCodeBucket
        CodeS3ObjectKey: !Ref DovetailStitchLambdaCodeS3ObjectKey
        PorterSnsArn: !Join ["", ["/prx/", !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation], "/dovetail-stitch-lambda/PORTER_SNS_ARN"]]
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/dovetail-stitch-lambda.yml"]]
      TimeoutInMinutes: 5
  SharedMemcachedStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        VPC: !GetAtt VPCStack.Outputs.VPC
        VPCSubnet1: !GetAtt VPCStack.Outputs.Subnet1
        VPCSubnet2: !GetAtt VPCStack.Outputs.Subnet2
        VPCSubnet3: !GetAtt VPCStack.Outputs.Subnet3
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        OpsWarnMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsWarnMessagesSnsTopicArn
        OpsErrorMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsErrorMessagesSnsTopicArn
        EnvironmentType: !Ref EnvironmentType
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
        SourceSecurityGroupId1: !GetAtt ECSClusterStack.Outputs.ECSInstanceOutboundSecurityGroupId
      Tags:
        - Key: prx:cloudformation:stack-name
          Value: !Ref AWS::StackName
        - Key: prx:cloudformation:stack-id
          Value: !Ref AWS::StackId
      TemplateURL: !Join ["", ["https://", "Fn::ImportValue": !Sub "${InfrastructureStorageStackName}-InfrastructureSourceBucket", !Sub ".s3.${AWS::Region}.amazonaws.com/${InfrastructureGitCommit}", "/stacks/shared-memcached.yml"]]
      TimeoutInMinutes: 40

  SharedVpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        AvailabilityZoneSelectorServiceToken: !GetAtt CustomResourcesStack.Outputs.AvailabilityZoneSelectorServiceToken
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        TemplateUrlPrefix: !Sub ${Constants.TemplateUrlBase}/stacks/shared-vpc
        CloudFormationNotificationArn: !GetAtt Constants.CloudFormationNotificationArn
        CloudWatchLogGroupTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchLogGroupTaggerServiceToken
        Ec2ResourceTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.Ec2ResourceTaggerServiceToken
        SharedVpcCidrBlock: !Ref SharedVpcCidrBlock
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-vpc.yml
      TimeoutInMinutes: 20

  SharedAlbStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackName
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        VpcPublicSubnet1Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
        VpcPublicSubnet2Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
        VpcPublicSubnet3Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id
        EchoServiceToken: !GetAtt CustomResourcesStack.Outputs.EchoServiceToken
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
        SharedGlueDatabaseName: !GetAtt SharedGlueDatabaseStack.Outputs.SharedGlueDatabaseName
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-alb.yml
      TimeoutInMinutes: 40
  SharedEcsClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackName
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-ecs-cluster.yml
      TimeoutInMinutes: 20
  SharedEcsAsgSecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackName
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        LoadBalancerSecurityGroupId: !GetAtt SharedAlbStack.Outputs.LoadBalancerSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-ecs-asg-sg.yml
      TimeoutInMinutes: 20
  SharedEcsAsgStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackName
        SlackMessageRelaySnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-SlackMessageRelaySnsTopicArn
        CloudWatchLogGroupTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchLogGroupTaggerServiceToken
        KeyPairName: !Ref AsgKeyPairName
        VpcPublicSubnet1Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
        VpcPublicSubnet2Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
        VpcPublicSubnet3Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id
        EcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName
        SharedEcsAsgInstanceSecurityGroupId: !GetAtt SharedEcsAsgSecurityGroupStack.Outputs.InstanceSecurityGroupId
        LoadBalancerSecurityGroupId: !GetAtt SharedAlbStack.Outputs.LoadBalancerSecurityGroupId
        EcsLaunchEndpointsAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.EcsLaunchEndpointsAccessSecurityGroupId
        KmsEndpointAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.KmsEndpointAccessSecurityGroupId
        SharedRedisReplicationGroupEndpointAddress: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointPort
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-ecs-asg.yml
      TimeoutInMinutes: 60

  SharedResourceShareStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        SharedResourceSharePrincipals: !Join [",", !Ref SharedResourceSharePrincipals]
        VPCPrivateSubnet1: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
        VPCPrivateSubnet2: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
        VPCPrivateSubnet3: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-resource-share.yml
      TimeoutInMinutes: 20

  PrivateSharedMemcachedStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        VPC: !GetAtt SharedVpcStack.Outputs.VpcId
        VPCSubnet1: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
        VPCSubnet2: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
        VPCSubnet3: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id
        RootStackId: !GetAtt Constants.RootStackId
        RootStackName: !GetAtt Constants.RootStackName
        OpsWarnMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsWarnMessagesSnsTopicArn
        OpsErrorMessagesSnsTopicArn:
          Fn::ImportValue: !Sub ${NotificationsStackName}-OpsErrorMessagesSnsTopicArn
        EnvironmentType: !Ref EnvironmentType
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
        SourceSecurityGroupId1: !GetAtt SharedEcsAsgSecurityGroupStack.Outputs.InstanceSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-memcached.yml
      TimeoutInMinutes: 40

  SharedRedisStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        VpcPrivateSubnet1Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
        VpcPrivateSubnet2Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
        VpcPrivateSubnet3Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
        SharedEcsAsgInstanceSecurityGroupId: !GetAtt SharedEcsAsgSecurityGroupStack.Outputs.InstanceSecurityGroupId
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-redis.yml
      TimeoutInMinutes: 60

  SharedAnnounceStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - Fn::ImportValue: !Sub ${NotificationsStackName}-CloudFormationNotificationSnsTopic
      Parameters:
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        HashStringServiceToken: !GetAtt CustomResourcesStack.Outputs.HashStringServiceToken
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-announce.yml
      TimeoutInMinutes: 60

  Apps100AStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        TemplateUrlPrefix: !Sub ${Constants.TemplateUrlBase}/stacks/apps
        CloudFormationNotificationArn: !GetAtt Constants.CloudFormationNotificationArn
        AlbFullName: !GetAtt SharedAlbStack.Outputs.AlbFullName
        AlbHttpsListenerArn: !GetAtt SharedAlbStack.Outputs.HttpsListenerArn
        EcsClusterArn: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterArn
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        NewRelicApiKeyPrxLite: !Ref NewRelicApiKeyPrxLite
        SecretsBase: !GetAtt Constants.SecretsBaseRegion
        SecretsStackName: !Ref SecretsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        RegionMode: !Ref RegionMode
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        VpcPrivateSubnet1Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
        VpcPrivateSubnet2Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
        VpcPrivateSubnet3Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id
        KinesisStreamsEndpointAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.KinesisStreamsEndpointAccessSecurityGroupId
        StsEndpointAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.StsEndpointAccessSecurityGroupId
        SharedMemcachedEndpointAddress: !GetAtt PrivateSharedMemcachedStack.Outputs.CacheEndpointAddress
        SharedRedisReplicationGroupEndpointAddress: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointPort
        AmazonSesSmtpCredentialsGeneratorServiceToken: !GetAtt CustomResourcesStack.Outputs.AmazonSesSmtpCredentialsGeneratorServiceToken
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
        CloudWatchLogGroupTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchLogGroupTaggerServiceToken
        SharedEcsAsgInstanceSecurityGroupId: !GetAtt SharedEcsAsgSecurityGroupStack.Outputs.InstanceSecurityGroupId
        DeploymentPackageBucketName: !GetAtt Constants.DeploymentPackageBucketName
        CmsHostname: !GetAtt Constants.CmsHostname
        ExchangeHostname: !GetAtt Constants.ExchangeHostname
        DovetailRouterHostname: !GetAtt Constants.DovetailRouterHostname
        IdHostname: !GetAtt Constants.IdHostname
        SharedAuroraMysqlEndpoint: !Ref SharedAuroraMysqlEndpoint
        SharedAuroraMysqlPort: !Ref SharedAuroraMysqlPort
        AnnounceResourcePrefix: !GetAtt SharedAnnounceStack.Outputs.ResourcePrefix
        PorterJobExecutionSnsTopicArn: !Ref PorterJobExecutionSnsTopicArn

        # App-specific parameters

        CmsEcrImageTag: !Ref CmsEcrImageTag
        CmsSecretsVersion: !Ref CmsSecretsVersion
        CmsSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Cms, prefix]

        DovetailCdnArrangerLambdaCodeS3ObjectKey: !Ref DovetailCdnArrangerCodeS3ObjectKey
        DovetailCdnArrangerCloudFrontOai: !Ref DovetailCdnArrangerCloudFrontOai

        DovetailCountsLambdaCodeS3ObjectKey: !Ref DovetailCountsLambdaCodeS3ObjectKey

        DovetailTrafficLambdaCodeS3ObjectKey: !Ref DovetailTrafficLambdaCodeS3ObjectKey

        IdEcrImageTag: !Ref IdEcrImageTag
        IdSecretsVersion: !Ref IdSecretsVersion
        IdSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Id, prefix]

        IframelyEcrImageTag: !Ref IframelyEcrImageTag
        IframelySecretsVersion: !Ref IframelySecretsVersion
        IframelySharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Iframely, prefix]

        PlayEcrImageTag: !Ref PlayEcrImageTag
        PlaySecretsVersion: !Ref PlaySecretsVersion
        PlayProxyEcrImageTag: !Ref PlayProxyEcrImageTag
        PlaySharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Play, prefix]

        RadiotopiaTowerLambdaCodeS3ObjectKey: !Ref RadiotopiaTowerLambdaCodeS3ObjectKey

        S3SigningLambdaCodeS3ObjectKey: !Ref UploadLambdaCodeS3ObjectKey

        StyleguideEcrImageTag: !Ref StyleguideEcrImageTag
        StyleguideSecretsVersion: !Ref StyleguideSecretsVersion
        StyleguideSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Styleguide, prefix]

        TheWorldSearchGoogleCustomSearchEngineId: !Ref TheWorldSearchGoogleCustomSearchEngineId
        TheWorldSearchGoogleCustomSearchApiKey: !Ref TheWorldSearchGoogleCustomSearchApiKey
        TheWorldSearchCodeS3ObjectKey: !Ref TheWorldSearchCodeS3ObjectKey
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/apps-100A.yml
      TimeoutInMinutes: 40
  Apps200AStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        TemplateUrlPrefix: !Sub ${Constants.TemplateUrlBase}/stacks/apps
        CloudFormationNotificationArn: !GetAtt Constants.CloudFormationNotificationArn
        AlbFullName: !GetAtt SharedAlbStack.Outputs.AlbFullName
        AlbHttpsListenerArn: !GetAtt SharedAlbStack.Outputs.HttpsListenerArn
        EcsClusterArn: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterArn
        EcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        VpcCidrBlock: !GetAtt SharedVpcStack.Outputs.VpcCidrBlock
        VpcIpv6CidrBlocks: !GetAtt SharedVpcStack.Outputs.VpcIpv6CidrBlocks
        NewRelicApiKeyPrxLite: !Ref NewRelicApiKeyPrxLite
        SecretsBase: !GetAtt Constants.SecretsBaseRegion
        SecretsStackName: !Ref SecretsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        RegionMode: !Ref RegionMode
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        VpcPublicSubnet1Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
        VpcPublicSubnet2Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
        VpcPublicSubnet3Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id
        VpcPrivateSubnet1Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
        VpcPrivateSubnet2Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
        VpcPrivateSubnet3Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id
        SharedMemcachedEndpointAddress: !GetAtt PrivateSharedMemcachedStack.Outputs.CacheEndpointAddress
        SharedMemcachedEndpointPort: !GetAtt PrivateSharedMemcachedStack.Outputs.CacheEndpointPort
        SharedRedisReplicationGroupEndpointAddress: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointPort
        AmazonSesSmtpCredentialsGeneratorServiceToken: !GetAtt CustomResourcesStack.Outputs.AmazonSesSmtpCredentialsGeneratorServiceToken
        EchoServiceToken: !GetAtt CustomResourcesStack.Outputs.EchoServiceToken
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
        CloudWatchLogGroupTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchLogGroupTaggerServiceToken
        EcsLaunchEndpointsAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.EcsLaunchEndpointsAccessSecurityGroupId
        KmsEndpointAccessSecurityGroupId: !GetAtt SharedVpcStack.Outputs.KmsEndpointAccessSecurityGroupId
        SharedEcsAsgInstanceSecurityGroupId: !GetAtt SharedEcsAsgSecurityGroupStack.Outputs.InstanceSecurityGroupId
        S3SigningUserName: !GetAtt Apps100AStack.Outputs.S3SigningUserName
        S3SigningEndpointUrl: !GetAtt Apps100AStack.Outputs.S3SigningEndpointUrl
        S3SigningAccessKeyId: !GetAtt Apps100AStack.Outputs.S3SigningAccessKeyId
        DovetailCdnArrangerFunctionArn: !GetAtt Apps100AStack.Outputs.DovetailCdnArrangerFunctionArn
        DovetailCdnArrangerWorkspaceBucketArn: !GetAtt Apps100AStack.Outputs.DovetailCdnArrangerWorkspaceBucketArn
        S3StaticSiteDeployServiceToken: !GetAtt CustomResourcesStack.Outputs.S3StaticSiteDeployServiceToken
        DeploymentPackageBucketName: !GetAtt Constants.DeploymentPackageBucketName
        CastleHostname: !GetAtt Constants.CastleHostname
        CmsHostname: !GetAtt Constants.CmsHostname
        FeederHostname: !GetAtt Constants.FeederHostname
        IdHostname: !GetAtt Constants.IdHostname
        MetricsHostname: !GetAtt Constants.MetricsHostname
        PlayHostname: !GetAtt Constants.PlayHostname
        SharedAuroraMysqlEndpoint: !Ref SharedAuroraMysqlEndpoint
        SharedAuroraMysqlPort: !Ref SharedAuroraMysqlPort
        SharedAuroraPostgresqlEndpoint: !Ref SharedAuroraPostgresqlEndpoint
        SharedAuroraPostgresqlPort: !Ref SharedAuroraPostgresqlPort
        SharedGlueDatabaseName: !GetAtt SharedGlueDatabaseStack.Outputs.SharedGlueDatabaseName
        AnnounceResourcePrefix: !GetAtt SharedAnnounceStack.Outputs.ResourcePrefix
        PorterJobExecutionSnsTopicArn: !Ref PorterJobExecutionSnsTopicArn

        # App-specific parameters

        BetaPrxOrgArchiveS3ObjectKey: !Ref BetaPrxOrgArchiveS3ObjectKey
        BetaPrxOrgCloudFrontOai: !Ref BetaPrxOrgCloudFrontOai

        CastleEcrImageTag: !Ref CastleEcrImageTag
        CastleSecretsVersion: !Ref CastleSecretsVersion
        CastleSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Castle, prefix]
        CastleRdsPostgresqlEndpoint: !Ref CastleRdsPostgresqlEndpoint
        CastlePostgresUsername: !Ref CastlePostgresUsername
        CastlePostgresUserPassword: !Ref CastlePostgresUserPassword

        DovetailCdnOriginRequestLambdaCodeS3ObjectKey: !Ref DovetailCdnOriginRequestCodeS3ObjectKey

        ExchangeEcrImageTag: !Ref ExchangeEcrImageTag
        ExchangeSecretsVersion: !Ref ExchangeSecretsVersion
        ExchangeSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Exchange, prefix]

        FeederEcrImageTag: !Ref FeederEcrImageTag
        FeederSecretsVersion: !Ref FeederSecretsVersion

        NetworksEcrImageTag: !Ref NetworksEcrImageTag
        NetworksSecretsVersion: !Ref NetworksSecretsVersion
        NetworksSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Networks, prefix]

        PublishEcrImageTag: !Ref PublishEcrImageTag
        PublishSecretsVersion: !Ref PublishSecretsVersion
        PublishSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Publish, prefix]

        RemixEcrImageTag: !Ref RemixEcrImageTag
        RemixSecretsVersion: !Ref RemixSecretsVersion
        RemixSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Remix, prefix]
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/apps-200A.yml
      TimeoutInMinutes: 40
  Apps300AStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        TemplateUrlPrefix: !Sub ${Constants.TemplateUrlBase}/stacks/apps
        CloudFormationNotificationArn: !GetAtt Constants.CloudFormationNotificationArn
        AlbFullName: !GetAtt SharedAlbStack.Outputs.AlbFullName
        AlbHttpsListenerArn: !GetAtt SharedAlbStack.Outputs.HttpsListenerArn
        EcsClusterArn: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterArn
        EcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName
        VpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        SecretsBase: !GetAtt Constants.SecretsBaseRegion
        NewRelicApiKeyPrxLite: !Ref NewRelicApiKeyPrxLite
        SecretsStackName: !Ref SecretsStackName
        EnvironmentType: !Ref EnvironmentType
        EnvironmentTypeAbbreviation: !FindInMap [EnvironmentTypeMap, !Ref EnvironmentType, abbreviation]
        RegionMode: !Ref RegionMode
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        VpcPublicSubnet1Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
        VpcPublicSubnet2Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
        VpcPublicSubnet3Id: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id
        VpcPrivateSubnet1Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
        VpcPrivateSubnet2Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
        VpcPrivateSubnet3Id: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id
        DeploymentPackageBucketName: !GetAtt Constants.DeploymentPackageBucketName
        EchoServiceToken: !GetAtt CustomResourcesStack.Outputs.EchoServiceToken
        CloudWatchAlarmTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchAlarmTaggerServiceToken
        CloudWatchLogGroupTaggerServiceToken: !GetAtt CustomResourcesStack.Outputs.CloudWatchLogGroupTaggerServiceToken
        SharedEcsAsgInstanceSecurityGroupId: !GetAtt SharedEcsAsgSecurityGroupStack.Outputs.InstanceSecurityGroupId
        SharedRedisReplicationGroupEndpointAddress: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointAddress
        SharedRedisReplicationGroupEndpointPort: !GetAtt SharedRedisStack.Outputs.ReplicationGroupEndpointPort
        SharedAuroraPostgresqlEndpoint: !Ref SharedAuroraPostgresqlEndpoint
        SharedAuroraPostgresqlPort: !Ref SharedAuroraPostgresqlPort
        CastlePostgresInstanceEndpointAddress: !GetAtt Apps200AStack.Outputs.CastlePostgresInstanceEndpointAddress
        CastlePostgresInstanceEndpointPort: !GetAtt Apps200AStack.Outputs.CastlePostgresInstanceEndpointPort
        CastleHostname: !GetAtt Constants.CastleHostname
        CorporateHostname: !GetAtt Constants.CorporateHostname
        ExchangeHostname: !GetAtt Constants.ExchangeHostname
        IdHostname: !GetAtt Constants.IdHostname
        AdFilesHostname: !GetAtt Constants.AdFilesHostname
        AuguryHostname: !GetAtt Constants.AuguryHostname
        FeederHostname: !GetAtt Constants.FeederHostname
        CmsHostname: !GetAtt Constants.CmsHostname
        DovetailCdnHostname: !GetAtt Constants.DovetailCdnHostname
        DovetailRouterHostname: !GetAtt Constants.DovetailRouterHostname
        SharedGlueDatabaseName: !GetAtt SharedGlueDatabaseStack.Outputs.SharedGlueDatabaseName

        # App-specific parameters

        AuguryEcrImageTag: !Ref AuguryEcrImageTag
        AugurySecretsVersion: !Ref AugurySecretsVersion
        AugurySharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Augury, prefix]

        DovetailAnalyticsLambdaCodeS3ObjectKey: !Ref AnalyticsIngestLambdaCodeS3ObjectKey

        DovetailRouterEcrImageTag: !Ref DovetailRouterEcrImageTag
        DovetailRouterSecretsVersion: !Ref DovetailrouterSecretsVersion

        MetricsEcrImageTag: !Ref MetricsEcrImageTag
        MetricsSecretsVersion: !Ref MetricsSecretsVersion
        MetricsSharedAlbListenerRulePriorityPrefix: !FindInMap [SharedAlbListenerRulePriorityMap, Metrics, prefix]

        ProxyLambdaCodeS3ObjectKey: !Ref ProxyPrxOrgCodeS3ObjectKey
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/apps-300A.yml
      TimeoutInMinutes: 40
  Apps400AStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        TemplateUrlPrefix: !Sub ${Constants.TemplateUrlBase}/stacks/apps
        CloudFormationNotificationArn: !GetAtt Constants.CloudFormationNotificationArn
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackId
        DeploymentPackageBucketName: !GetAtt Constants.DeploymentPackageBucketName
        S3StaticSiteDeployServiceToken: !GetAtt CustomResourcesStack.Outputs.S3StaticSiteDeployServiceToken

        # App-specific parameters

        BacksawArchiveS3ObjectKey: !Ref BacksawArchiveS3ObjectKey
        BacksawCloudFrontOai: !Ref BacksawCloudFrontOai
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/apps-400A.yml
      TimeoutInMinutes: 40

  ResourceGroupsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        RootStackName: !GetAtt Constants.RootStackName
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/resource-groups.yml
      TimeoutInMinutes: 10

  DashboardsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType

        RootStackName: !GetAtt Constants.RootStackName
        RootStackId: !GetAtt Constants.RootStackName

        InfrastructureGitCommit: !Ref InfrastructureGitCommit

        SharedEcsClusterName: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName

        SharedVpcId: !GetAtt SharedVpcStack.Outputs.VpcId
        SharedVpcCidrBlock: !GetAtt SharedVpcStack.Outputs.VpcCidrBlock

        SharedEcsAsgName: !GetAtt SharedEcsAsgStack.Outputs.AsgName

        SharedAlbName: !GetAtt SharedAlbStack.Outputs.AlbName
        SharedAlbFullName: !GetAtt SharedAlbStack.Outputs.AlbFullName
        SharedAlbVanityDomain: !GetAtt SharedAlbStack.Outputs.VanityAlbDomain

        SharedMemcachedCacheName: !GetAtt PrivateSharedMemcachedStack.Outputs.CacheName
        SharedRedisReplicationGroupName: !GetAtt SharedRedisStack.Outputs.ReplicationGroupName

        StackResourceGroupName: !GetAtt ResourceGroupsStack.Outputs.StackResourceGroupName
        StackLogGroupsGroupName: !GetAtt ResourceGroupsStack.Outputs.StackLogGroupsGroupName

        SharedVpcFlowLogsLogGroupName: !GetAtt SharedVpcStack.Outputs.FlowLogsLogGroupName

        AuguryTargetGroupFullName: !GetAtt Apps300AStack.Outputs.AuguryTargetGroupFullName

        BacksawDeployBucketRegionalDomainName: !GetAtt Apps400AStack.Outputs.BacksawDeployBucketRegionalDomainName

        BetaDeployBucketRegionalDomainName: !GetAtt Apps200AStack.Outputs.BetaDeployBucketRegionalDomainName

        CastlePostgresInstanceId: !GetAtt Apps200AStack.Outputs.CastlePostgresInstanceId
        CastleTargetGroupFullName: !GetAtt Apps200AStack.Outputs.CastleTargetGroupFullName

        CmsElasticsearchDomainName: !GetAtt Apps100AStack.Outputs.CmsElasticsearchDomainName
        CmsTargetGroupFullName: !GetAtt Apps100AStack.Outputs.CmsTargetGroupFullName

        DovetailAlbName: !GetAtt Apps300AStack.Outputs.DovetailAlbName
        DovetailAlbFullName: !GetAtt Apps300AStack.Outputs.DovetailAlbFullName
        DovetailVanityAlbDomain: !GetAtt Apps300AStack.Outputs.DovetailVanityAlbDomain
        DovetailTargetGroupFullName: !GetAtt Apps300AStack.Outputs.DovetailTargetGroupFullName

        FeederAlbName: !GetAtt Apps200AStack.Outputs.FeederAlbName
        FeederAlbFullName: !GetAtt Apps200AStack.Outputs.FeederAlbFullName
        FeederVanityAlbDomain: !GetAtt Apps200AStack.Outputs.FeederVanityAlbDomain
        FeederWebTargetGroupFullName: !GetAtt Apps200AStack.Outputs.FeederWebTargetGroupFullName

        IdTargetGroupFullName: !GetAtt Apps100AStack.Outputs.IdTargetGroupFullName

        IframelyTargetGroupFullName: !GetAtt Apps100AStack.Outputs.IframelyTargetGroupFullName

        MetricsTargetGroupFullName: !GetAtt Apps300AStack.Outputs.MetricsTargetGroupFullName

        NetworksPublicWebTargetGroupFullName: !GetAtt Apps200AStack.Outputs.NetworksPublicWebTargetGroupFullName

        PlayProxyTargetGroupFullName: !GetAtt Apps100AStack.Outputs.PlayProxyTargetGroupFullName
        PlayWebTargetGroupFullName: !GetAtt Apps100AStack.Outputs.PlayWebTargetGroupFullName

        ProxyApiDefaultEndpoint: !GetAtt Apps300AStack.Outputs.ProxyApiDefaultEndpoint
        ProxyApiId: !GetAtt Apps300AStack.Outputs.ProxyApiId

        PublishTargetGroupFullName: !GetAtt Apps200AStack.Outputs.PublishTargetGroupFullName

        RemixTargetGroupFullName: !GetAtt Apps200AStack.Outputs.RemixTargetGroupFullName

        TheWorldSearchApiId: !GetAtt Apps100AStack.Outputs.TheWorldSearchApiId
        TheWorldSearchApiEndpoint: !GetAtt Apps100AStack.Outputs.TheWorldSearchApiEndpoint
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/dashboards.yml
      TimeoutInMinutes: 10

  SharedGlueDatabaseStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      NotificationARNs:
        - !GetAtt Constants.CloudFormationNotificationArn
      Parameters:
        EnvironmentType: !Ref EnvironmentType
        RootStackName: !GetAtt Constants.RootStackName
      Tags:
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:cloudformation:root-stack-name, Value: !GetAtt Constants.RootStackName }
        - { Key: prx:cloudformation:root-stack-id, Value: !GetAtt Constants.RootStackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      TemplateURL: !Sub ${Constants.TemplateUrlBase}/stacks/shared-glue-database.yml
      TimeoutInMinutes: 10

Outputs:
  PipelineExecutionNonce:
    Value: !Ref PipelineExecutionNonce

  EnvironmentType:
    Value: !Ref EnvironmentType

  VPCCertificateArn:
    Description: The ARN for the wildcard certificate for the VPC
    Value: !GetAtt CertificateStack.Outputs.WildcardCertificateArn
  PlatformALBDNSName:
    Description: The DNS name for the platform application load balancer
    Value: !GetAtt LoadBalancersStack.Outputs.PlatformALBDNSName
  PlatformALBDualstackDNSName:
    Description: >
      The dualstack DNS name for the platform application load balancer
    Value: !GetAtt LoadBalancersStack.Outputs.PlatformALBDualstackDNSName

  SharedAlbVanityDomain:
    Description: >-
      The wildcard domain associated with the shared application load balancer
    Value: !GetAtt SharedAlbStack.Outputs.VanityAlbDomain

  SharedVpcId:
    Description: The resource ID for the shared VPC
    Value: !GetAtt SharedVpcStack.Outputs.VpcId

  SharedVpcPublicSubnet1Id:
    Description: The resource ID for public subnet 1
    Value: !GetAtt SharedVpcStack.Outputs.PublicSubnet1Id
  SharedVpcPublicSubnet2Id:
    Description: The resource ID for public subnet 2
    Value: !GetAtt SharedVpcStack.Outputs.PublicSubnet2Id
  SharedVpcPublicSubnet3Id:
    Description: The resource ID for public subnet 3
    Value: !GetAtt SharedVpcStack.Outputs.PublicSubnet3Id

  SharedVpcPrivateSubnet1Id:
    Description: The resource ID for private subnet 1
    Value: !GetAtt SharedVpcStack.Outputs.PrivateSubnet1Id
  SharedVpcPrivateSubnet2Id:
    Description: The resource ID for private subnet 2
    Value: !GetAtt SharedVpcStack.Outputs.PrivateSubnet2Id
  SharedVpcPrivateSubnet3Id:
    Description: The resource ID for private subnet 3
    Value: !GetAtt SharedVpcStack.Outputs.PrivateSubnet3Id

  SharedEcsClusterName:
    Value: !GetAtt SharedEcsClusterStack.Outputs.EcsClusterName

  SharedAuroraMysqlEndpoint:
    Value: !Ref SharedAuroraMysqlEndpoint
  SharedAuroraMysqlPort:
    Value: !Ref SharedAuroraMysqlPort

  SharedAuroraPostgresqlEndpoint:
    Value: !Ref SharedAuroraPostgresqlEndpoint
  SharedAuroraPostgresqlPort:
    Value: !Ref SharedAuroraPostgresqlPort

  FeederVanityAlbDomain:
    Value: !GetAtt Apps200AStack.Outputs.FeederVanityAlbDomain
  DovetailVanityAlbDomain:
    Value: !GetAtt Apps300AStack.Outputs.DovetailVanityAlbDomain

  TheWorldSearchApiEndpoint:
    Value: !GetAtt Apps100AStack.Outputs.TheWorldSearchApiEndpoint
