# stacks/container-apps/augury-alarms.yml
AWSTemplateFormatVersion: "2010-09-09"
Description: Augury alarms
Parameters:
  OpsWarnMessagesSnsTopicArn:
    Type: String
  OpsErrorMessagesSnsTopicArn:
    Type: String
  OpsFatalMessagesSnsTopicArn:
    Type: String
  EnvironmentType:
    Type: String
  EnvironmentTypeAbbreviation:
    Type: String
  AuguryWorkerLogGroupName:
    Type: String
  AuguryForecastLogGroupName:
    Type: String
Resources:
  ActualsIngestJobInvocationMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{ $.msg = "*Performed ImpressionsFetchJob*" }'
      LogGroupName: !Ref AuguryWorkerLogGroupName
      MetricTransformations:
        - MetricName: !Sub "ActualsIngestJobInvocationCount${EnvironmentType}"
          MetricNamespace: PRX/Augury
          MetricValue: "1"
  AuguryActualsAreBehindAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmName: !Sub "[Augury][Worker][ActiveJob] ${EnvironmentType} Augury actuals are behind"
      AlarmActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      InsufficientDataActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      OKActions:
        - !Ref OpsErrorMessagesSnsTopicArn
      AlarmDescription: Augury actuals are behind
      ComparisonOperator: LessThanThreshold
      EvaluationPeriods: 3
      MetricName: !Sub "ActualsIngestJobInvocationCount${EnvironmentType}"
      Namespace: PRX/Augury
      Period: 300
      Statistic: Sum
      Threshold: 1
      TreatMissingData: breaching
  ForecastDownloadsMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{ $.type = "downloads" }'
      LogGroupName: !Ref AuguryForecastLogGroupName
      MetricTransformations:
        - MetricName: !Sub "ForecastDownloadsElapsed${EnvironmentType}"
          MetricNamespace: PRX/Augury
          MetricValue: $.elapsed
  ForecastGeocountryMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{ $.type = "geocountry" }'
      LogGroupName: !Ref AuguryForecastLogGroupName
      MetricTransformations:
        - MetricName: !Sub "ForecastGeocountryElapsed${EnvironmentType}"
          MetricNamespace: PRX/Augury
          MetricValue: $.elapsed
  ForecastGeosubdivMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{ $.type = "geosubdiv" }'
      LogGroupName: !Ref AuguryForecastLogGroupName
      MetricTransformations:
        - MetricName: !Sub "ForecastGeosubdivElapsed${EnvironmentType}"
          MetricNamespace: PRX/Augury
          MetricValue: $.elapsed
  ForecastGeometroMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{ $.type = "geometro" }'
      LogGroupName: !Ref AuguryForecastLogGroupName
      MetricTransformations:
        - MetricName: !Sub "ForecastGeometroElapsed${EnvironmentType}"
          MetricNamespace: PRX/Augury
          MetricValue: $.elapsed
  ForecastZonesMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{ $.type = "zones" }'
      LogGroupName: !Ref AuguryForecastLogGroupName
      MetricTransformations:
        - MetricName: !Sub "ForecastZonesElapsed${EnvironmentType}"
          MetricNamespace: PRX/Augury
          MetricValue: $.elapsed
  ForecastOverallMetricFilter:
    Type: "AWS::Logs::MetricFilter"
    Properties:
      FilterPattern: '{ $.type = "overall" }'
      LogGroupName: !Ref AuguryForecastLogGroupName
      MetricTransformations:
        - MetricName: !Sub "ForecastOverallElapsed${EnvironmentType}"
          MetricNamespace: PRX/Augury
          MetricValue: $.elapsed
