# stacks/shared-vpc/interface-endpoints.yml
#
# This template creates a number of security groups that are intended to be
# used in other templates. They provide access to the various VPC Endpoints
# also defined in the template. These security groups (named *endpoint access
# security groups*) may provide access to a single endpoint (such as STS), or
# to a group of related endpoints (such as those required for launching ECS
# tasks). To make use of these security groups, a resource (like an EC2
# instance or a Lambda function) would be added one or more of the groups. For
# example, an EC2 instance that is added to the StsEndpointAccessSecurityGroup
# would be able to access the STS service.
#
# Endpoint access security groups are not directly associated with endpoints.
# Instead, endpoints are associated with *inbound access security groups*,
# which allow inbound traffic from endpoint access security groups. Endpoints
# may be associated with multiple inbound access groups. For example, the
# CloudWatch Logs endpoint is associated with a service-specific
# CloudWatchLogsEndpointInboundTrafficSecurityGroup as well as the
# multi-resource EcsLaunchEndpointsInboundTrafficSecurityGroup. In this way,
# some resources can be granted access strictly to CloudWatch Logs, and others
# can be granted to all ECS-related services, including CloudWatch Logs, with a
# single security group.
AWSTemplateFormatVersion: "2010-09-09"

Description: >-
  Creates various Interface VPC endpoints in the shared VPC. These are
  primarily intended to support access for instances and tasks in private
  networks, but are also utilized by instances and tasks in public networks by
  virtue of how the Endpoints function.

Parameters:
  NestedChangeSetScrubbingResourcesState: { Type: String }

Conditions:
  EnableNestedChangeSetScrubbingResources: !Equals [!Ref NestedChangeSetScrubbingResourcesState, Enabled]

# !!!! IMPORTANT !!!!
#
# When creating an interface endpoint with PrivateDnsEnabled enabled, ALL
# subnets in the VPC in the AZs of subnets listed on the Endpoint will start
# using private DNS for the endpoints in question.
#
# For example, if you add PrivateSubnet1 (us-east-1z) to the ECS endpoint, all
# other subnets in us-east-1z will resolve the ECS hostname to a private IP.
# Instances and tasks in PublicSubnet1 that could previously reach the ECS API
# over the public internet will start accessing it via the private IP via the
# Endpoint.
#
# Ensure that NACLs and security groups for any resources, in all subnets, that
# could be effected by a new VPC Endpoint are updated prior to establishing the
# Endpoint.

# https://docs.aws.amazon.com/vpc/latest/userguide/vpce-interface.html
Resources:
  NestedChangeSetScrubber: { Type: AWS::SNS::Topic, Condition: EnableNestedChangeSetScrubbingResources }
