AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Creates a CloudFront distribution to origin-pull from a Dovetail ALB.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterLabels:
      OriginDomain:
        default: Dovetail Origin ALB
      DistributionDomain:
        default: Domain Name
      CertificateArn:
        default: ACM Certificate Arn
Parameters:
  OriginDomain:
    Type: String
    Description: eg. dovetail.prxu.org, dovetail.staging.prxu.org
  DistributionDomain:
    Type: String
    Description: eg. dovetail-cdn.prxu.org
  CertificateArn:
    Type: String
    Description: eg. arn:aws:acm:<region>:<account>:certificate/<guid>
  InfrastructureNotificationsStackName:
    Default: infrastructure-notifications
    Description: The name of a previously launched notifications stack
    Type: String
Resources:
  CloudFrontDistribution:
    Type: "AWS::CloudFront::Distribution"
    Properties:
      DistributionConfig:
        Aliases:
          - !Ref DistributionDomain
        DefaultCacheBehavior:
          AllowedMethods: [HEAD, GET]
          CachedMethods: [HEAD, GET]
          Compress: false
          ForwardedValues:
            QueryString: false
          TargetOriginId: dovetail-alb
          ViewerProtocolPolicy : allow-all
        Enabled: true
        HttpVersion: http2
        IPV6Enabled: true
        Origins:
          - CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginKeepaliveTimeout: 5
              OriginProtocolPolicy: https-only
              OriginReadTimeout: 60
              OriginSSLProtocols:
                - TLSv1.2
                - TLSv1.1
                - TLSv1
            DomainName: !Ref OriginDomain
            Id: dovetail-alb
            OriginCustomHeaders:
              - HeaderName: Authorization
                HeaderValue: dovetail-cdn
            OriginPath: "/+"
        PriceClass: PriceClass_200
        ViewerCertificate:
          AcmCertificateArn: !Ref CertificateArn
          SslSupportMethod: sni-only
      Tags:
        - Key: Project
          Value: Dovetail
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
  CloudFrontDistribution500Alarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmName: "[Dovetail][CloudFront][ErrorRate] 5XX"
      AlarmActions:
        - Fn::ImportValue:
            !Sub "${InfrastructureNotificationsStackName}-OpsWarnMessagesSnsTopicArn"
      InsufficientDataActions:
        - Fn::ImportValue:
            !Sub "${InfrastructureNotificationsStackName}-OpsWarnMessagesSnsTopicArn"
      OKActions:
        - Fn::ImportValue:
            !Sub "${InfrastructureNotificationsStackName}-OpsWarnMessagesSnsTopicArn"
      AlarmDescription: >
        The error rate on the Dovetail stitch CDN is too dang high
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: Region
          Value: Global
        - Name: DistributionId
          Value: !Ref CloudFrontDistribution
      EvaluationPeriods: "1"
      MetricName: 5xxErrorRate
      Namespace: AWS/Lambda
      Period: "60"
      Statistic: Average
      Threshold: "0.001"
      TreatMissingData: notBreaching
      Unit: Percent
Outputs:
  CloadfrontDomainName:
    Value: !GetAtt CloudFrontDistribution.DomainName
