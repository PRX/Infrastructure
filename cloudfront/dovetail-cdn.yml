AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Creates a CloudFront distribution to origin-pull from a Dovetail ALB.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterLabels:
      OriginBucket:
        default: Origin S3 Bucket
      OriginPath:
        default: Origin S3 Path
      DistributionDomain:
        default: Domain Name
      CertificateArn:
        default: ACM Certificate Arn
Parameters:
  OriginBucket:
    Type: String
    Description: eg. prx-dovetail.s3.amazonaws.com
  OriginPath:
    Type: String
    Description: eg. /stitch-production, /stitch-staging
  DistributionDomain:
    Type: String
    Description: eg. dovetail-cdn.prxu.org
  CertificateArn:
    Type: String
    Description: eg. arn:aws:acm:<region>:<account>:certificate/<guid>
Resources:
  CloudFrontDistribution:
    Type: "AWS::CloudFront::Distribution"
    Properties:
      DistributionConfig:
        Aliases:
          - !Ref DistributionDomain
        DefaultCacheBehavior:
          AllowedMethods: [HEAD, GET]
          CachedMethods: [HEAD, GET]
          Compress: false
          ForwardedValues:
            QueryString: false
          # TODO: managing this manually for now
          # LambdaFunctionAssociations:
          #   - EventType: origin-request
          #     LambdaFunctionARN: arn:aws:lambda:<region>:<account>:function:<name>:<version>
          TargetOriginId: dovetail-stitch-s3
          ViewerProtocolPolicy : allow-all
        Enabled: true
        HttpVersion: http2
        IPV6Enabled: true
        Origins:
          - DomainName: !Ref OriginBucket
            Id: dovetail-stitch-s3
            OriginPath: !Ref OriginPath
            S3OriginConfig: {}
        PriceClass: PriceClass_200
        ViewerCertificate:
          AcmCertificateArn: !Ref CertificateArn
          SslSupportMethod: sni-only
      Tags:
        - Key: Project
          Value: Dovetail
        - Key: "prx:cloudformation:stack-name"
          Value: !Ref AWS::StackName
        - Key: "prx:cloudformation:stack-id"
          Value: !Ref AWS::StackId
Outputs:
  CloadfrontDomainName:
    Value: !GetAtt CloudFrontDistribution.DomainName
