# TODO Somehow the root stack needs to know where to look for nested (app) stack
# teplates. The templates need to be directly available somewhere (not in a
# zipped artifact or file).
# Current plan: the git SHA is available on the Infrastructure repo artifact
# when it gets passed to Lambda. The Lambda can write the SHA to a JSON file,
# zip that file, and return it as an output artifact. Then a CFN reference
# function can be used to extract that value and pass it as a parameter
# override to the pipeline actions that are updating the root stacks

# This creates a CodePipeline pipeline (and associates resources) for handling
# deployments and testing of the platform. It watches three sources for changes,
# which trigger the pipeline: the meta.prx.org repo (used for acceptance
# testing), the Infrastructure repo (for when apps are added or changed), and
# the S3 bucket that contains the template configuration for the root stack that
# the pipeline ultimately launches. The root stack uses a CloudFormation
# template that includes many nested stacks for the various apps and services
# that are a part of the platform.
# In order for the root stack to launch the nested stacks, the templates for
# those stacks must be available in S3. This pipeline copies the entire
# Infrastructure artifact to S3 (into a bucket defined by the
# InfrastructureCodeBucket parameter) for that purpose.
# This would be deployed in any region where you want to deploy the platform
AWSTemplateFormatVersion: "2010-09-09"
Description: >
  Creates CodePipeline to handle infrastructure testing and deploys
Parameters:
  NotificationsStackName:
    Type: String
  GitHubToken:
    Type: String
  InfrastructureCodeBucket:
    Type: String
  TemplateConfigBucket:
    Type: String
  TemplateConfigStagingKey:
    Type: String
  CapturedStatesBucket:
    Type: String
Resources:
  # S3 Buckets
  ArtifactStore:
    # The bucket used to store artifacts generated by CodePipeline actions.
    # This bucket is to be used exclusively by AWS; don't use it to store any
    # app, infrastructure, or user data.
    Type: "AWS::S3::Bucket"
    DeletionPolicy: Retain
    Properties:
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 14
            Status: Enabled
      Tags:
        - Key: Project
          Value: Infrastructure
  # SNS Topics
  CodePipelineApprovalsSnsTopic:
    Type: "AWS::SNS::Topic"
  # SNS Subscriptions
  CodePipelineApprovalsTopicRelayFunctionSubscription:
    Type: "AWS::SNS::Subscription"
    Properties:
      Endpoint:
        Fn::ImportValue:
          !Sub "${NotificationsStackName}-SnsOpsMessagesToSlackLambdaFunctionArn"
      Protocol: lambda
      TopicArn: !Ref CodePipelineApprovalsSnsTopic
  # Lambda Permssions for SNS
  CodePipelineApprovalsTopicInvokeRelayFunctionPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::ImportValue:
          !Sub "${NotificationsStackName}-SnsOpsMessagesToSlackLambdaFunctionName"
      Principal: sns.amazonaws.com
      SourceArn: !Ref CodePipelineApprovalsSnsTopic
  # IAM Roles
  LambdaExecutionIAMRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        - PolicyName: XrayTracePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "xray:PutTraceSegments"
                  - "xray:PutTelemetryRecords"
                Resource:
                  - "*"
        - PolicyName: S3Policy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:putObject"
                Resource:
                  - !Sub arn:aws:s3:::${CapturedStatesBucket}/*
                  - !Sub arn:aws:s3:::${InfrastructureCodeBucket}/*
              - Effect: Allow
                Action:
                  - "s3:putObject"
                  - "s3:getObject"
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactStore}/*
        - PolicyName: CodePipelinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "codepipeline:PutJobSuccessResult"
                  - "codepipeline:PutJobFailureResult"
                Resource: "*"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
  CodePipelineIAMRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        # CodePipeline seems to need access to special buckets
        - PolicyName: GenericCodePipelineS3PutPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:PutObject"
                Resource:
                  - "arn:aws:s3:::codepipeline*"
        # Let CodePipeline read and write artifacts
        - PolicyName: ArtifactStoreFullAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:Get*"
                  - "s3:Put*"
                  - "s3:List*"
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactStore}
                  - !Sub arn:aws:s3:::${ArtifactStore}/*
        # CodePipeline needs access to objects that are used in source actions
        - PolicyName: S3SourceActionAccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:GetBucketVersioning"
                Resource:
                  - !Sub arn:aws:s3:::${TemplateConfigBucket}
              - Effect: Allow
                Action:
                  - "s3:GetObject"
                  - "s3:GetObjectVersion"
                Resource:
                  - !Sub arn:aws:s3:::${TemplateConfigBucket}/${TemplateConfigStagingKey}
        # For Approval actions
        - PolicyName: SnsApprovalsPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "sns:Publish"
                Resource:
                  - !Ref CodePipelineApprovalsSnsTopic
        # Allow CodePipeline to manipulate CloudFormation root stacks
        - PolicyName: RootStackCloudFormationAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "iam:PassRole"
                Resource:
                  - !GetAtt CloudFormationIAMRole.Arn
              # Full access for staging stacks
              - Effect: Allow
                Action:
                  - "cloudformation:*"
                Resource:
                  - !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}-root-staging
                  - !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}-root-staging/*
              # Production stacks shouldn't get deleted
              - Effect: Allow
                Action:
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:CreateStack"
                  - "cloudformation:UpdateStack"
                  - "cloudformation:DescribeChangeSet"
                  - "cloudformation:CreateChangeSet"
                  - "cloudformation:ExecuteChangeSet"
                  - "cloudformation:DeleteChangeSet"
                Resource:
                  - !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}-root-production
                  - !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}-root-production/*
        # Allows CodePipeline to invoke Lambda function actions
        - PolicyName: LambdaRolePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "lambda:ListFunctions"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "lambda:InvokeFunction"
                Resource:
                  - !GetAtt InfrastructureRepoSourceS3SyncFuncton.Arn
                  - !GetAtt EnvironmentStateCaptureFunction.Arn
        # Lets CodePipeline start CodeBuild (for acceptance tests, etc)
        - PolicyName: CodeBuildPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "codebuild:BatchGetBuilds"
                  - "codebuild:StartBuild"
                Resource:
                  - !GetAtt AcceptanceTestBuildProject.Arn
                  - !Sub "${AcceptanceTestBuildProject.Arn}/*"
                Resource: "*"
  CodeBuildIAMRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        # Allow CodeBuild to log to CloudWatch
        - PolicyName: CodeBuildLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  # NOTE These need to stay in sync with the CodeBuild Project
                  # name from below
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${AWS::StackName}-Acceptance
                  - !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${AWS::StackName}-Acceptance:*
        # CodeBuild sources from CodePipeline artifacts, so it needs access
        - PolicyName: ArtifactStoreBasicAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:PutObject"
                  - "s3:GetObject"
                  - "s3:GetObjectVersion"
                Resource: !Sub arn:aws:s3:::${ArtifactStore}/*
  CloudFormationIAMRole:
    # This role gets passed to CloudFormation, and is used by CloudFormation to
    # to perform actions against other AWS resources.
    #
    # This is the role used to launch the root stack, and thus all nested app
    # and service stacks. It needs permissions to create any of the resources
    # that those stacks require. Eg, if a stack nested in the root stack
    # includes an S3 bucket resource, this role needs a policy that allows it
    # to create S3 buckets.
    # NOTE This role should not be given to anything other than the CodePipeline
    # CloudFormation actions! It's very powerful!
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: "/"
      # TODO This will need access to S3 buckets where Lambda code archives are
      # stored at some point
      Policies:
        # Nested stack templates are accessed through S3
        - PolicyName: TemplateBucketAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "s3:GetObject"
                Resource:
                  - !Sub arn:aws:s3:::${InfrastructureCodeBucket}/sync/Infrastructure*
        # Give CloudFormation full access except deleting stacks
        - PolicyName: StackManipulationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              #
              - Effect: Allow
                Action:
                  - "cloudformation:*"
                Resource:
                  - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}-root-staging/*"
                  - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}-root-production/*"
                  - !Sub "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:changeSet/*"
              - Effect: Deny
                Action:
                  - "cloudformation:DeleteStack"
                Resource: "*"
        # Need to CRUD all resources included in root and nested stacks
        # NOTE: THIS IS VERY POWERFUL
        - PolicyName: ResourceManipulationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Be very explicit with S3 policies; CloudFormation never deletes
              # S3 buckets anyway
              - Effect: Allow
                Action:
                  - s3:CreateBucket
                  - s3:PutLifecycleConfiguration
                Resource: "*"
              # Only include services that root stack or its nested stacks
              # actually use
              - Effect: Allow
                Action:
                  - "acm:*"
                  - "apigateway:*"
                  - "application-autoscaling:*"
                  - "autoscaling:*"
                  - "cloudwatch:*"
                  - "ec2:*"
                  - "ecs:*"
                  - "elasticloadbalancing:*"
                  - "iam:*"
                  - "lambda:*"
                  - "logs:*"
                  - "route53:*"
                  - "sns:*"
                Resource: "*"
  # Lambda Functions
  InfrastructureRepoSourceS3SyncFuncton:
    Type: "AWS::Lambda::Function"
    Properties:
      Code:
        S3Bucket: !Ref InfrastructureCodeBucket
        S3Key: cd/infrastructure-s3-sync.zip
      Description: Copies Infrastructure repo artifact to S3
      Environment:
        Variables:
          INFRASTRUCTURE_CODE_BUCKET: !Ref InfrastructureCodeBucket
      Handler: index.handler
      MemorySize: 128
      Role: !GetAtt LambdaExecutionIAMRole.Arn
      Runtime: nodejs6.10
      Tags:
        - Key: Project
          Value: Infrastructure
      Timeout: 3
  EnvironmentStateCaptureFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      Code:
        S3Bucket: !Ref InfrastructureCodeBucket
        S3Key: cd/environment-state-capture.zip
      Description: >
        Capture template and config version data for deployed environments
      Environment:
        Variables:
          CAPTURED_STATES_BUCKET: !Ref CapturedStatesBucket
      Handler: index.handler
      MemorySize: 128
      Role: !GetAtt LambdaExecutionIAMRole.Arn
      Runtime: nodejs6.10
      Tags:
        - Key: Project
          Value: Infrastructure
      Timeout: 3
  # Lambda Alarms
  SlackRelayErrorAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmName: Infrastructure S3 Sync Lambda Errors
      AlarmActions:
        - Fn::ImportValue:
            !Sub "${NotificationsStackName}-OpsWarnMessagesSnsTopicArn"
      InsufficientDataActions:
        - Fn::ImportValue:
            !Sub "${NotificationsStackName}-OpsWarnMessagesSnsTopicArn"
      OKActions:
        - Fn::ImportValue:
            !Sub "${NotificationsStackName}-OpsWarnMessagesSnsTopicArn"
      AlarmDescription: >
        The error rate on the S3 Sync lambda has exceeded 0 in
        the last minute.
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: "1"
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: "60"
      Statistic: Sum
      Threshold: "0"
      Dimensions:
        - Name: FunctionName
          Value: !Ref InfrastructureRepoSourceS3SyncFuncton
  StateCaptureErrorAlarm:
    Type: "AWS::CloudWatch::Alarm"
    Properties:
      ActionsEnabled: true
      AlarmName: CD State Capture Lambda Errors
      AlarmActions:
        - Fn::ImportValue:
            !Sub "${NotificationsStackName}-OpsDebugMessagesSnsTopicArn"
      InsufficientDataActions:
        - Fn::ImportValue:
            !Sub "${NotificationsStackName}-OpsDebugMessagesSnsTopicArn"
      OKActions:
        - Fn::ImportValue:
            !Sub "${NotificationsStackName}-OpsDebugMessagesSnsTopicArn"
      AlarmDescription: >
        The error rate on the state capture lambda has exceeded 0 in
        the last minute.
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: "1"
      MetricName: Errors
      Namespace: AWS/Lambda
      Period: "60"
      Statistic: Sum
      Threshold: "0"
      Dimensions:
        - Name: FunctionName
          Value: !Ref EnvironmentStateCaptureFunction
  # Pipelines
  Pipeline:
    Type: "AWS::CodePipeline::Pipeline"
    Properties:
      ArtifactStore:
        Location: !Ref ArtifactStore
        Type: S3
      RoleArn: !GetAtt CodePipelineIAMRole.Arn
      Stages:
        - Name: Source
          Actions:
            - Name: InfrastructureRepo
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: 1
              Configuration:
                Owner: PRX
                Repo: Infrastructure
                Branch: prx-ci
                OAuthToken: !Ref GitHubToken
              OutputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            - Name: MetaRepo
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: 1
              Configuration:
                Owner: PRX
                Repo: meta.prx.org
                Branch: master
                OAuthToken: !Ref GitHubToken
              OutputArtifacts:
                - Name: MetaRepoSourceArtifact
              RunOrder: 1
            - Name: S3
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: S3
                Version: 1
              Configuration:
                S3Bucket: !Ref TemplateConfigBucket
                S3ObjectKey: !Ref TemplateConfigStagingKey
              OutputArtifacts:
                - Name: TemplateConfigStagingZipArtifact
              RunOrder: 1
        - Name: Housekeeping
          Actions:
            - Name: InfrastructureSync
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Provider: Lambda
                Version: 1
              Configuration:
                FunctionName: !Ref InfrastructureRepoSourceS3SyncFuncton
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
              OutputArtifacts:
                - Name: RepoStateArtifact
              RunOrder: 1
        - Name: Staging
          Actions:
            - Name: StagingDeploy
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration:
                ActionMode: REPLACE_ON_FAILURE
                Capabilities: CAPABILITY_IAM
                ChangeSetName: !Sub ${AWS::StackName}RootStagingChangeSet
                RoleArn: !GetAtt CloudFormationIAMRole.Arn
                StackName: !Sub ${AWS::StackName}-root-staging
                 # TODO This should use the git commit hash from the artifact
                ParameterOverrides: !Sub |
                  {
                    "NotificationsStackName": "${NotificationsStackName}",
                    "InfrastructureCodeBucket": "${InfrastructureCodeBucket}",
                    "InfrastructureGitCommit": "latest",
                    "Foo": "Bar"
                  }
                TemplateConfiguration: TemplateConfigStagingZipArtifact::staging.json
                TemplatePath: InfrastructureRepoSourceArtifact::stacks/root.yml
              InputArtifacts:
                - Name: TemplateConfigStagingZipArtifact
                - Name: InfrastructureRepoSourceArtifact
                - Name: RepoStateArtifact
              RunOrder: 1
            - Name: CaptureStagingState
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Provider: Lambda
                Version: 1
              Configuration:
                FunctionName: !Ref EnvironmentStateCaptureFunction
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
                - Name: TemplateConfigStagingZipArtifact
              RunOrder: 2
        - Name: Testing
          Actions:
            - Name: Acceptance
              ActionTypeId:
                Category: Invoke
                Owner: AWS
                Provider: Lambda
                Version: 1
              Configuration:
                FunctionName: !Ref EnvironmentStateCaptureFunction
              InputArtifacts:
                - Name: InfrastructureRepoSourceArtifact
                - Name: TemplateConfigStagingZipArtifact
              RunOrder: 2
        # - Name: Testing
        #   Actions:
        #     - Name: Acceptance
        #       ActionTypeId:
        #         Category: Build
        #         Owner: AWS
        #         Provider: CodeBuild
        #         Version: 1
        #       Configuration:
        #         ProjectName: !Ref AcceptanceTestBuildProject
        #       InputArtifacts:
        #         - Name: MetaRepoSourceArtifact
        #       OutputArtifacts:
        #         - Name: AcceptanceTestArtifact
        #       RunOrder: 1
        - Name: Production
          Actions:
            - Name: CreateChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration:
                ActionMode: CHANGE_SET_REPLACE
                Capabilities: CAPABILITY_IAM
                ChangeSetName: !Sub ${AWS::StackName}RootProductionChangeSet
                ParameterOverrides: !Sub |
                  {
                    "NotificationsStackName": "${NotificationsStackName}",
                    "InfrastructureCodeBucket": "${InfrastructureCodeBucket}",
                    "InfrastructureGitCommit": "latest",
                    "Foo": "Bar"
                  }
                RoleArn: !GetAtt CloudFormationIAMRole.Arn
                StackName: !Sub ${AWS::StackName}-root-production
                TemplateConfiguration: TemplateConfigStagingZipArtifact::staging.json # TODO
                TemplatePath: InfrastructureRepoSourceArtifact::stacks/root.yml
              InputArtifacts:
                - Name: TemplateConfigStagingZipArtifact
                - Name: InfrastructureRepoSourceArtifact
              RunOrder: 1
            - Name: ApproveChangeSet
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Provider: Manual
                Version: 1
              Configuration:
                NotificationArn: !Ref CodePipelineApprovalsSnsTopic
                CustomData: "TODO Get info about the deploy (last commit, etc)"
              RunOrder: 2
            - Name: ExecuteChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration:
                ActionMode: CHANGE_SET_EXECUTE
                Capabilities: CAPABILITY_IAM
                ChangeSetName: !Sub ${AWS::StackName}RootProductionChangeSet
                RoleArn: !GetAtt CloudFormationIAMRole.Arn
                StackName: !Sub ${AWS::StackName}-root-production
              RunOrder: 3
  # CodeBuild Projects
  AcceptanceTestBuildProject:
    Type: "AWS::CodeBuild::Project"
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Description: Runs acceptance tests for PRX platform
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
          - Name: DOVETAIL_HOST
            Value: https://dovetail-staging.prxu.org
          - Name: DOVETAIL_PROD
            Value: https://dovetail.prxu.org
          - Name: DOVETAIL_PROD_HOST
            Value: dovetail.prxu.org
          - Name: FEEDER_HOST
            Value: feeder-staging.prx.tech
          - Name: PUBLISH_HOST
            Value: publish-staging.prx.tech
          - Name: PUBLISH_USER
            Value: test@test.com
          - Name: PUBLISH_PASS
            Value: test
        Image: aws/codebuild/ruby:2.3.1
        Type: LINUX_CONTAINER
      # If this Name changes, the CodeBuild role policy needs to change too
      Name: !Sub ${AWS::StackName}-Acceptance
      ServiceRole: !GetAtt CodeBuildIAMRole.Arn
      Source:
        Type: CODEPIPELINE
      Tags:
        - Key: Project
          Value: Infrastructure
      TimeoutInMinutes: 5
