# db/shared-apps-aurora-pg.yml
AWSTemplateFormatVersion: "2010-09-09"

Description: >-
  Creates a Aurora database cluster, in an existing VPC. The cluster can be
  added to an existing Aurora global cluster. If it's not being added to an
  existing global cluster, a new global cluster will be created using the
  database cluster as its source cluster.

# When creating a stack without a GlobalClusterIdentifier parameter defined,
# both the database cluster and global cluster will be created, and the
# database cluster will be used as the source cluster for the global cluster.
# This stack is considered the "source cluster stack".
#
# The source cluster will be the initial primary cluster for the global
# cluster, but may become a secondary cluster at any time, depending on
# operational needs and AWS region availability.
#
# Stacks created with a GlobalClusterIdentifier parameter will create database
# clusters which are added to an existing global cluster. These stacks are
# considered "auxiliary cluster stacks", and will create secondary clusters
# within the global cluster. A secondary cluster can be promoted to become
# a primary cluster at any time, depending on operational needs and AWS region
# availability.
#
# A database cluster having been created as part of a source or auxiliary is
# not an indication that the cluster is a primary or secondary cluster.
#
# While an Aurora global cluster is created through CloudFormation in a
# specific region, it is a global resource. If the creation region becomes
# unavailable, the global cluster entity is unaffected. There is no meaningful
# configuration on the global cluster.

Parameters:
  GlobalClusterIdentifier:
    Type: String
    Description: >-
      (optional) The global cluster identifier that this DB cluster will belong
      to. If this parameter is excluded, this will be treated as the primary
      cluser, and a new global cluster will be created.
  DbClusterMasterUsername:
    Type: String
    Description: >-
      This value is required for primary clusters, and ignored for secondary
      clusters
  DbClusterMasterUserPassword:
    Type: String
    Description: >-
      This value is required for primary clusters, and ignored for secondary
      clusters
  EnvironmentType:
    Type: String
    AllowedValues:
      - Staging
      - Production
  SharedVpcId:
    Type: AWS::EC2::VPC::Id
  Subnet1Id:
    Type: AWS::EC2::Subnet::Id
  Subnet2Id:
    Type: AWS::EC2::Subnet::Id
  Subnet3Id:
    Type: AWS::EC2::Subnet::Id
  InstanceSecurityGroupId:
    Description: >-
      The ID for a security group that EC2 instances which should have access
      to the database belong to
    Type: String

Conditions:
  IsProduction: !Equals [!Ref EnvironmentType, Production]
  IsAuxiliaryClusterStack: !Not [!Equals [!Ref GlobalClusterIdentifier, ""]]
  IsSourceClusterStack: !Not [Condition: IsAuxiliaryClusterStack]

Resources:
  GlobalCluster:
    Type: AWS::RDS::GlobalCluster
    Condition: IsSourceClusterStack
    Properties:
      DeletionProtection: true
      SourceDBClusterIdentifier: !Ref DbCluster

  DbCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      # BackupRetentionPeriod
      DBSubnetGroupName: !Ref DbSubnetGroup
      DeletionProtection: true
      # EnableCloudwatchLogsExports:
      #   - postgresql
      #   - upgrade
      Engine: aurora-postgresql
      EngineVersion: "12.4"
      GlobalClusterIdentifier: !If
        - IsAuxiliaryClusterStack
        - !Ref GlobalClusterIdentifier
        - !Ref AWS::NoValue
      MasterUsername: !If
        - IsSourceClusterStack
        - !Ref DbClusterMasterUsername
        - !Ref AWS::NoValue
      MasterUserPassword: !If
        - IsSourceClusterStack
        - !Ref DbClusterMasterUserPassword
        - !Ref AWS::NoValue
      # PreferredBackupWindow
      # PreferredMaintenanceWindow
      Tags:
        - { Key: Name, Value: !Sub "${AWS::StackName}_shared-pg-aurora" }
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      VpcSecurityGroupIds:
        - !Ref DbClusterSecurityGroup

  DbInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AllowMajorVersionUpgrade: false
      AutoMinorVersionUpgrade: true
      Engine: aurora-postgresql
      DBClusterIdentifier: !Ref DbCluster
      # DBParameterGroupName: default.aurora-mysql5.7
      # PubliclyAccessible: 'true'
      DBInstanceClass: db.r6g.large
      # EnablePerformanceInsights
      # MonitoringInterval
      # MonitoringRoleArn
      # PerformanceInsightsRetentionPeriod
      # PreferredMaintenanceWindow
      # PubliclyAccessible
      Tags:
        - { Key: Name, Value: !Sub "${AWS::StackName}_shared-pg-aurora" }
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }

  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: tktktk # TODO
      SubnetIds:
        - !Ref Subnet1Id
        - !Ref Subnet2Id
        - !Ref Subnet3Id
      Tags:
        - { Key: Name, Value: !Sub "${AWS::StackName}_shared-pg-aurora" }
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }

  DbClusterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub >-
        Primary security group for the shared ${EnvironmentType} Aurora
        Postgresql database
      Tags:
        - { Key: Name, Value: !Sub "${AWS::StackName}_shared-pg-aurora" }
        - { Key: prx:meta:tagging-version, Value: "2021-04-07" }
        - { Key: prx:cloudformation:stack-name, Value: !Ref AWS::StackName }
        - { Key: prx:cloudformation:stack-id, Value: !Ref AWS::StackId }
        - { Key: prx:ops:environment, Value: !Ref EnvironmentType }
        - { Key: prx:dev:application, Value: Common }
      VpcId: !Ref SharedVpcId
  DbClusterInstanceIngressIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      Description: >-
        Allows ingress traffic from the shared ALB ASG instance security group
      FromPort: 3306
      GroupId: !GetAtt DbClusterSecurityGroup.GroupId
      IpProtocol: tcp
      SourceSecurityGroupId: !Ref InstanceSecurityGroupId
      ToPort: 3306

Outputs:
  GlobalClusterIdentifier:
    Condition: IsSourceClusterStack
    Value: !Ref GlobalCluster
